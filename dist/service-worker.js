(()=>{"use strict";const e="app_config",t="active_interview",n="offscreen/offscreen.html",s="undefined"!=typeof chrome&&chrome.offscreen?[chrome.offscreen.Reason.USER_MEDIA,chrome.offscreen.Reason.AUDIO_PLAYBACK]:["USER_MEDIA","AUDIO_PLAYBACK"],r={OPENAI:{name:"OpenAI",baseUrl:"https://api.openai.com/v1",models:["gpt-4","gpt-4-turbo","gpt-3.5-turbo"],maxTokens:4096,rateLimits:{requestsPerMinute:60,tokensPerMinute:9e4,dailyLimit:1e6}},ANTHROPIC:{name:"Anthropic",baseUrl:"https://api.anthropic.com/v1",models:["claude-3-opus","claude-3-sonnet","claude-3-haiku"],maxTokens:4096,rateLimits:{requestsPerMinute:50,tokensPerMinute:4e4,dailyLimit:5e5}},GOOGLE:{name:"Google",baseUrl:"https://generativelanguage.googleapis.com/v1",models:["gemini-pro","gemini-pro-vision"],maxTokens:2048,rateLimits:{requestsPerMinute:60,tokensPerMinute:32e3,dailyLimit:1e6}}},o={version:"1.0.0",environment:"production",features:{enableTranscription:!0,enableAIResponses:!0,enableDocumentAnalysis:!0,enableVisualAnalysis:!0,enablePerformanceTracking:!0,enableDebugMode:!1},llmProviders:[{name:"OpenAI",apiKey:"",baseUrl:r.OPENAI.baseUrl,model:"gpt-4",maxTokens:2048,temperature:.7,isEnabled:!1,priority:1,rateLimits:r.OPENAI.rateLimits},{name:"Anthropic",apiKey:"",baseUrl:r.ANTHROPIC.baseUrl,model:"claude-3-sonnet",maxTokens:2048,temperature:.7,isEnabled:!1,priority:2,rateLimits:r.ANTHROPIC.rateLimits}],ui:{theme:"auto",language:"en",fontSize:"medium",animations:!0,notifications:!0},security:{encryptStorage:!0,validateInputs:!0,rateLimiting:!0,auditLogging:!0,csrfProtection:!0},performance:{enableMetrics:!0,sampleRate:.1,maxHistorySize:1e3,alertThresholds:{responseTime:5e3,errorRate:.05,memoryUsage:104857600}}},i="interview",a="meeting",c="presentation",l="training",u="professional",d="casual",m="formal",p="friendly",h={[i]:{name:"Interview",description:"One-on-one interview session",suggestedTone:u,features:["transcription","suggestions","document_analysis"]},[a]:{name:"Meeting",description:"Team meeting or group discussion",suggestedTone:u,features:["transcription","action_items","summary"]},[c]:{name:"Presentation",description:"Presentation or demo session",suggestedTone:m,features:["visual_analysis","audience_feedback"]},[l]:{name:"Training",description:"Training or educational session",suggestedTone:p,features:["knowledge_base","q_and_a"]}},g={[u]:{name:"Professional",description:"Formal business communication",style:"structured",vocabulary:"business"},[d]:{name:"Casual",description:"Relaxed conversational style",style:"informal",vocabulary:"everyday"},[m]:{name:"Formal",description:"Academic or official communication",style:"precise",vocabulary:"formal"},[p]:{name:"Friendly",description:"Warm and approachable communication",style:"conversational",vocabulary:"accessible"}},y=["pdf","docx","txt","md","doc","rtf"],f="resume",w="other",k={timeout:3e4,retryAttempts:3,retryDelay:1e3,enableLogging:!0};class v{config;handlers=new Map;pendingRequests=new Map;constructor(e={}){this.config={...k,...e},this.initializeMessageListener()}initializeMessageListener(){"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage?chrome.runtime.onMessage.addListener(((e,t,n)=>(this.handleIncomingMessage(e,t,n).catch((e=>{console.error("Error handling incoming message:",e),n({success:!1,error:e instanceof Error?e.message:"Unknown error"})})),!0))):console.warn("Chrome extension APIs not available in this environment")}async handleIncomingMessage(e,t,n){const{command:s}=e;this.config.enableLogging&&console.log(`[MessageBroker] Received command: ${s}`,e);const r=this.handlers.get(s);if(r)try{await r(e,t,n)}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error(`Error in handler for command ${s}:`,e),n({success:!1,error:t})}else n({success:!1,error:"Unknown command",details:`No handler registered for command: ${s}`})}registerHandler(e,t){this.handlers.has(e)&&console.warn(`[MessageBroker] Overwriting existing handler for command: ${e}`),this.handlers.set(e,t),this.config.enableLogging&&console.log(`[MessageBroker] Registered handler for command: ${e}`)}unregisterHandler(e){const t=this.handlers.delete(e);return this.config.enableLogging&&t&&console.log(`[MessageBroker] Unregistered handler for command: ${e}`),t}async sendMessage(e,t){const n={...e,requestId:this.generateRequestId(),timestamp:Date.now()};return this.config.enableLogging&&console.log("[MessageBroker] Sending message:",n),this.sendMessageWithRetry(n,t,0)}async sendMessageWithRetry(e,t,n){try{return await this.sendSingleMessage(e,t)}catch(s){if(n<this.config.retryAttempts)return this.config.enableLogging&&console.warn(`[MessageBroker] Retry attempt ${n+1} for message:`,e.command),await this.delay(this.config.retryDelay*(n+1)),this.sendMessageWithRetry(e,t,n+1);throw s}}async sendSingleMessage(e,t){return new Promise(((n,s)=>{const r=setTimeout((()=>{s(new Error(`Message timeout after ${this.config.timeout}ms`))}),this.config.timeout),o=e=>{clearTimeout(r),chrome.runtime.lastError?s(new Error(chrome.runtime.lastError.message)):e?n(e):s(new Error("No response received"))};try{if("undefined"==typeof chrome||!chrome.runtime)return clearTimeout(r),void s(new Error("Chrome extension APIs not available"));t?chrome.tabs.sendMessage(t,e,o):chrome.runtime.sendMessage(e,o)}catch(e){clearTimeout(r),s(e)}}))}async sendMessageToTab(e,t){return this.sendMessage(t,e)}async sendCommand(e,t){const n={command:e,data:t,timestamp:Date.now()};return this.sendMessage(n)}async sendMessageToServiceWorker(e){return this.sendMessage({...e,target:"service_worker"})}async sendMessageToContentScript(e,t){return this.sendMessageToTab(e,{...t,target:"content_script"})}async broadcastMessage(e){try{const t=(await chrome.tabs.query({})).filter((e=>void 0!==e.id)).map((t=>this.sendMessageToTab(t.id,e).catch((()=>null))));return(await Promise.all(t)).filter((e=>null!==e))}catch(e){return console.error("Error broadcasting message:",e),[]}}generateRequestId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}delay(e){return new Promise((t=>setTimeout(t,e)))}getRegisteredHandlers(){return Array.from(this.handlers.keys())}clearHandlers(){this.handlers.clear(),this.config.enableLogging&&console.log("[MessageBroker] All handlers cleared")}getStats(){return{handlersCount:this.handlers.size,pendingRequestsCount:this.pendingRequests.size}}}const T="candidai:preferences",C="candidai:resume",x="candidai:context";class b{encryptionConfig;cache;encryptionKey;isInitialized;constructor(){this.encryptionConfig={algorithm:"AES-GCM",keyLength:256,ivLength:12,saltLength:16,iterations:1e5},this.cache=new Map,this.encryptionKey=null,this.isInitialized=!1}async ensureEncryptionInitialized(){this.isInitialized||(await this.initializeEncryption(),this.isInitialized=!0)}async initializeEncryption(){try{const e=await this.getStoredKey();e?this.encryptionKey=e:(this.encryptionKey=await this.generateEncryptionKey(),await this.storeEncryptionKey(this.encryptionKey))}catch(e){console.error("Encryption initialization failed:",e),this.encryptionKey=null}}async generateEncryptionKey(){return await crypto.subtle.generateKey({name:"AES-GCM",length:this.encryptionConfig.keyLength},!0,["encrypt","decrypt"])}async storeEncryptionKey(e){try{const t={key:await crypto.subtle.exportKey("jwk",e),algorithm:this.encryptionConfig.algorithm,created:Date.now()};await chrome.storage.local.set({"candidai:encryptionKey":t})}catch(e){throw console.error("Failed to store encryption key:",e),e}}async getStoredKey(){try{const e=await chrome.storage.local.get("candidai:encryptionKey");if(!e["candidai:encryptionKey"])return null;const t=e["candidai:encryptionKey"];return await crypto.subtle.importKey("jwk",t.key,{name:this.encryptionConfig.algorithm,length:this.encryptionConfig.keyLength},!0,["encrypt","decrypt"])}catch(e){return console.error("Failed to retrieve encryption key:",e),null}}async set(e,t,n={}){try{await this.ensureEncryptionInitialized();const s=`${n.namespace||T}:${e}`,r=JSON.stringify(t);let o;o=this.encryptionKey&&!1!==n.encrypt?await this.encryptData(r):{encrypted:!1,data:r,timestamp:Date.now()},await chrome.storage.local.set({[s]:o}),this.cache.set(s,t)}catch(t){throw console.error("Storage operation failed:",t),new Error(`Failed to store data for key: ${e}`)}}async get(e,t={}){try{await this.ensureEncryptionInitialized();const n=`${t.namespace||T}:${e}`;if(this.cache.has(n))return this.cache.get(n);const s=(await chrome.storage.local.get(n))[n];if(!s)return null;if(t.ttl&&s.timestamp&&Date.now()-s.timestamp>t.ttl)return await this.remove(e,t),null;let r;if(s.encrypted&&this.encryptionKey){const e=await this.decryptData(s);r=JSON.parse(e)}else r=JSON.parse(s.data);return this.cache.set(n,r),r}catch(e){return console.error("Storage retrieval failed:",e),null}}async remove(e,t={}){try{const n=`${t.namespace||T}:${e}`;await chrome.storage.local.remove(n),this.cache.delete(n)}catch(t){throw console.error("Storage removal failed:",t),new Error(`Failed to remove data for key: ${e}`)}}async clear(){try{await chrome.storage.local.clear(),this.cache.clear()}catch(e){throw console.error("Storage clear failed:",e),e}}async getAllKeys(){try{const e=await chrome.storage.local.get();return Object.keys(e)}catch(e){return console.error("Failed to get all keys:",e),[]}}async encrypt(e){if(await this.ensureEncryptionInitialized(),!this.encryptionKey)throw new Error("Encryption key not available");const t=JSON.stringify(e),n=await this.encryptData(t);return JSON.stringify(n)}async decrypt(e){if(await this.ensureEncryptionInitialized(),!this.encryptionKey)throw new Error("Encryption key not available");const t=JSON.parse(e),n=await this.decryptData(t);return JSON.parse(n)}async encryptData(e){if(!this.encryptionKey)throw new Error("Encryption key not available");const t=crypto.getRandomValues(new Uint8Array(this.encryptionConfig.ivLength)),n=(new TextEncoder).encode(e),s=await crypto.subtle.encrypt({name:this.encryptionConfig.algorithm,iv:t},this.encryptionKey,n);return{encrypted:!0,data:this.arrayBufferToBase64(s),iv:this.arrayBufferToBase64(t),algorithm:this.encryptionConfig.algorithm,timestamp:Date.now()}}async decryptData(e){if(!this.encryptionKey)throw new Error("Encryption key not available");if(!e.iv)throw new Error("Missing IV for decryption");const t=this.base64ToArrayBuffer(e.data),n=this.base64ToArrayBuffer(e.iv),s=await crypto.subtle.decrypt({name:this.encryptionConfig.algorithm,iv:n},this.encryptionKey,t);return(new TextDecoder).decode(s)}async batchSet(e,t={}){const n=e.map((async e=>{const n={...t,...e.options};await this.set(e.key,e.value,n)}));await Promise.all(n)}async clearNamespace(e){try{const t=await chrome.storage.local.get(),n=Object.keys(t).filter((t=>t.startsWith(e)));n.length>0&&(await chrome.storage.local.remove(n),n.forEach((e=>this.cache.delete(e))))}catch(e){throw console.error("Failed to clear namespace:",e),e}}async getNamespaceKeys(e){try{const t=await chrome.storage.local.get();return Object.keys(t).filter((t=>t.startsWith(e))).map((t=>t.replace(`${e}:`,"")))}catch(e){return console.error("Failed to get namespace keys:",e),[]}}async initialize(e){try{await this.ensureEncryptionInitialized();for(const[t,n]of Object.entries(e))null===await this.get(t)&&await this.set(t,n)}catch(e){throw console.error("Storage initialization failed:",e),e}}async getState(){try{const e=await chrome.storage.local.get(),t={};for(const[n,s]of Object.entries(e))if(n.startsWith("candidai:")){const e=s;let r;r=e.encrypted&&this.encryptionKey?JSON.parse(await this.decryptData(e)):JSON.parse(e.data),t[n]=r}return t}catch(e){return console.error("Failed to get application state:",e),{}}}arrayBufferToBase64(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++){const s=t[e];void 0!==s&&(n+=String.fromCharCode(s))}return btoa(n)}base64ToArrayBuffer(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}clearCache(){this.cache.clear()}async getItem(e){return this.get(e)}async setItem(e,t){await this.set(e,t)}async removeItem(e){await this.remove(e)}async getMultiple(e){const t={};for(const n of e){const e=await this.get(n);null!==e&&(t[n]=e)}return t}async setMultiple(e){for(const[t,n]of Object.entries(e))await this.set(t,n)}async setEncrypted(e,t){const n=await this.encrypt(t);await this.set(e,n)}async getEncrypted(e){const t=await this.get(e);if(!t)return null;try{return await this.decrypt(t)}catch(e){return console.error("Failed to decrypt data:",e),null}}}class E{apiKey;config;baseURL;models;capabilities;rateLimits;requestHistory;tokenHistory;modelConfigs={};constructor(e,t={}){if(new.target===E)throw new Error("BaseLLMProvider is an abstract class and cannot be instantiated directly");this.apiKey=e,this.config=t,this.baseURL=t.baseURL||"",this.models=t.models||[],this.capabilities=t.capabilities||[],this.rateLimits={requestsPerMinute:60,tokensPerMinute:9e4,requestsPerDay:1e4},this.requestHistory=[],this.tokenHistory=[]}checkRateLimits(e=0){const t=Date.now(),n=t-6e4,s=t-864e5;if(this.requestHistory=this.requestHistory.filter((e=>e>s)),this.tokenHistory=this.tokenHistory.filter((e=>e.time>n)),this.requestHistory.filter((e=>e>n)).length>=this.rateLimits.requestsPerMinute)throw new Error("Rate limit exceeded: requests per minute");if(this.tokenHistory.filter((e=>e.time>n)).reduce(((e,t)=>e+t.tokens),0)+e>this.rateLimits.tokensPerMinute)throw new Error("Rate limit exceeded: tokens per minute");if(this.requestHistory.length>=this.rateLimits.requestsPerDay)throw new Error("Rate limit exceeded: daily request limit")}recordRequest(e){const t=Date.now();this.requestHistory.push(t),this.tokenHistory.push({time:t,tokens:e})}estimateTokens(e){return Math.ceil(e.length/4)}validateModel(e){if(!this.models.includes(e))throw new Error(`Model ${e} is not available for this provider`)}hasCapability(e){return this.capabilities.includes(e)}formatMessages(e){return e.map((e=>"string"==typeof e?{role:"user",content:e}:{role:e.role||"user",content:e.content||""}))}handleCommonErrors(e){const t=e.message?.toLowerCase()||"";if(t.includes("unauthorized")||t.includes("401"))throw new Error("Authentication failed. Please check your API key.");if(t.includes("rate limit")||t.includes("429"))throw new Error("Rate limit exceeded. Please try again later.");if(t.includes("timeout"))throw new Error("Request timed out. Please try again.");if(t.includes("network"))throw new Error("Network error. Please check your connection.");throw e}getModelConfig(e){return this.modelConfigs?.[e]||null}calculatePricing(e,t){return 0}getModels(){return Object.freeze([...this.models])}getCapabilities(){return Object.freeze([...this.capabilities])}}class P extends E{constructor(e,t={}){super(e,t),this.baseURL="https://api.openai.com/v1",this.models=t.models||["gpt-4-turbo-preview","gpt-4-vision-preview","gpt-3.5-turbo","gpt-3.5-turbo-16k"],this.modelConfigs={"gpt-4-turbo-preview":{maxTokens:128e3,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.01,costPer1kOutput:.03},"gpt-4-vision-preview":{maxTokens:128e3,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.01,costPer1kOutput:.03},"gpt-3.5-turbo":{maxTokens:4096,supportsVision:!1,supportsFunctions:!0,costPer1kInput:5e-4,costPer1kOutput:.0015},"gpt-3.5-turbo-16k":{maxTokens:16384,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.003,costPer1kOutput:.004}}}async generateCompletion(e){const{model:t="gpt-3.5-turbo",messages:n,systemMessage:s,temperature:r=.7,maxTokens:o=500,stream:i=!1,tools:a=null}=e,c=n?n.map((e=>({role:e.role||"user",content:e.content||""}))):[{role:"user",content:e.prompt||""}];if(!this.models.includes(t))throw new Error(`Model ${t} not available for OpenAI provider`);const l=[];s&&l.push({role:"system",content:s}),l.push(...c);const u={model:t,messages:l,temperature:r,max_tokens:o,stream:i};a&&this.modelConfigs[t]?.supportsFunctions&&(u.functions=a);try{const e=await this.makeRequest("/chat/completions",u);return i?{provider:"openai",model:t,isStream:!0,content:"",usage:{promptTokens:0,completionTokens:0,totalTokens:0},finishReason:"stop"}:this.formatResponse(e,t)}catch(e){throw this.handleError(e)}}async makeRequest(e,t,n=3){const s=`${this.baseURL}${e}`;for(let e=0;e<=n;e++)try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v1"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===n)throw t;const s=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(s)}throw new Error("Max retries exceeded")}formatResponse(e,t){const n=e.choices?.[0];if(!n)throw new Error("No choices in OpenAI response");return{content:n.message?.content||"",usage:{promptTokens:e.usage?.prompt_tokens||0,completionTokens:e.usage?.completion_tokens||0,totalTokens:e.usage?.total_tokens||0,model:e.model||t},model:e.model||t,finishReason:n.finish_reason||"stop",metadata:{id:e.id,created:e.created,object:e.object},provider:"openai",isStream:!1}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const n=new TextDecoder;let s="";for(;;){const{done:e,value:r}=await t.read();if(e)break;s+=n.decode(r,{stream:!0});const o=s.split("\n");s=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);e.choices[0].delta.content&&(yield{content:e.choices[0].delta.content,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const n=this.modelConfigs[t];return n?e.promptTokens/1e3*n.costPer1kInput+e.completionTokens/1e3*n.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({prompt:"Hello",context:{sessionId:"default",callType:"interview",tone:"professional",currentTopic:"general",conversationHistory:[],relevantDocuments:[],participants:[],meetingPhase:"discussion",participantContext:{}},maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("rate limit")?new Error("Rate limit exceeded. Please try again later."):t.includes("quota")?new Error("API quota exceeded"):t.includes("context length")?new Error("Message too long for model context window"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}async getConnectionTestResult(){try{return{success:!0,message:"Connection successful",model:(await this.generateCompletion({prompt:"Hello",context:{sessionId:"default",callType:"interview",tone:"professional",currentTopic:"general",conversationHistory:[],relevantDocuments:[],participants:[],meetingPhase:"discussion",participantContext:{}},maxTokens:10})).model}}catch(e){return{success:!1,message:e.message}}}}class S extends E{anthropicVersion;constructor(e,t={}){super(e,t),this.baseURL="https://api.anthropic.com/v1",this.models=t.models||["claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],this.modelConfigs={"claude-3-opus-20240229":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.015,costPer1kOutput:.075},"claude-3-sonnet-20240229":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.003,costPer1kOutput:.015},"claude-3-haiku-20240307":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:25e-5,costPer1kOutput:.00125}},this.anthropicVersion="2023-06-01"}async generateCompletion(e){const{model:t="claude-3-sonnet-20240229",messages:n,temperature:s=.7,maxTokens:r=500,stream:o=!1}=e,i="systemPrompt"in e?e.systemPrompt:void 0;if(!this.models.includes(t))throw new Error(`Model ${t} not available for Anthropic provider`);const a=Array.isArray(n)?n:[],c={model:t,messages:this.formatMessagesForClaude(a),max_tokens:r,temperature:s,stream:o};i&&(c.system=i);try{const e=await this.makeRequest("/messages",c);return o?{provider:"anthropic",model:t,isStream:!0,content:"",usage:{promptTokens:0,completionTokens:0,totalTokens:0},finishReason:"stop"}:this.formatResponse(e,t)}catch(e){throw this.handleError(e)}}formatMessagesForClaude(e){const t=[];e.forEach((e=>{const n=t[t.length-1];0===t.length||n&&n.role!==e.role?t.push({role:"system"===e.role?"user":e.role,content:e.content}):n&&(n.content+="\\n\\n"+e.content)}));const n=t[0];return t.length>0&&n&&"assistant"===n.role&&t.unshift({role:"user",content:"Continue the conversation."}),t}async makeRequest(e,t,n=3){const s=`${this.baseURL}${e}`;for(let e=0;e<=n;e++)try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":this.anthropicVersion},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===n)throw t;const s=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(s)}throw new Error("Max retries exceeded")}formatResponse(e,t){return{content:e.content?.[0]?.text||"",usage:{promptTokens:e.usage?.input_tokens||0,completionTokens:e.usage?.output_tokens||0,totalTokens:(e.usage?.input_tokens||0)+(e.usage?.output_tokens||0),model:e.model||t,estimatedCost:this.calculateCost(e.usage,t)},model:e.model||t,finishReason:e.stop_reason||"stop_sequence",metadata:{id:e.id,type:e.type,messageRole:e.role},provider:"anthropic"}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const n=new TextDecoder;let s="";for(;;){const{done:e,value:r}=await t.read();if(e)break;s+=n.decode(r,{stream:!0});const o=s.split("\\n");s=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);"content_block_delta"===e.type&&e.delta?.text&&(yield{content:e.delta.text,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const n=this.modelConfigs[t];return n?e.input_tokens/1e3*n.costPer1kInput+e.output_tokens/1e3*n.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({model:"claude-3-haiku-20240307",messages:[{role:"user",content:"Hello"}],maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("rate limit")?new Error("Rate limit exceeded. Please try again later."):t.includes("quota")?new Error("API quota exceeded"):t.includes("token")&&t.includes("limit")?new Error("Message too long for model context window"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}}class M extends E{defaultSafetySettings;constructor(e,t={}){super(e,t),this.baseURL="https://generativelanguage.googleapis.com/v1beta",this.models=t.models||["gemini-pro","gemini-pro-vision","gemini-ultra"],this.modelConfigs={"gemini-pro":{maxTokens:32768,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.0025,costPer1kOutput:.0025},"gemini-pro-vision":{maxTokens:32768,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.0025,costPer1kOutput:.0025},"gemini-ultra":{maxTokens:32768,supportsVision:!0,supportsFunctions:!0,costPer1kInput:.01875,costPer1kOutput:.01875}},this.defaultSafetySettings=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]}async generateCompletion(e){const{model:t="gemini-pro",messages:n,temperature:s=.7,maxTokens:r=500,stream:o=!1}=e,i="systemPrompt"in e?e.systemPrompt:void 0,a="functions"in e?e.functions:null;if(!this.models.includes(t))throw new Error(`Model ${t} not available for Gemini provider`);const c=Array.isArray(n)?n:[],l={contents:this.formatMessagesForGemini(c,i),generationConfig:{temperature:s,maxOutputTokens:r,candidateCount:1},safetySettings:this.defaultSafetySettings};a&&this.modelConfigs[t]?.supportsFunctions&&(l.tools=[{functionDeclarations:a}]);try{const e=o?`/models/${t}:streamGenerateContent`:`/models/${t}:generateContent`,n=await this.makeRequest(e,l);return o?{provider:"gemini",model:t,isStream:!0,content:"",usage:{promptTokens:0,completionTokens:0,totalTokens:0},finishReason:"stop"}:this.formatResponse(n,t)}catch(e){throw this.handleError(e)}}formatMessagesForGemini(e,t){const n=[];return t&&(n.push({role:"user",parts:[{text:`System: ${t}\n\nPlease follow these instructions in your responses.`}]}),n.push({role:"model",parts:[{text:"Understood. I will follow these instructions."}]})),e.forEach((e=>{const t="assistant"===e.role?"model":"user";if("string"==typeof e.content)n.push({role:t,parts:[{text:e.content}]});else if(Array.isArray(e.content)){const s=e.content.map((e=>"text"===e.type?{text:e.text}:"image"===e.type?{inlineData:{mimeType:e.mimeType||"image/jpeg",data:e.data}}:null)).filter(Boolean);n.push({role:t,parts:s})}})),n}async makeRequest(e,t,n=3){const s=`${this.baseURL}${e}?key=${this.apiKey}`;for(let e=0;e<=n;e++)try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===n)throw t;const s=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(s)}throw new Error("Max retries exceeded")}formatResponse(e,t){const n=e.candidates?.[0];if(!n)throw new Error("No candidates in Gemini response");return{content:n.content?.parts?.[0]?.text||"",usage:{promptTokens:e.usageMetadata?.promptTokenCount||0,completionTokens:e.usageMetadata?.candidatesTokenCount||0,totalTokens:e.usageMetadata?.totalTokenCount||0,model:t},model:t,finishReason:e.candidates?.[0]?.finishReason||"STOP",metadata:{safetyRatings:e.candidates?.[0]?.safetyRatings,messageRole:"assistant"},provider:"gemini"}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const n=new TextDecoder;let s="";for(;;){const{done:e,value:r}=await t.read();if(e)break;s+=n.decode(r,{stream:!0});const o=s.split("\n");s=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);e.candidates?.[0]?.content?.parts?.[0]?.text&&(yield{content:e.candidates[0].content.parts[0].text,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const n=this.modelConfigs[t];return n?e.promptTokens/1e3*n.costPer1kInput+e.completionTokens/1e3*n.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({model:"gemini-pro",messages:[{role:"user",content:"Hello"}],maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("quota")?new Error("API quota exceeded"):t.includes("safety")?new Error("Content blocked by safety filters"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}}const A=["JavaScript","TypeScript","Python","Java","C++","C#","Go","Rust","Swift","Kotlin","PHP","Ruby","Scala","Perl","R","MATLAB","Objective-C","Dart","Lua","Haskell","HTML","CSS","React","Angular","Vue.js","Node.js","Express","Django","Flask","Spring","Bootstrap","jQuery","SASS","SCSS","Webpack","Vite","Next.js","Nuxt.js","MySQL","PostgreSQL","MongoDB","Redis","SQLite","Oracle","SQL Server","DynamoDB","Cassandra","Neo4j","InfluxDB","Elasticsearch","Firebase","Supabase","AWS","Azure","GCP","Docker","Kubernetes","Jenkins","GitLab CI","GitHub Actions","Terraform","Ansible","Puppet","Chef","Vagrant","Nginx","Apache","Linux","Ubuntu","Git","SVN","JIRA","Confluence","Slack","Teams","Figma","Adobe XD","Sketch","IntelliJ","VSCode","Eclipse","Xcode","Android Studio","Postman","Insomnia","React Native","Flutter","Xamarin","Ionic","Cordova","iOS","Android","Swift UI","TensorFlow","PyTorch","Scikit-learn","Pandas","NumPy","Matplotlib","Seaborn","Jupyter","Apache Spark","Hadoop","Tableau","Power BI","D3.js","Plotly","Jest","Mocha","Jasmine","Cypress","Selenium","Playwright","JUnit","TestNG","PyTest","RSpec","PHPUnit","Karma","Protractor"],I=["Leadership","Team Management","Project Management","Communication","Problem Solving","Critical Thinking","Analytical Skills","Creativity","Innovation","Adaptability","Time Management","Organization","Collaboration","Mentoring","Training","Strategic Planning","Decision Making","Conflict Resolution","Negotiation","Public Speaking","Presentation Skills","Customer Service","Sales","Marketing"],D=["AWS Certified","Azure Certified","Google Cloud","PMP","Scrum Master","CISSP","CISA","CISM","CompTIA","Cisco","Microsoft Certified","Oracle Certified","Salesforce Certified","Six Sigma","ITIL","PMI","CPA","CFA","FRM"];class R{parseResume(e){const t=this.cleanText(e),n=this.extractContactInfo(t),s=this.extractSkills(t),r=this.extractExperience(t),o=this.extractEducation(t),i=this.extractSummary(t),a=this.calculateExtractionQuality(n,s,r,o,t);return{contact:n,skills:s,experience:r,education:o,summary:i,fullText:t,wordCount:t.split(/\s+/).length,extractionQuality:a}}cleanText(e){return e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/\s+/g," ").trim()}extractContactInfo(e){const t={},n=e.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g);n&&(t.email=n[0]);const s=e.match(/(?:\+?1[-.\s]?)?(?:\(?[0-9]{3}\)?[-.\s]?)?[0-9]{3}[-.\s]?[0-9]{4}/g);s&&(t.phone=s[0].replace(/\D+/g,"").replace(/^1/,""));const r=e.match(/(?:linkedin\.com\/in\/|linkedin\.com\/profile\/view\?id=)([a-zA-Z0-9\-]+)/i);r&&(t.linkedin=`https://linkedin.com/in/${r[1]}`);const o=e.match(/(?:github\.com\/|github:\/\/)([a-zA-Z0-9\-]+)/i);o&&(t.github=`https://github.com/${o[1]}`);const i=e.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9\-]+\.[a-zA-Z]{2,})/g);if(i){const e=i.filter((e=>!e.includes("linkedin.com")&&!e.includes("github.com")&&!e.includes("@")));e.length>0&&(t.website=e[0].startsWith("http")?e[0]:`https://${e[0]}`)}return t}extractSkills(e){const t=new Set,n=new Set,s=new Set,r=e.toLowerCase();return A.forEach((e=>{const n=e.toLowerCase();r.includes(n)&&t.add(e)})),I.forEach((e=>{const t=e.toLowerCase();r.includes(t)&&n.add(e)})),D.forEach((e=>{const t=e.toLowerCase();r.includes(t)&&s.add(e)})),this.extractSkillSections(e).forEach((e=>{e.split(/[,;|\n]+/).map((e=>e.trim())).filter((e=>e.length>1)).forEach((e=>{e.length>2&&e.length<30&&this.isTechnicalTerm(e)&&t.add(e)}))})),{technical:Array.from(t).sort(),soft:Array.from(n).sort(),certifications:Array.from(s).sort()}}extractSkillSections(e){const t=[],n=["skills","technical skills","core competencies","technologies","programming languages","software","tools","expertise"],s=e.split("\n");let r="",o=!1;for(let e=0;e<s.length;e++){const i=s[e].trim().toLowerCase();if(n.some((e=>i.includes(e)&&i.length<50)))r&&t.push(r),r="",o=!0;else{if(o&&i.length>0&&!i.includes(",")&&!i.includes("•")&&["experience","work history","employment","education","projects","achievements","awards","certifications"].some((e=>i.includes(e)))){r&&t.push(r),o=!1,r="";continue}o&&(r+=s[e]+"\n")}}return r&&t.push(r),t}isTechnicalTerm(e){return[/\.(js|ts|py|java|cpp|cs|go|rs|swift|kt|php|rb)$/i,/^[A-Z]{2,6}$/,/\d+\.\d+/,/[A-Z][a-z]+[A-Z]/].some((t=>t.test(e)))||e.includes(".")||e.includes("#")||e.includes("+")}extractExperience(e){const t=[];return this.extractSectionsByHeaders(e,["experience","work experience","professional experience","employment history","career history","work history"]).forEach((e=>{const n=this.parseExperienceSection(e);t.push(...n)})),t}parseExperienceSection(e){const t=[],n=e.split("\n").filter((e=>e.trim().length>0));let s=null;for(const e of n){const n=e.trim();if(this.looksLikeJobTitle(n))s&&s.company&&s.position&&t.push(s),s=this.parseJobTitleLine(n);else if(s){const e=this.extractDates(n);e.startDate||e.endDate?(s.startDate=e.startDate,s.endDate=e.endDate,s.duration=n):(s.description||(s.description=""),s.description+=n+"\n",(n.startsWith("•")||n.startsWith("-"))&&(s.responsibilities||(s.responsibilities=[]),s.responsibilities.push(n.substring(1).trim())))}}return s&&s.company&&s.position&&t.push(s),t}looksLikeJobTitle(e){return[/\b(developer|engineer|manager|analyst|specialist|coordinator|assistant|director|lead|senior|junior)\b/i,/\b(software|web|mobile|full.?stack|front.?end|back.?end|data|product|project)\b/i,/\bat\s+\w+/i,/\w+\s*[-–—]\s*\w+/].some((t=>t.test(e)))&&e.length<100}parseJobTitleLine(e){const t=[/^(.+?)\s+at\s+(.+)$/i,/^(.+?)\s*[-–—]\s*(.+)$/,/^(.+?),\s*(.+)$/];for(const n of t){const t=e.match(n);if(t){const[,e,n]=t;return e.length<n.length?{position:e.trim(),company:n.trim()}:{company:e.trim(),position:n.trim()}}}return{position:e.trim(),company:"Unknown"}}extractDates(e){const t=[/(\w+\s+\d{4})\s*[-–—]\s*(\w+\s+\d{4}|present|current)/i,/(\d{1,2}\/\d{4})\s*[-–—]\s*(\d{1,2}\/\d{4}|present|current)/i,/(\d{4})\s*[-–—]\s*(\d{4}|present|current)/i];for(const n of t){const t=e.match(n);if(t)return{startDate:t[1],endDate:"present"===t[2].toLowerCase()||"current"===t[2].toLowerCase()?"Present":t[2]}}return{}}extractEducation(e){const t=this.extractSectionsByHeaders(e,["education","academic background","qualifications"]),n=[];return t.forEach((e=>{const t=this.parseEducationSection(e);n.push(...t)})),n}parseEducationSection(e){const t=[],n=e.split("\n").filter((e=>e.trim().length>0));for(const e of n){const n=e.trim().match(/(bachelor|master|phd|doctorate|associate|certificate|diploma).+?(?:in|of)\s+(.+?)(?:from|at)\s+(.+)/i);n&&t.push({degree:n[1],field:n[2],institution:n[3]})}return t}extractSummary(e){const t=this.extractSectionsByHeaders(e,["summary","objective","profile","about","overview","professional summary","career objective"]);return t.length>0?t[0].substring(0,500):void 0}extractSectionsByHeaders(e,t){const n=[],s=e.split("\n");for(let e=0;e<s.length;e++){const r=s[e].trim().toLowerCase();if(t.some((e=>r.includes(e)&&r.length<50))){let t="",r=e+1;for(;r<s.length;){const e=s[r].trim().toLowerCase();if(["experience","education","skills","projects","achievements","awards","certifications","references"].some((t=>e.includes(t)&&e.length<50)))break;t+=s[r]+"\n",r++}t.trim().length>0&&n.push(t.trim())}}return n}calculateExtractionQuality(e,t,n,s,r){let o=0;e.email&&(o+=2),e.phone&&(o+=1),e.linkedin&&(o+=1),e.github&&(o+=1),o=Math.min(o,5);const i=t.technical.length+t.soft.length+t.certifications.length,a=Math.min(Math.round(i/5),5),c=Math.min(2*n.length,5);return{contact:o,skills:a,experience:c,overall:Math.round((o+a+c)/3)}}toDocumentContent(e,t){const n=[{id:crypto.randomUUID(),content:e.summary||"",startIndex:0,endIndex:e.summary?.length||0,metadata:{section:"summary"}},{id:crypto.randomUUID(),content:e.skills.technical.join(", "),startIndex:0,endIndex:e.skills.technical.join(", ").length,metadata:{section:"skills"}},{id:crypto.randomUUID(),content:e.experience.map((e=>`${e.position} at ${e.company}: ${e.description}`)).join("\n\n"),startIndex:0,endIndex:e.experience.map((e=>`${e.position} at ${e.company}: ${e.description}`)).join("\n\n").length,metadata:{section:"experience"}}],s=[...e.skills.technical.map((e=>({text:e,type:"skill",confidence:.9,startIndex:0,endIndex:e.length,context:"Technical skill"}))),...e.contact.email?[{text:e.contact.email,type:"person",confidence:.95,startIndex:0,endIndex:e.contact.email.length,context:"contact_info"}]:[],...e.contact.phone?[{text:e.contact.phone,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.phone.length,context:"contact_info"}]:[],...e.contact.linkedin?[{text:e.contact.linkedin,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.linkedin.length,context:"contact_info"}]:[],...e.contact.github?[{text:e.contact.github,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.github.length,context:"contact_info"}]:[],...e.contact.website?[{text:e.contact.website,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.website.length,context:"contact_info"}]:[]];return{id:t.id,text:e.fullText,chunks:n,entities:s,summary:e.summary||`Resume with ${e.skills.technical.length} technical skills and ${e.experience.length} work experiences`,keyPoints:[...e.skills.technical.slice(0,10),...e.experience.map((e=>`${e.position} at ${e.company}`)).slice(0,3)],keywords:e.skills.technical,structuredData:e,processedAt:new Date,metadata:{...t,extractionQuality:e.extractionQuality,wordCount:e.wordCount,contactInfo:e.contact,skillsCount:e.skills.technical.length+e.skills.soft.length}}}}const _="company",L="role",O="skill",z="technology",$="interviewer",U="project",N="metric";class F{storage;resumeParser;sessionContexts;entityPatterns;constructor(){this.storage=new b,this.resumeParser=new R,this.sessionContexts=new Map,this.entityPatterns=this.initializeEntityPatterns(),this.loadPersistedContext()}initializeEntityPatterns(){return{[_]:{patterns:[/(?:work(?:ed|ing)?\s+(?:at|for)|employed\s+by|join(?:ed|ing)?)\s+([A-Z][\w\s&]+)/gi,/(?:at|with)\s+([A-Z][\w\s&]+)\s+(?:Inc|LLC|Corp|Company|Limited|Ltd)/gi],keywords:["company","employer","organization","firm"]},[L]:{patterns:[/(?:position|role|title)(?:\s+is|\s+was|\s+of)?\s+([A-Z][\w\s]+(?:Engineer|Developer|Manager|Analyst|Designer))/gi,/(?:as|working\s+as)\s+(?:a|an)?\s+([A-Z][\w\s]+)/gi],keywords:["position","role","title","job"]},[O]:{patterns:[/(?:experience|proficient|skilled|expertise)\s+(?:in|with)\s+([\w\s,+#]+)/gi,/(?:using|know|familiar\s+with)\s+([\w\s,+#]+)/gi],keywords:["skill","expertise","proficiency","experience"]},[z]:{patterns:[/\b(React|Angular|Vue|Node\.?js|Python|Java|JavaScript|TypeScript|AWS|Azure|GCP|Docker|Kubernetes)\b/gi,/\b([A-Z][\w]+(?:\.js|DB|SQL))\b/g],keywords:["technology","framework","language","tool"]}}}async createSessionContext(e){const t=e.sessionId||crypto.randomUUID(),n=await this.storage.get("resumeData",{namespace:C}),s=await this.storage.get("jobDescriptions",{namespace:C}),r={sessionId:t,platform:e.platform||"unknown",startTime:Date.now(),resume:n,jobDescription:s?.[0],conversationHistory:[],detectedEntities:{[_]:new Set,[L]:new Set,[O]:new Set,[z]:new Set,[$]:new Set,[U]:new Set,[N]:new Set},keyTopics:[],questionCount:0,currentQuestion:null};return this.sessionContexts.set(t,r),await this.persistContext(t,r),r}async enrichContext(e){const t=e.sessionId,n=this.sessionContexts.get(t)||await this.createSessionContext(e),s={...n,...e,insights:{interviewDuration:Date.now()-n.startTime,averageResponseTime:this.calculateAverageResponseTime(n),topSkillsDiscussed:this.identifyTopSkills(n),matchScore:this.calculateJobMatchScore(n)}};return this.sessionContexts.set(t,s),s}async updateContext(e){const{sessionId:t,transcription:n,isQuestion:s,speaker:r}=e,o=this.sessionContexts.get(t);if(!o)return void console.error("Context not found for session:",t);const i=this.extractEntities(n);for(const[e,t]of Object.entries(i)){const n=o.detectedEntities[e];n&&t.forEach((e=>n.add(e)))}const a={timestamp:Date.now(),text:n,entities:i,keywords:this.extractKeywords(n),...r&&{speaker:r},...void 0!==s&&{isQuestion:s}};return o.conversationHistory.push(a),s&&(o.questionCount++,o.currentQuestion=n),this.updateKeyTopics(o,a.keywords),await this.persistContext(t,o),o}extractEntities(e){const t={};for(const[n,s]of Object.entries(this.entityPatterns))if(t[n]=new Set,s.patterns.forEach((s=>{const r=e.matchAll(s);for(const e of r)e[1]&&t[n]&&t[n].add(e[1].trim())})),s.keywords.some((t=>e.toLowerCase().includes(t)))){const r=e.split(/\s+/);r.forEach(((e,o)=>{if(s.keywords.includes(e.toLowerCase())&&o<r.length-1){let e="";for(let t=o+1;t<Math.min(o+4,r.length);t++){const n=r[t];if(!n||!n[0]||n[0]!==n[0].toUpperCase())break;e+=n+" "}e.trim()&&t[n]&&t[n].add(e.trim())}}))}const n={};for(const[e,s]of Object.entries(t))n[e]=Array.from(s);return n}extractKeywords(e){const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","been","have","has","had","do","does","did","will","would","could","should","may","might","must","can","could","this","that","these","those","i","you","he","she","it","we","they","what","which"]),n=e.toLowerCase().split(/\W+/).filter((e=>e.length>2&&!t.has(e))),s={};return n.forEach((e=>{s[e]=(s[e]||0)+1})),Object.entries(s).sort(((e,t)=>t[1]-e[1])).slice(0,5).map((([e])=>e))}updateKeyTopics(e,t){t.forEach((t=>{const n=e.keyTopics.find((e=>e.keyword===t));n?(n.frequency++,n.lastMentioned=Date.now()):e.keyTopics.push({keyword:t,frequency:1,firstMentioned:Date.now(),lastMentioned:Date.now()})})),e.keyTopics.sort(((e,t)=>t.frequency-e.frequency)),e.keyTopics=e.keyTopics.slice(0,10)}calculateAverageResponseTime(e){const t=[],n=[];if(e.conversationHistory.forEach((e=>{e.isQuestion?t.push(e.timestamp):n.push(e.timestamp)})),0===t.length||0===n.length)return 0;let s=0,r=0;for(let e=0;e<t.length;e++){const o=t[e];if(void 0!==o){const e=n.find((e=>e>o));e&&(s+=e-o,r++)}}return r>0?s/r:0}identifyTopSkills(e){const t=e.detectedEntities[O],n=e.detectedEntities[z];return[...t?Array.from(t):[],...n?Array.from(n):[]].slice(0,5)}calculateJobMatchScore(e){if(!e.resume||!e.jobDescription)return 0;const t=new Set(e.resume.structured?.skills||[]),n=new Set(e.jobDescription.requirements||[]),s=e.detectedEntities[O];let r=0,o=0;n.forEach((e=>{t.has(e)&&r++,s&&s.has(e)&&o++}));const i=n.size>0?r/n.size:0,a=n.size>0?o/n.size*.2:0;return Math.min(i+a,1)}async persistContext(e,t){const n={...t,detectedEntities:{}};for(const[e,s]of Object.entries(t.detectedEntities))n.detectedEntities[e]=Array.from(s);await this.storage.set(`context_${e}`,n,{namespace:x})}async loadPersistedContext(){const e=await this.storage.getNamespaceKeys(x);for(const t of e){const e=t.split(":")[1];if(e){const t=await this.storage.get(e,{namespace:x});if(t&&t.sessionId){for(const[e,n]of Object.entries(t.detectedEntities))Array.isArray(n)&&(t.detectedEntities[e]=new Set(n));this.sessionContexts.set(t.sessionId,t)}}}}}class j{storage;resumeParser;processingQueue=new Map;activeProcessing=new Set;documentCache=new Map;MAX_QUEUE_SIZE=10;RETRY_LIMIT=3;CACHE_EXPIRY=864e5;constructor(){this.storage=new b,this.resumeParser=new R,this.initializeDocumentProcessing()}async uploadDocuments(e,t,n){const s=[],r=[];if((await this.getSessionDocuments(n)).length+e.length>10)return{success:!1,uploaded:[],errors:["Maximum 10 documents allowed per session"]};for(const n of Array.from(e))try{const e=this.validateDocument(n);if(!e.valid){r.push(`${n.name}: ${e.error}`);continue}const o=await this.createDocumentMetadata(n,t);await this.queueDocumentProcessing(n,o),s.push(o)}catch(e){r.push(`${n.name}: ${e instanceof Error?e.message:"Unknown error"}`)}return{success:s.length>0,uploaded:s,errors:r}}validateDocument(e){if(e.size>10485760)return{valid:!1,error:`File size ${(e.size/1024/1024).toFixed(1)}MB exceeds limit of 10MB`};const t=e.name.split(".").pop()?.toLowerCase();return t&&y.includes(t)?e.name.length>255?{valid:!1,error:"File name too long (max 255 characters)"}:{valid:!0}:{valid:!1,error:`Unsupported format. Supported: ${y.join(", ")}`}}async createDocumentMetadata(e,t){const n=this.generateDocumentId(),s=this.detectDocumentType(e.name,t),r=this.calculateDocumentPriority(s,t);return{id:n,name:e.name,type:s,size:e.size,format:e.type||"application/octet-stream",uploadDate:new Date,lastModified:new Date(e.lastModified),priority:r,tags:this.generateTags(e.name,s),checksum:await this.calculateChecksum(e)}}async getActiveDocuments(){const e=[];for(const t of this.documentCache.values())e.push(t);return e}async queueDocumentProcessing(e,t){if(this.processingQueue.size>=this.MAX_QUEUE_SIZE)throw new Error("Processing queue is full. Please wait for current documents to finish processing.");const n={id:t.id,file:e,metadata:t,priority:t.priority,retryCount:0};this.processingQueue.set(t.id,n),this.activeProcessing.size<3&&this.processNextInQueue()}async processNextInQueue(){if(0===this.processingQueue.size||this.activeProcessing.size>=3)return;const e=Array.from(this.processingQueue.values()),t=[5,3,2,1,0];let n;for(const s of t)if(n=e.find((e=>e.priority===s)),n)break;if(n){this.processingQueue.delete(n.id),this.activeProcessing.add(n.id);try{await this.processDocument(n)}finally{this.activeProcessing.delete(n.id),this.processNextInQueue()}}}async processDocument(e){const t=Date.now();try{const n=await this.extractTextContent(e.file),s=await this.parseStructuredData(n,e.metadata.type,e.file),r=this.createDocumentChunks(n),o=await this.extractEntities(n),i=await this.generateSummary(n,e.metadata.type),a=await this.extractKeyPoints(n,e.metadata.type),c={id:e.metadata.id,text:n,metadata:e.metadata,chunks:r,entities:o,keywords:[],summary:i,keyPoints:a,structuredData:s,processedAt:new Date};return await this.storeDocument(e.metadata,c),this.documentCache.set(e.metadata.id,c),{success:!0,document:c,processingTime:Date.now()-t}}catch(n){if(console.error(`Document processing failed for ${e.metadata.name}:`,n),e.retryCount<this.RETRY_LIMIT){const n={...e,retryCount:e.retryCount+1};return this.processingQueue.set(e.id,n),{success:!1,error:`Processing failed, retrying (${e.retryCount+1}/${this.RETRY_LIMIT})`,processingTime:Date.now()-t}}return{success:!1,error:n instanceof Error?n.message:"Unknown processing error",processingTime:Date.now()-t}}}async extractTextContent(e){const t=e.name.split(".").pop()?.toLowerCase();switch(t){case"txt":case"md":return await e.text();case"pdf":return await this.extractPdfText(e);case"docx":case"doc":return await this.extractDocxText(e);case"pptx":case"ppt":return await this.extractPptText(e);case"xlsx":case"xls":return await this.extractExcelText(e);default:throw new Error(`Unsupported file format: ${t}`)}}async extractPdfText(e){try{return`[PDF Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract PDF text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractDocxText(e){try{return`[DOCX Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract DOCX text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractPptText(e){try{return`[PowerPoint Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract PowerPoint text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractExcelText(e){try{return`[Excel Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract Excel text: ${e instanceof Error?e.message:"Unknown error"}`)}}async findRelevantDocuments(e,t,n=3){const s=await this.getSessionDocuments(e.currentTopic),r=h[t],o=[];for(const n of s){const s=await this.getDocumentContent(n.id);if(!s)continue;const i=this.calculateRelevanceScore(s,e,t,r);if(i>.3){const n=this.findMatchingChunks(s,e.currentTopic);o.push({document:s,relevanceScore:i,matchingChunks:n,reason:this.generateRelevanceReason(s,e,t)})}}return o.sort(((e,t)=>t.relevanceScore-e.relevanceScore)).slice(0,n)}calculateRelevanceScore(e,t,n,s){let r=0;const o=this.getDocumentMetadataFromCache(e.id);return o&&s.documentRelevance[o.type]&&(r+=.4*this.getPriorityWeight(s.documentRelevance[o.type])),r+=.3*this.calculateTopicSimilarity(e,t.currentTopic),r+=.3*this.calculateEntityOverlap(e,t.conversationHistory),Math.min(r,1)}detectDocumentType(e,t){const n=e.toLowerCase(),s=e.toLowerCase();return n.includes("resume")||n.includes("cv")?f:n.includes("portfolio")||n.includes("work")||n.includes("project")?"portfolio":n.includes("presentation")||n.includes("slide")||n.includes("deck")||n.includes("proposal")||n.includes("bid")||n.includes("case")&&n.includes("study")||n.includes("pricing")||n.includes("quote")||n.includes("estimate")?w:n.includes("reference")||n.includes("recommendation")?s.includes("present")||s.includes("slide")?w:f:n.includes("cover")&&n.includes("letter")?"cover_letter":w}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}calculateDocumentPriority(e,t){return e===f&&"interview"===t?3:2}generateTags(e,t){const n=[t];return e.toLowerCase().includes("senior")&&n.push("senior"),e.toLowerCase().includes("junior")&&n.push("junior"),e.toLowerCase().includes("lead")&&n.push("lead"),e.toLowerCase().includes("manager")&&n.push("manager"),n}async calculateChecksum(e){const t=await e.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}initializeDocumentProcessing(){setInterval((()=>{this.cleanupExpiredCache()}),36e5)}async getSessionDocuments(e){return[]}cleanupExpiredCache(){}createDocumentChunks(e){return[]}async extractEntities(e){return[]}async generateSummary(e,t){return""}async extractKeyPoints(e,t){return[]}async parseStructuredData(e,t,n){return{}}getPriorityWeight(e){return.5}calculateTopicSimilarity(e,t){return.5}calculateEntityOverlap(e,t){return.5}findMatchingChunks(e,t){return[]}generateRelevanceReason(e,t,n){return""}async getDocumentContent(e){}async storeDocument(e,t){try{await this.storage.set(`document_${e.id}`,{metadata:e,content:t})}catch(e){throw console.error("Failed to store document:",e),e}}getDocumentMetadataFromCache(e){const t=this.documentCache.get(e);return t?.metadata}}class q{providers=new Map;contextManager;documentManager;storage;providerPerformance=new Map;PROVIDER_TIMEOUT=3e4;MAX_RETRIES=2;FALLBACK_CHAIN=["openai","anthropic","gemini"];constructor(){this.contextManager=new F,this.documentManager=new j,this.storage=new b,this.initializeProviders(),this.loadProviderPerformance()}async generateMeetingResponse(e,t,n){try{const s=await this.documentManager.findRelevantDocuments(n,t.callType,3),r=await this.buildContextualPrompt(e,t,n,s.map((e=>e.document))),o=await this.selectOptimalGeneration(r,t.callType,t.tone),i=await this.generateWithFallback(o),a=await this.optimizeResponse(i,t,s.map((e=>e.document)));return await this.updateProviderPerformance(o.provider.name,!0,Date.now()),a}catch(n){return console.error("Meeting response generation failed:",n),this.generateFallbackResponse(e,t.callType,t.tone)}}async generateSuggestions(e,t,n,s=3){const r=[];try{const o=await this.analyzeConversation(e),i=this.determineSuggestionTypes(t,e.meetingPhase,o);for(const o of i.slice(0,s)){const s=await this.generateTypedSuggestion(o,e,t,n);s&&r.push(s)}return r}catch(e){return console.error("Suggestion generation failed:",e),[]}}async buildContextualPrompt(e,t,n,s){const r=h[t.callType],o=g[t.tone],i=s&&s.length>0?this.buildDocumentContext([...s],t.callType):"",a=this.buildConversationContext(n.conversationHistory.slice(-10));return`\n${this.buildMeetingInstructions(t,r,o)}\n\nCURRENT MEETING CONTEXT:\n- Call Type: ${t.callType}\n- Tone: ${t.tone}\n- Meeting Phase: ${n.meetingPhase}\n- Participants: ${t.participants.length}\n- Current Topic: ${n.currentTopic}\n\n${i}\n\n${a}\n\nUSER INPUT: "${e}"\n\nPlease provide a response that:\n1. Matches the ${t.tone} tone\n2. Is appropriate for a ${t.callType}\n3. Considers the current meeting phase (${n.meetingPhase})\n4. References relevant information from the provided documents when helpful\n5. Maintains professional standards while being engaging\n\nResponse:`}buildDocumentContext(e,t){if(!e.length)return"";let n="\n=== Relevant Documents ===\n";return e.forEach(((e,s)=>{n+=`\nDocument ${s+1}: ${e.metadata.name}\nSummary: ${e.summary}\nKey Points: ${e.keyPoints?.slice(0,5).join(", ")||"No key points available"}\n`,t===i&&e.structuredData?.personalInfo?n+=`Background: ${JSON.stringify(e.structuredData.personalInfo,null,2)}\n`:t.includes("sales")&&e.structuredData?.pricing&&(n+=`Pricing Info: ${JSON.stringify(e.structuredData.pricing,null,2)}\n`)})),n}buildConversationContext(e){if(0===e.length)return"";let t="\nRECENT CONVERSATION:\n";return e.forEach(((e,n)=>{t+=`${e.speaker}: ${e.content}\n`})),t}buildMeetingInstructions(e,t,n){return`You are an AI meeting assistant specialized in ${e.callType} scenarios.\n\nCALL TYPE FOCUS (${e.callType}):\n- Focus Areas: ${t.focusAreas.join(", ")}\n- Response Style: ${t.responseStyle}\n- Priority Level: ${t.priority}\n\nTONE REQUIREMENTS (${e.tone}):\n- Vocabulary: ${n.vocabulary}\n- Sentiment: ${n.sentiment}\n- Structure: ${n.structure}\n- Key Phrases to Use: ${n.phrases.join(", ")}`}async selectOptimalGeneration(e,t,n){const s=this.calculatePromptComplexity(e),r=await this.scoreProviders(t,n,s),o=this.selectBestProvider(r),i=this.determineOptimalParameters(t,n,s);return{prompt:e,provider:o,model:this.selectOptimalModel(o,t),parameters:i}}async scoreProviders(e,t,n){const s=new Map;for(const[r,o]of this.providers){let i=0;i+=this.getProviderCapabilityScore(o,e,t);const a=this.providerPerformance.get(r);a&&(i+=.3*a.successRate,i+=1/Math.max(a.averageLatency,1)*.2,i+=1/Math.max(a.cost,.001)*.1),i+=this.getComplexityScore(o,n),s.set(r,i)}return s}determineOptimalParameters(e,t,n){const s={temperature:.7,maxTokens:500,presencePenalty:0,frequencyPenalty:0,topP:.9,stopSequences:[]};switch(e){case i:s.temperature=.5,s.maxTokens=300;break;case"sales_pitch":s.temperature=.8,s.maxTokens=600;break;case"brainstorming":s.temperature=.9,s.maxTokens=400}switch(t){case m:s.temperature*=.8;break;case d:s.temperature*=1.1;break;case"creative":s.temperature*=1.2}return n>.7&&(s.maxTokens=Math.min(1.5*s.maxTokens,1e3)),s}async generateWithFallback(e){const t={prompt:e.prompt,context:{},callType:"client_meeting",tone:u,temperature:e.parameters.temperature,maxTokens:e.parameters.maxTokens,model:e.model,sessionId:"session_"+Date.now()};try{const n=await Promise.race([e.provider.generateCompletion(t),this.createTimeoutPromise(this.PROVIDER_TIMEOUT)]);if(n&&n.content)return n}catch(t){console.warn(`Primary provider ${e.provider.name} failed:`,t)}for(const n of this.FALLBACK_CHAIN){if(n===e.provider.name)continue;const s=this.providers.get(n);if(s)try{const e=await Promise.race([s.generateCompletion(t),this.createTimeoutPromise(this.PROVIDER_TIMEOUT)]);if(e&&e.content)return console.log(`Fallback provider ${n} succeeded`),e}catch(e){console.warn(`Fallback provider ${n} failed:`,e)}}throw new Error("All providers failed to generate response")}async optimizeResponse(e,t,n){const s=e.content||e.text||"",r=this.extractSupportingPoints(s,n),o=this.generateFollowUpQuestions(s,t.callType,t.tone);return{content:s,tone:t.tone,confidence:this.calculateResponseConfidence(e),relevantDocuments:n.map((e=>({id:e.id,name:e.metadata.name,type:e.metadata.format,size:e.metadata.size,uploadedAt:e.metadata.uploadDate,content:e.text,summary:e.summary,keywords:e.keywords}))),supportingPoints:[...r],followUpQuestions:[...o],metadata:{callType:t.callType,responseType:"answer",priority:3,timing:"immediate",formality:this.mapToneToFormality(t.tone),length:s.length>200?"detailed":"brief"}}}initializeProviders(){const e={name:"openai",apiKey:"dummy-key",model:"gpt-4",maxTokens:4096,temperature:.7,isEnabled:!0,priority:1,rateLimits:{requestsPerMinute:60,tokensPerMinute:9e4,dailyLimit:1e6},generateCompletion:async e=>new P("dummy-key").generateCompletion(e)},t={name:"anthropic",apiKey:"dummy-key",model:"claude-3-sonnet",maxTokens:4096,temperature:.7,isEnabled:!0,priority:2,rateLimits:{requestsPerMinute:60,tokensPerMinute:1e5,dailyLimit:1e6},generateCompletion:async e=>new S("dummy-key").generateCompletion(e)},n={name:"gemini",apiKey:"dummy-key",model:"gemini-pro",maxTokens:4096,temperature:.7,isEnabled:!0,priority:3,rateLimits:{requestsPerMinute:60,tokensPerMinute:32e3,dailyLimit:1e6},generateCompletion:async e=>new M("dummy-key").generateCompletion(e)};this.providers.set("openai",e),this.providers.set("anthropic",t),this.providers.set("gemini",n)}async loadProviderPerformance(){try{const e=await this.storage.getItem("candidai:performance:provider_performance");e&&Object.entries(e).forEach((([e,t])=>{this.providerPerformance.set(e,t)}))}catch(e){console.warn("Failed to load provider performance:",e)}}calculatePromptComplexity(e){return.5}getProviderCapabilityScore(e,t,n){return.7}getComplexityScore(e,t){return.6}selectBestProvider(e){const t=Array.from(e.entries()).reduce(((e,t)=>e[1]>t[1]?e:t))[0];return this.providers.get(t)||this.providers.values().next().value}selectOptimalModel(e,t){return(e.getModels?.()||[])[0]||"default"}createTimeoutPromise(e){return new Promise(((t,n)=>setTimeout((()=>n(new Error("Timeout"))),e)))}calculateResponseConfidence(e){return.8}extractSupportingPoints(e,t){return[]}generateFollowUpQuestions(e,t,n){return[]}mapToneToFormality(e){switch(e){case m:return"formal";case d:return"casual";case p:return"friendly";default:return"professional"}}async updateProviderPerformance(e,t,n){}generateFallbackResponse(e,t,n){return{content:"I'm processing your request. Please give me a moment.",tone:n,confidence:.5,relevantDocuments:[],supportingPoints:[],followUpQuestions:[],metadata:{callType:t,responseType:"answer",priority:2,timing:"immediate",formality:"formal",length:"brief"}}}async analyzeConversation(e){return{}}determineSuggestionTypes(e,t,n){return[]}async generateTypedSuggestion(e,t,n,s){}}class K{metricsConfig;interviews;aggregateStats;measurements;completedMeasurements;eventLog;errorLog;config;constructor(){this.metricsConfig={speechMetrics:{fillerWords:["um","uh","like","you know","basically","actually","literally"],pacingThresholds:{slow:120,optimal:150,fast:180}},responseMetrics:{optimalLength:{min:30,max:120},starMethodKeywords:["situation","task","action","result"]},engagementMetrics:{questionResponseTime:5e3,followUpIndicators:["elaborate","example","specifically","detail"]}},this.interviews=new Map,this.aggregateStats={totalInterviews:0,averageScore:0,improvementTrend:[],commonWeaknesses:new Map,strongAreas:new Map},this.measurements=new Map,this.completedMeasurements=new Map,this.eventLog=[],this.errorLog=[],this.config={enableRemoteLogging:!1,remoteLoggingEndpoint:"",sampleRate:1},this.loadPersistedData()}startInterview(e,t){const n=t||crypto.randomUUID(),s={id:n,startTime:Date.now(),endTime:null,metadata:{company:e.company||"Unknown",position:e.position||"Unknown",platform:e.platform||"Unknown",...e},transcription:[],questions:[],responses:[],suggestions:[],metrics:null,score:null,insights:null};return this.interviews.set(n,s),n}addTranscription(e,t){const n=this.interviews.get(e);if(!n)return;const s={...t,timestamp:"object"==typeof t.timestamp&&t.timestamp instanceof Date?t.timestamp:new Date(t.timestamp||Date.now())};n.transcription.push(s),t.isQuestion&&n.questions.push({text:t.text,timestamp:"object"==typeof t.timestamp&&t.timestamp instanceof Date?t.timestamp.getTime():t.timestamp||Date.now(),type:this.categorizeQuestion(t.text)})}addSuggestion(e,t){const n=this.interviews.get(e);if(!n)return;const s={...t,timestamp:new Date(Date.now()),wasUsed:!1};n.suggestions.push(s)}async completeInterview(e){const t=this.interviews.get(e);return t?(t.endTime=Date.now(),t.duration=t.endTime-t.startTime,t.metrics=await this.calculateMetrics(t),t.score=this.calculateOverallScore(t.metrics),t.insights=this.generateInsights(t),this.updateAggregateStats(t),await this.persistInterview(t),{sessionId:e,startTime:new Date(t.startTime),duration:t.duration||0,metrics:{responseTime:t.metrics?.engagement.averageResponseTime||0,accuracy:t.metrics?.technical.accuracy||0,relevanceScore:t.metrics?.content.relevance||0,documentsProcessed:0,suggestionsProvided:t.suggestions.length,successfulInteractions:t.suggestions.filter((e=>e.wasUsed)).length},events:this.eventLog,interviews:[],generatedAt:new Date}):null}async calculateMetrics(e){return{speech:this.analyzeSpeechPatterns(e),content:this.analyzeResponseContent(e),engagement:this.analyzeEngagement(e),technical:this.analyzeTechnicalAccuracy(e),timing:this.analyzeTimingMetrics(e)}}analyzeSpeechPatterns(e){const t=e.transcription.filter((e=>!e.isQuestion)),n=t.reduce(((e,t)=>e+t.text.split(" ").length),0);let s=0;const r=new Map;t.forEach((e=>{e.text.toLowerCase().split(/\s+/).forEach((e=>{this.metricsConfig.speechMetrics.fillerWords.includes(e)&&(s++,r.set(e,(r.get(e)||0)+1))}))}));const o=n>0?s/n*100:0,i=t.reduce(((e,t)=>e+("object"==typeof t.timestamp&&t.timestamp instanceof Date?t.timestamp.getTime():t.timestamp||0)),0),a=i>0?n/i*6e4:0;return{fillerCount:s,fillerRate:o,fillerUsage:r,averagePace:a,paceRating:this.ratePace(a),clarity:Math.max(0,100-2*o),confidence:this.calculateConfidenceScore(t)}}analyzeResponseContent(e){const t=e.transcription.filter((e=>!e.isQuestion)),n=t.map((e=>e.text)).join(" ").toLowerCase(),s=this.metricsConfig.responseMetrics.starMethodKeywords.reduce(((e,t)=>e+(n.includes(t)?1:0)),0),r=["for example","for instance","such as","like when"].reduce(((e,t)=>e+(n.includes(t)?1:0)),0);return{starMethodUsage:s/this.metricsConfig.responseMetrics.starMethodKeywords.length*100,responseQuality:this.calculateResponseQuality(t),relevance:this.calculateRelevance(e),specificity:this.calculateSpecificity(t),examples:r}}analyzeEngagement(e){const t=e.transcription.filter((e=>!e.isQuestion)),n=e.questions;let s=0,r=0;for(let e=0;e<n.length&&e<t.length;e++){const o=t[e],i=n[e];if(o&&i){const e=("object"==typeof o.timestamp&&o.timestamp instanceof Date?o.timestamp.getTime():o.timestamp||Date.now())-i.timestamp;s+=e,e>this.metricsConfig.engagementMetrics.questionResponseTime&&r++}}return{averageResponseTime:n.length>0?s/n.length:0,hesitationCount:r,followUpQuestions:this.countFollowUpQuestions(e),activeListening:this.calculateActiveListening(e)}}analyzeTechnicalAccuracy(e){return{accuracy:75,depth:70,terminology:80,problemSolving:65}}analyzeTimingMetrics(e){const t=e.duration||0,n=e.questions.reduce(((e,t)=>e+5e3),0),s=t-n;return{totalDuration:t,questionTime:n,responseTime:s,silenceTime:0,balance:s>0?n/s*100:0,averageResponseTime:s>0?n/s*100:0}}calculateOverallScore(e){return(e.speech.clarity+(100-e.speech.fillerRate))/2*.25+(e.content.responseQuality+e.content.starMethodUsage)/2*.35+.25*Math.max(0,100-10*e.engagement.hesitationCount)+(e.technical.accuracy+e.technical.depth+e.technical.terminology)/3*.15}generateInsights(e){const t=[],n=e.metrics;return n?(n.speech.fillerRate>5&&t.push({type:"weakness",category:"speech",title:"Excessive Filler Words",description:`You used ${n.speech.fillerCount} filler words (${n.speech.fillerRate.toFixed(1)}% of total words). Try to pause instead of using fillers.`,score:100-n.speech.fillerRate,priority:"high",actionable:!0,examples:Array.from(n.speech.fillerUsage.keys()).slice(0,3)}),n.content.starMethodUsage<50&&t.push({type:"improvement",category:"content",title:"STAR Method Usage",description:"Consider using the STAR method (Situation, Task, Action, Result) to structure your behavioral responses.",score:n.content.starMethodUsage,priority:"medium",actionable:!0}),n.engagement.hesitationCount>2&&t.push({type:"weakness",category:"engagement",title:"Response Hesitation",description:`You hesitated before responding ${n.engagement.hesitationCount} times. Practice common interview questions to improve response speed.`,score:Math.max(0,100-20*n.engagement.hesitationCount),priority:"medium",actionable:!0}),t):t}generateReport(e){return{summary:{overallScore:e.score,duration:this.formatDuration(e.duration||0),questionsAnswered:e.questions.length,suggestionsProvided:e.suggestions.length},metrics:e.metrics,insights:e.insights,recommendations:this.generateRecommendations(e)}}generateRecommendations(e){const t=[],n=e.metrics;return n?(n.speech.fillerRate>3&&t.push("Practice speaking more slowly and pause instead of using filler words"),n.content.starMethodUsage<75&&t.push("Structure behavioral responses using the STAR method"),n.engagement.averageResponseTime>8e3&&t.push("Practice common interview questions to reduce response time"),t):t}categorizeQuestion(e){const t=e.toLowerCase();return t.includes("tell me about")||t.includes("describe a time")?"behavioral":t.includes("how would you")||t.includes("what would you do")?"situational":t.includes("culture")||t.includes("team")||t.includes("values")?"cultural":t.includes("technical")||t.includes("code")||t.includes("algorithm")?"technical":"other"}ratePace(e){const t=this.metricsConfig.speechMetrics.pacingThresholds;return e<t.slow?"slow":e>t.fast?"fast":"optimal"}calculateConfidenceScore(e){const t=e.reduce(((e,t)=>e+(t.confidence||0)),0)/e.length,n=e.reduce(((e,t)=>e+t.text.length),0)/e.length;return Math.min(100,100*t+n/50)}calculateResponseQuality(e){const t=e.reduce(((e,t)=>e+t.text.length),0)/e.length;return Math.min(100,t/100*100)}calculateRelevance(e){return 80}calculateSpecificity(e){const t=e.map((e=>e.text)).join(" ").match(/\b\d+\b|[A-Z][a-z]+\s[A-Z][a-z]+|\$\d+|%/g)||[];return Math.min(100,t.length/e.length*20)}countFollowUpQuestions(e){return e.questions.map((e=>e.text.toLowerCase())).filter((e=>this.metricsConfig.engagementMetrics.followUpIndicators.some((t=>e.includes(t))))).length}calculateActiveListening(e){return 75}updateAggregateStats(e){if(this.aggregateStats.totalInterviews++,null!==e.score){const t=(this.aggregateStats.averageScore*(this.aggregateStats.totalInterviews-1)+e.score)/this.aggregateStats.totalInterviews;this.aggregateStats.averageScore=t,this.aggregateStats.improvementTrend.push(e.score)}}formatDuration(e){return`${Math.floor(e/6e4)}m ${Math.floor(e%6e4/1e3)}s`}async persistInterview(e){try{const t=(await chrome.storage.local.get("interview_history")).interview_history||[];t.push({id:e.id,date:new Date(e.startTime).toISOString(),score:e.score,insights:e.insights?.length||0,company:e.metadata.company,position:e.metadata.position}),await chrome.storage.local.set({interview_history:t})}catch(e){console.error("Failed to persist interview:",e)}}async loadPersistedData(){try{const e=await chrome.storage.local.get(["interview_history","aggregate_stats"]);e.aggregate_stats&&Object.assign(this.aggregateStats,e.aggregate_stats)}catch(e){console.error("Failed to load persisted data:",e)}}startMeasurement(e){const t={name:e,startTime:performance.now()};this.measurements.set(e,t)}endMeasurement(e){const t=this.measurements.get(e);if(!t)return null;const n=performance.now(),s={...t,endTime:n,duration:n-t.startTime};return this.measurements.delete(e),this.completedMeasurements.set(e,s),s}getMeasurement(e){return this.completedMeasurements.get(e)||null}isMeasuring(e){return this.measurements.has(e)}logEvent(e,t={}){if(Math.random()>this.config.sampleRate)return;const n={name:e,type:"info",timestamp:Date.now(),data:t};this.eventLog.push(n),this.eventLog.length>1e3&&this.eventLog.splice(0,100)}logError(e,t,n={}){const s={name:e,message:t.message,stack:t.stack,timestamp:Date.now(),context:n};this.errorLog.push(s),this.errorLog.length>100&&this.errorLog.splice(0,10)}getEventLog(){return[...this.eventLog]}getErrorLog(){return[...this.errorLog]}clearLogs(){this.eventLog.length=0,this.errorLog.length=0,this.completedMeasurements.clear()}}new class{messageBroker;storage;llmOrchestrator;contextManager;performanceAnalyzer;activeInterviews=new Map;offscreenDocuments=new Map;sidePanelStates=new Map;sidePanelPorts=new Map;config=null;constructor(){this.messageBroker=new v,this.storage=new b,this.llmOrchestrator=new q,this.contextManager=new F,this.performanceAnalyzer=new K,this.initialize().catch((e=>{console.error("ServiceWorkerOrchestrator initialization failed:",e)}))}async initialize(){try{this.initializeEventHandlers(),this.performanceAnalyzer.startMeasurement("sw_initialization")}catch(e){console.error("Event handler initialization failed:",e)}try{await this.initializeOffscreenCapabilities()}catch(e){console.error("Offscreen capabilities initialization failed:",e)}try{await this.loadConfiguration()}catch(e){console.error("Configuration loading failed:",e)}if(this.performanceAnalyzer.isMeasuring("sw_initialization")){this.performanceAnalyzer.endMeasurement("sw_initialization");const e=this.performanceAnalyzer.getMeasurement("sw_initialization");e&&console.log(`Service Worker Initialization Time: ${e.duration}ms`)}}async loadConfiguration(){try{const t=await this.storage.get(e);this.config=t??o,console.log("Configuration loaded:",this.config),this.performanceAnalyzer.logEvent("configuration_loaded",{hasStoredConfig:Boolean(t)})}catch(e){console.error("Failed to load configuration, using defaults:",e),this.config=o,this.performanceAnalyzer.logError("configuration_load_failed",e)}}initializeEventHandlers(){chrome.runtime.onInstalled.addListener(this.handleInstallation.bind(this)),chrome.runtime.onStartup.addListener(this.handleStartup.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.runtime.onConnect.addListener(this.handleConnection.bind(this)),chrome.action.onClicked.addListener(this.handleActionClick.bind(this)),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch((e=>{console.error("Side panel configuration failed:",e)}))}async handleInstallation(t){console.log("CandidAI Extension installed:",t),await this.storage.initialize({[e]:o}),"install"===t.reason&&chrome.runtime.openOptionsPage()}async handleStartup(){console.log("CandidAI Service Worker starting up");try{const e=await this.storage.getState();e?.[t]&&await this.resumeInterviewSession(e[t]),this.performanceAnalyzer.logEvent("service_worker_startup_success")}catch(e){console.error("State restoration failed during startup:",e),this.performanceAnalyzer.logError("service_worker_startup_failure",e)}}async handleMessage(e,t,n){try{const{command:t,payload:s={}}=e;let r=null;switch(t){case"START_AUDIO_CAPTURE":r=await this.startAudioCapture(s.tabId??0,s.sessionId??"");break;case"STOP_AUDIO_CAPTURE":r=await this.stopAudioCapture(s.tabId??0,s.sessionId??"");break;case"END_INTERVIEW_SESSION":r=await this.endInterviewSession(s.sessionId??"");break;case"UPDATE_CONTEXT":const e=s,n={sessionId:e.sessionId??"",transcription:e.transcription?.text??"",isQuestion:e.transcription?.isInterim??!1,speaker:"user"};await this.contextManager.updateContext(n);break;case"TEST_LLM_CONNECTION":r=await this.testLLMConnection(s.provider??"openai");break;case"TEST_PLATFORM_DETECTION":r=await this.testPlatformDetection(s.url??"");break;case"init_interview_session":r=await this.initializeInterviewSession(s?.metadata,"number"==typeof s?.tabId?s.tabId:void 0);break;case"process_transcription":r=await this.processTranscription("string"==typeof s?.sessionId?s.sessionId:"",s?.transcriptionData||{text:"",confidence:0,timestamp:new Date,isInterim:!1,speaker:"user"});break;case"capture_visual":r=await this.captureAndAnalyzeVisual(s);break;case"get_app_state":r={activeInterviewsCount:this.activeInterviews.size};break;case"ping":r={success:!0,message:"CandidAI extension is running"};break;default:console.warn("Unknown command received:",t),r={success:!1,error:"Unknown command",details:`Command not recognized: ${t}`}}n({success:!0,data:r})}catch(e){console.error("Error handling message:",e),n({success:!1,error:e instanceof Error?e.message:"Unknown error"})}}async initializeOffscreenCapabilities(){let e=[];try{e=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[chrome.runtime.getURL(n)]})}catch(e){console.log("getContexts API not available, proceeding with offscreen creation")}if(0===e.length)try{await chrome.offscreen.createDocument({url:n,reasons:[...s],justification:"Recording audio for AI-powered meeting assistance and transcription"}),console.log("Offscreen document created successfully."),this.performanceAnalyzer.logEvent("offscreen_document_created")}catch(e){console.error("Failed to create offscreen document:",e),this.performanceAnalyzer.logError("offscreen_creation_failure",e)}else console.log("Offscreen document already exists."),this.performanceAnalyzer.logEvent("offscreen_document_existed")}async initializeInterviewSession(e,t){const n=crypto.randomUUID(),s={sessionId:n,callType:e?.callType??"interview",participantCount:e?.participantCount??1,documentCount:e?.documentCount??0,duration:0,platform:e?.platform??"unknown",createdAt:new Date,lastAccessed:new Date,encrypted:!0,retentionPolicy:"standard",tabId:t,initiatedTs:Date.now(),uiConnected:!0,...e},r={sessionId:n,callType:s.callType,tone:"professional",documents:[],participants:[],conversation:[],detectedEntities:{},currentObjectives:[],performanceMetrics:{responseTime:0,accuracy:0,relevanceScore:0,documentsProcessed:0,suggestionsProvided:0,successfulInteractions:0},createdAt:new Date,lastUpdated:new Date,platform:s.platform,state:"active"};this.activeInterviews.set(n,r),this.performanceAnalyzer.startInterview(s,n);try{await chrome.runtime.sendMessage({target:"offscreen",command:"start_audio_capture",sessionId:n}),this.performanceAnalyzer.logEvent("interview_session_initialized",{sessionId:n})}catch(e){console.error(`Failed to send START_AUDIO_CAPTURE to offscreen for session ${n}:`,e),this.performanceAnalyzer.logError("start_audio_capture_failed",e instanceof Error?e:new Error("Audio capture failed"),{sessionId:n}),r.state="paused"}return r}handleConnection(e){if(console.log("New connection established:",e.name,e.sender),this.performanceAnalyzer.logEvent("port_connection_established",{portName:e.name,tabId:e.sender?.tab?.id}),"side_panel"===e.name&&e.sender?.tab?.id){const t=e.sender.tab.id;this.sidePanelPorts.set(t,e),console.log(`[Connection] Side panel port for tab ${t} stored.`),this.performanceAnalyzer.logEvent("sidepanel_port_stored",{tabId:t});try{e.postMessage({command:"service_worker_ready",payload:{status:"connected",serviceWorkerVersion:chrome.runtime.getManifest().version}}),this.performanceAnalyzer.logEvent("service_worker_ready_sent_to_panel",{tabId:t})}catch(e){console.warn(`[Connection] Failed to send SERVICE_WORKER_READY to side panel for tab ${t}:`,e),this.performanceAnalyzer.logError("service_worker_ready_send_failed",e,{tabId:t})}}const t=async t=>{console.log("Message received on port:",e.name,t),this.performanceAnalyzer.logEvent("port_message_received",{portName:e.name,command:t?.command}),await this.handlePortMessage(e,t)},n=()=>{console.log("Port disconnected:",e.name),this.performanceAnalyzer.logEvent("port_disconnected",{portName:e.name}),e.onMessage.removeListener(t),e.onDisconnect.removeListener(n),this.cleanupPortResources(e)};e.onMessage.addListener(t),e.onDisconnect.addListener(n)}async handlePortMessage(e,t){console.log("Handling port message:",e.name,t)}cleanupPortResources(e){console.log("Cleaning up port resources:",e.name)}async handleActionClick(e){console.log("Action clicked for tab:",e)}async resumeInterviewSession(e){console.log("Resuming interview session:",e)}async processTranscription(e,t){return console.log("Processing transcription:",e,t),{content:"Placeholder response",tone:"professional",confidence:.8,relevantDocuments:[],supportingPoints:[],followUpQuestions:[],metadata:{callType:"interview",responseType:"answer",priority:2,timing:"immediate",length:"brief",formality:"professional"}}}async endInterviewSession(e){return console.log("Ending interview session:",e),{finalState:"ENDED"}}async captureAndAnalyzeVisual(e){return console.log("Capturing and analyzing visual:",e),{}}async testLLMConnection(e){return console.log("Testing LLM connection:",e),{success:!0}}async testPlatformDetection(e){return console.log("Testing platform detection:",e),{success:!0}}async startAudioCapture(e,t){try{return await this.ensureOffscreenDocument(),await this.performanceAnalyzer.logEvent("audio_capture_started",{tabId:Number(e)||0}),!0}catch(e){throw e instanceof Error&&e.message,this.performanceAnalyzer.logError("start_audio_capture_failed",e instanceof Error?e:new Error("Audio capture failed"),{sessionId:t}),e}}async stopAudioCapture(e,t){return console.log("Stopping audio capture:",e,t),await this.performanceAnalyzer.logEvent("audio_capture_stopped",{tabId:Number(e)||0}),!0}async ensureOffscreenDocument(){try{let e=[];if(chrome.runtime.getContexts&&(e=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"]})),e&&e.length>0)return void console.log("Offscreen document already exists")}catch(e){console.log("getContexts not available, attempting to create offscreen document")}try{await chrome.offscreen.createDocument({url:chrome.runtime.getURL("offscreen/offscreen.html"),reasons:["USER_MEDIA","AUDIO_PLAYBACK"],justification:"Audio capture for meeting transcription"}),console.log("Offscreen document created successfully")}catch(e){if(e instanceof Error&&e.message.includes("Only a single offscreen"))return void console.log("Offscreen document already exists");throw e}}buildContextualResponse(e,t){return{content:e,tone:t.tone,confidence:.8,relevantDocuments:t.relevantDocuments.map((e=>({id:e.id,name:e.metadata.name,type:e.metadata.type}))),supportingPoints:["Key point 1","Key point 2"],followUpQuestions:["Follow-up 1","Follow-up 2"],metadata:{callType:t.callType,responseType:"answer",priority:2,timing:"immediate",length:"brief",formality:"professional"}}}}})();