(()=>{"use strict";const e="app_config",t="active_interview",s="offscreen/offscreen.html",n="undefined"!=typeof chrome&&chrome.offscreen?[chrome.offscreen.Reason.USER_MEDIA,chrome.offscreen.Reason.AUDIO_PLAYBACK]:["USER_MEDIA","AUDIO_PLAYBACK"],r={OPENAI:{name:"OpenAI",baseUrl:"https://api.openai.com/v1",models:["gpt-4","gpt-4-turbo","gpt-3.5-turbo"],maxTokens:4096,rateLimits:{requestsPerMinute:60,tokensPerMinute:9e4,dailyLimit:1e6}},ANTHROPIC:{name:"Anthropic",baseUrl:"https://api.anthropic.com/v1",models:["claude-3-opus","claude-3-sonnet","claude-3-haiku"],maxTokens:4096,rateLimits:{requestsPerMinute:50,tokensPerMinute:4e4,dailyLimit:5e5}},GOOGLE:{name:"Google",baseUrl:"https://generativelanguage.googleapis.com/v1",models:["gemini-pro","gemini-pro-vision"],maxTokens:2048,rateLimits:{requestsPerMinute:60,tokensPerMinute:32e3,dailyLimit:1e6}}},o={version:"1.0.0",environment:"production",features:{enableTranscription:!0,enableAIResponses:!0,enableDocumentAnalysis:!0,enableVisualAnalysis:!0,enablePerformanceTracking:!0,enableDebugMode:!1},llmProviders:[{name:"OpenAI",apiKey:"",baseUrl:r.OPENAI.baseUrl,model:"gpt-4",maxTokens:2048,temperature:.7,isEnabled:!1,priority:1,rateLimits:r.OPENAI.rateLimits},{name:"Anthropic",apiKey:"",baseUrl:r.ANTHROPIC.baseUrl,model:"claude-3-sonnet",maxTokens:2048,temperature:.7,isEnabled:!1,priority:2,rateLimits:r.ANTHROPIC.rateLimits}],ui:{theme:"auto",language:"en",fontSize:"medium",animations:!0,notifications:!0},security:{encryptStorage:!0,validateInputs:!0,rateLimiting:!0,auditLogging:!0,csrfProtection:!0},performance:{enableMetrics:!0,sampleRate:.1,maxHistorySize:1e3,alertThresholds:{responseTime:5e3,errorRate:.05,memoryUsage:104857600}}},i={INTERVIEW:"interview",MEETING:"meeting",PRESENTATION:"presentation",TRAINING:"training"},a={PROFESSIONAL:"professional",CASUAL:"casual",FORMAL:"formal",FRIENDLY:"friendly"},c={[i.INTERVIEW]:{name:"Interview",description:"One-on-one interview session",suggestedTone:a.PROFESSIONAL,features:["transcription","suggestions","document_analysis"]},[i.MEETING]:{name:"Meeting",description:"Team meeting or group discussion",suggestedTone:a.PROFESSIONAL,features:["transcription","action_items","summary"]},[i.PRESENTATION]:{name:"Presentation",description:"Presentation or demo session",suggestedTone:a.FORMAL,features:["visual_analysis","audience_feedback"]},[i.TRAINING]:{name:"Training",description:"Training or educational session",suggestedTone:a.FRIENDLY,features:["knowledge_base","q_and_a"]}},l={[a.PROFESSIONAL]:{name:"Professional",description:"Formal business communication",style:"structured",vocabulary:"business"},[a.CASUAL]:{name:"Casual",description:"Relaxed conversational style",style:"informal",vocabulary:"everyday"},[a.FORMAL]:{name:"Formal",description:"Academic or official communication",style:"precise",vocabulary:"formal"},[a.FRIENDLY]:{name:"Friendly",description:"Warm and approachable communication",style:"conversational",vocabulary:"accessible"}},u=["pdf","docx","txt","md","doc","rtf"],d={RESUME:"resume",JOB_DESCRIPTION:"job_description",COVER_LETTER:"cover_letter",PORTFOLIO:"portfolio",REFERENCE:"reference",OTHER:"other"},m={LOW:1,MEDIUM:2,HIGH:3,URGENT:4,CRITICAL:5},p={MAX_FILE_SIZE:10485760,ALLOWED_MIME_TYPES:["application/pdf","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/msword","text/plain","text/markdown","application/rtf"],PROCESSING_TIMEOUT:3e4},h={timeout:3e4,retryAttempts:3,retryDelay:1e3,enableLogging:!0};class g{config;handlers=new Map;pendingRequests=new Map;constructor(e={}){this.config={...h,...e},this.initializeMessageListener()}initializeMessageListener(){"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage?chrome.runtime.onMessage.addListener(((e,t,s)=>(this.handleIncomingMessage(e,t,s).catch((e=>{console.error("Error handling incoming message:",e),s({success:!1,error:e instanceof Error?e.message:"Unknown error"})})),!0))):console.warn("Chrome extension APIs not available in this environment")}async handleIncomingMessage(e,t,s){const{command:n}=e;this.config.enableLogging&&console.log(`[MessageBroker] Received command: ${n}`,e);const r=this.handlers.get(n);if(r)try{await r(e,t,s)}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error(`Error in handler for command ${n}:`,e),s({success:!1,error:t})}else s({success:!1,error:"Unknown command",details:`No handler registered for command: ${n}`})}registerHandler(e,t){this.handlers.has(e)&&console.warn(`[MessageBroker] Overwriting existing handler for command: ${e}`),this.handlers.set(e,t),this.config.enableLogging&&console.log(`[MessageBroker] Registered handler for command: ${e}`)}unregisterHandler(e){const t=this.handlers.delete(e);return this.config.enableLogging&&t&&console.log(`[MessageBroker] Unregistered handler for command: ${e}`),t}async sendMessage(e,t){const s={...e,requestId:this.generateRequestId(),timestamp:Date.now()};return this.config.enableLogging&&console.log("[MessageBroker] Sending message:",s),this.sendMessageWithRetry(s,t,0)}async sendMessageWithRetry(e,t,s){try{return await this.sendSingleMessage(e,t)}catch(n){if(s<this.config.retryAttempts)return this.config.enableLogging&&console.warn(`[MessageBroker] Retry attempt ${s+1} for message:`,e.command),await this.delay(this.config.retryDelay*(s+1)),this.sendMessageWithRetry(e,t,s+1);throw n}}async sendSingleMessage(e,t){return new Promise(((s,n)=>{const r=setTimeout((()=>{n(new Error(`Message timeout after ${this.config.timeout}ms`))}),this.config.timeout),o=e=>{clearTimeout(r),chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e?s(e):n(new Error("No response received"))};try{if("undefined"==typeof chrome||!chrome.runtime)return clearTimeout(r),void n(new Error("Chrome extension APIs not available"));t?chrome.tabs.sendMessage(t,e,o):chrome.runtime.sendMessage(e,o)}catch(e){clearTimeout(r),n(e)}}))}async sendMessageToTab(e,t){return this.sendMessage(t,e)}async sendCommand(e,t){const s={command:e,data:t,timestamp:Date.now()};return this.sendMessage(s)}async sendMessageToServiceWorker(e){return this.sendMessage({...e,target:"service_worker"})}async sendMessageToContentScript(e,t){return this.sendMessageToTab(e,{...t,target:"content_script"})}async broadcastMessage(e){try{const t=(await chrome.tabs.query({})).filter((e=>void 0!==e.id)).map((t=>this.sendMessageToTab(t.id,e).catch((()=>null))));return(await Promise.all(t)).filter((e=>null!==e))}catch(e){return console.error("Error broadcasting message:",e),[]}}generateRequestId(){return`${Date.now()}-${Math.random().toString(36).substr(2,9)}`}delay(e){return new Promise((t=>setTimeout(t,e)))}getRegisteredHandlers(){return Array.from(this.handlers.keys())}clearHandlers(){this.handlers.clear(),this.config.enableLogging&&console.log("[MessageBroker] All handlers cleared")}getStats(){return{handlersCount:this.handlers.size,pendingRequestsCount:this.pendingRequests.size}}}const y="candidai:preferences",f="candidai:resume",w="candidai:context",k="candidai:documents";class v{encryptionConfig;cache;encryptionKey;isInitialized;constructor(){this.encryptionConfig={algorithm:"AES-GCM",keyLength:256,ivLength:12,saltLength:16,iterations:1e5},this.cache=new Map,this.encryptionKey=null,this.isInitialized=!1}async ensureEncryptionInitialized(){this.isInitialized||(await this.initializeEncryption(),this.isInitialized=!0)}async initializeEncryption(){try{const e=await this.getStoredKey();e?this.encryptionKey=e:(this.encryptionKey=await this.generateEncryptionKey(),await this.storeEncryptionKey(this.encryptionKey))}catch(e){console.error("Encryption initialization failed:",e),this.encryptionKey=null}}async generateEncryptionKey(){return await crypto.subtle.generateKey({name:"AES-GCM",length:this.encryptionConfig.keyLength},!0,["encrypt","decrypt"])}async storeEncryptionKey(e){try{const t={key:await crypto.subtle.exportKey("jwk",e),algorithm:this.encryptionConfig.algorithm,created:Date.now()};await chrome.storage.local.set({"candidai:encryptionKey":t})}catch(e){throw console.error("Failed to store encryption key:",e),e}}async getStoredKey(){try{const e=await chrome.storage.local.get("candidai:encryptionKey");if(!e["candidai:encryptionKey"])return null;const t=e["candidai:encryptionKey"];return await crypto.subtle.importKey("jwk",t.key,{name:this.encryptionConfig.algorithm,length:this.encryptionConfig.keyLength},!0,["encrypt","decrypt"])}catch(e){return console.error("Failed to retrieve encryption key:",e),null}}async set(e,t,s={}){try{await this.ensureEncryptionInitialized();const n=`${s.namespace||y}:${e}`,r=JSON.stringify(t);let o;o=this.encryptionKey&&!1!==s.encrypt?await this.encryptData(r):{encrypted:!1,data:r,timestamp:Date.now()},await chrome.storage.local.set({[n]:o}),this.cache.set(n,t)}catch(t){throw console.error("Storage operation failed:",t),new Error(`Failed to store data for key: ${e}`)}}async get(e,t={}){try{await this.ensureEncryptionInitialized();const s=`${t.namespace||y}:${e}`;if(this.cache.has(s))return this.cache.get(s);const n=(await chrome.storage.local.get(s))[s];if(!n)return null;if(t.ttl&&n.timestamp&&Date.now()-n.timestamp>t.ttl)return await this.remove(e,t),null;let r;if(n.encrypted&&this.encryptionKey){const e=await this.decryptData(n);r=JSON.parse(e)}else r=JSON.parse(n.data);return this.cache.set(s,r),r}catch(e){return console.error("Storage retrieval failed:",e),null}}async remove(e,t={}){try{const s=`${t.namespace||y}:${e}`;await chrome.storage.local.remove(s),this.cache.delete(s)}catch(t){throw console.error("Storage removal failed:",t),new Error(`Failed to remove data for key: ${e}`)}}async clear(){try{await chrome.storage.local.clear(),this.cache.clear()}catch(e){throw console.error("Storage clear failed:",e),e}}async getAllKeys(){try{const e=await chrome.storage.local.get();return Object.keys(e)}catch(e){return console.error("Failed to get all keys:",e),[]}}async encrypt(e){if(await this.ensureEncryptionInitialized(),!this.encryptionKey)throw new Error("Encryption key not available");const t=JSON.stringify(e),s=await this.encryptData(t);return JSON.stringify(s)}async decrypt(e){if(await this.ensureEncryptionInitialized(),!this.encryptionKey)throw new Error("Encryption key not available");const t=JSON.parse(e),s=await this.decryptData(t);return JSON.parse(s)}async encryptData(e){if(!this.encryptionKey)throw new Error("Encryption key not available");const t=crypto.getRandomValues(new Uint8Array(this.encryptionConfig.ivLength)),s=(new TextEncoder).encode(e),n=await crypto.subtle.encrypt({name:this.encryptionConfig.algorithm,iv:t},this.encryptionKey,s);return{encrypted:!0,data:this.arrayBufferToBase64(n),iv:this.arrayBufferToBase64(t),algorithm:this.encryptionConfig.algorithm,timestamp:Date.now()}}async decryptData(e){if(!this.encryptionKey)throw new Error("Encryption key not available");if(!e.iv)throw new Error("Missing IV for decryption");const t=this.base64ToArrayBuffer(e.data),s=this.base64ToArrayBuffer(e.iv),n=await crypto.subtle.decrypt({name:this.encryptionConfig.algorithm,iv:s},this.encryptionKey,t);return(new TextDecoder).decode(n)}async batchSet(e,t={}){const s=e.map((async e=>{const s={...t,...e.options};await this.set(e.key,e.value,s)}));await Promise.all(s)}async clearNamespace(e){try{const t=await chrome.storage.local.get(),s=Object.keys(t).filter((t=>t.startsWith(e)));s.length>0&&(await chrome.storage.local.remove(s),s.forEach((e=>this.cache.delete(e))))}catch(e){throw console.error("Failed to clear namespace:",e),e}}async getNamespaceKeys(e){try{const t=await chrome.storage.local.get();return Object.keys(t).filter((t=>t.startsWith(e))).map((t=>t.replace(`${e}:`,"")))}catch(e){return console.error("Failed to get namespace keys:",e),[]}}async initialize(e){try{await this.ensureEncryptionInitialized();for(const[t,s]of Object.entries(e))null===await this.get(t)&&await this.set(t,s)}catch(e){throw console.error("Storage initialization failed:",e),e}}async getState(){try{const e=await chrome.storage.local.get(),t={};for(const[s,n]of Object.entries(e))if(s.startsWith("candidai:")){const e=n;let r;r=e.encrypted&&this.encryptionKey?JSON.parse(await this.decryptData(e)):JSON.parse(e.data),t[s]=r}return t}catch(e){return console.error("Failed to get application state:",e),{}}}arrayBufferToBase64(e){const t=new Uint8Array(e);let s="";for(let e=0;e<t.byteLength;e++){const n=t[e];void 0!==n&&(s+=String.fromCharCode(n))}return btoa(s)}base64ToArrayBuffer(e){const t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);return s.buffer}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}clearCache(){this.cache.clear()}async getItem(e){return this.get(e)}async setItem(e,t){return this.set(e,t)}}class E{apiKey;config;baseURL;models;capabilities;rateLimits;requestHistory;tokenHistory;modelConfigs={};constructor(e,t={}){if(new.target===E)throw new Error("BaseLLMProvider is an abstract class and cannot be instantiated directly");this.apiKey=e,this.config=t,this.baseURL=t.baseURL||"",this.models=t.models||[],this.capabilities=t.capabilities||[],this.rateLimits={requestsPerMinute:60,tokensPerMinute:9e4,requestsPerDay:1e4},this.requestHistory=[],this.tokenHistory=[]}checkRateLimits(e=0){const t=Date.now(),s=t-6e4,n=t-864e5;if(this.requestHistory=this.requestHistory.filter((e=>e>n)),this.tokenHistory=this.tokenHistory.filter((e=>e.time>s)),this.requestHistory.filter((e=>e>s)).length>=this.rateLimits.requestsPerMinute)throw new Error("Rate limit exceeded: requests per minute");if(this.tokenHistory.filter((e=>e.time>s)).reduce(((e,t)=>e+t.tokens),0)+e>this.rateLimits.tokensPerMinute)throw new Error("Rate limit exceeded: tokens per minute");if(this.requestHistory.length>=this.rateLimits.requestsPerDay)throw new Error("Rate limit exceeded: daily request limit")}recordRequest(e){const t=Date.now();this.requestHistory.push(t),this.tokenHistory.push({time:t,tokens:e})}estimateTokens(e){return Math.ceil(e.length/4)}validateModel(e){if(!this.models.includes(e))throw new Error(`Model ${e} is not available for this provider`)}hasCapability(e){return this.capabilities.includes(e)}formatMessages(e){return e.map((e=>"string"==typeof e?{role:"user",content:e}:{role:e.role||"user",content:e.content||""}))}handleCommonErrors(e){const t=e.message?.toLowerCase()||"";if(t.includes("unauthorized")||t.includes("401"))throw new Error("Authentication failed. Please check your API key.");if(t.includes("rate limit")||t.includes("429"))throw new Error("Rate limit exceeded. Please try again later.");if(t.includes("timeout"))throw new Error("Request timed out. Please try again.");if(t.includes("network"))throw new Error("Network error. Please check your connection.");throw e}getModelConfig(e){return this.modelConfigs?.[e]||null}calculatePricing(e,t){return 0}getModels(){return Object.freeze([...this.models])}getCapabilities(){return Object.freeze([...this.capabilities])}}class T extends E{constructor(e,t={}){super(e,t),this.baseURL="https://api.openai.com/v1",this.models=t.models||["gpt-4-turbo-preview","gpt-4-vision-preview","gpt-3.5-turbo","gpt-3.5-turbo-16k"],this.modelConfigs={"gpt-4-turbo-preview":{maxTokens:128e3,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.01,costPer1kOutput:.03},"gpt-4-vision-preview":{maxTokens:128e3,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.01,costPer1kOutput:.03},"gpt-3.5-turbo":{maxTokens:4096,supportsVision:!1,supportsFunctions:!0,costPer1kInput:5e-4,costPer1kOutput:.0015},"gpt-3.5-turbo-16k":{maxTokens:16384,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.003,costPer1kOutput:.004}}}async generateCompletion(e){const{model:t="gpt-3.5-turbo",messages:s,systemMessage:n,temperature:r=.7,maxTokens:o=500,stream:i=!1,tools:a=null}=e,c=s?s.map((e=>({role:e.role||"user",content:e.content||""}))):[{role:"user",content:e.prompt||""}];if(!this.models.includes(t))throw new Error(`Model ${t} not available for OpenAI provider`);const l=[];n&&l.push({role:"system",content:n}),l.push(...c);const u={model:t,messages:l,temperature:r,max_tokens:o,stream:i};a&&this.modelConfigs[t]?.supportsFunctions&&(u.functions=a);try{const e=await this.makeRequest("/chat/completions",u);return i?{provider:"openai",model:t,isStream:!0,stream:this.handleStreamResponse(e)}:this.formatResponse(e,t)}catch(e){throw this.handleError(e)}}async makeRequest(e,t,s=3){const n=`${this.baseURL}${e}`;for(let e=0;e<=s;e++)try{const e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v1"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===s)throw t;const n=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(n)}throw new Error("Max retries exceeded")}formatResponse(e,t){const s=e.choices?.[0];if(!s)throw new Error("No choices in OpenAI response");return{content:s.message?.content||"",role:s.message?.role||"assistant",functionCall:s.message?.function_call,finishReason:s.finish_reason||"unknown",usage:{promptTokens:e.usage?.prompt_tokens||0,completionTokens:e.usage?.completion_tokens||0,totalTokens:e.usage?.total_tokens||0,model:t,estimatedCost:this.calculateCost({promptTokens:e.usage?.prompt_tokens||0,completionTokens:e.usage?.completion_tokens||0,totalTokens:e.usage?.total_tokens||0},t)},provider:"openai",model:t,id:e.id,created:e.created,choices:e.choices}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const s=new TextDecoder;let n="";for(;;){const{done:e,value:r}=await t.read();if(e)break;n+=s.decode(r,{stream:!0});const o=n.split("\n");n=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);e.choices[0].delta.content&&(yield{content:e.choices[0].delta.content,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const s=this.modelConfigs[t];return s?e.promptTokens/1e3*s.costPer1kInput+e.completionTokens/1e3*s.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({prompt:"Hello",context:{currentTopic:"test",conversationHistory:[],relevantDocuments:[],participantContext:{},meetingPhase:"opening"},callType:"interview",tone:"professional",model:"gpt-3.5-turbo",maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("rate limit")?new Error("Rate limit exceeded. Please try again later."):t.includes("quota")?new Error("API quota exceeded"):t.includes("context length")?new Error("Message too long for model context window"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}async getConnectionTestResult(){try{return{success:!0,message:"Connection successful",model:(await this.generateCompletion({prompt:"Hello",context:{currentTopic:"test",conversationHistory:[],relevantDocuments:[],participantContext:{},meetingPhase:"opening"},callType:"interview",tone:"professional",model:"gpt-3.5-turbo",maxTokens:10})).model}}catch(e){return{success:!1,message:e.message}}}}class C extends E{anthropicVersion;constructor(e,t={}){super(e,t),this.baseURL="https://api.anthropic.com/v1",this.models=t.models||["claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],this.modelConfigs={"claude-3-opus-20240229":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.015,costPer1kOutput:.075},"claude-3-sonnet-20240229":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.003,costPer1kOutput:.015},"claude-3-haiku-20240307":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:25e-5,costPer1kOutput:.00125}},this.anthropicVersion="2023-06-01"}async generateCompletion(e){const{model:t="claude-3-sonnet-20240229",messages:s,temperature:n=.7,maxTokens:r=500,stream:o=!1}=e,i="systemPrompt"in e?e.systemPrompt:void 0;if(!this.models.includes(t))throw new Error(`Model ${t} not available for Anthropic provider`);const a=Array.isArray(s)?s:[],c={model:t,messages:this.formatMessagesForClaude(a),max_tokens:r,temperature:n,stream:o};i&&(c.system=i);try{const e=await this.makeRequest("/messages",c);return o?{provider:"anthropic",model:t,isStream:!0,stream:this.handleStreamResponse(e)}:this.formatResponse(e,t)}catch(e){throw this.handleError(e)}}formatMessagesForClaude(e){const t=[];e.forEach((e=>{const s=t[t.length-1];0===t.length||s&&s.role!==e.role?t.push({role:"system"===e.role?"user":e.role,content:e.content}):s&&(s.content+="\\n\\n"+e.content)}));const s=t[0];return t.length>0&&s&&"assistant"===s.role&&t.unshift({role:"user",content:"Continue the conversation."}),t}async makeRequest(e,t,s=3){const n=`${this.baseURL}${e}`;for(let e=0;e<=s;e++)try{const e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":this.anthropicVersion},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===s)throw t;const n=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(n)}throw new Error("Max retries exceeded")}formatResponse(e,t){return{content:e.content?.[0]?.text||"",role:e.role,finishReason:e.stop_reason,usage:{promptTokens:e.usage.input_tokens,completionTokens:e.usage.output_tokens,totalTokens:e.usage.input_tokens+e.usage.output_tokens,model:t,estimatedCost:this.calculateCost(e.usage,t)},provider:"anthropic",model:t,id:e.id,...e.stop_sequence&&{stopSequence:e.stop_sequence}}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const s=new TextDecoder;let n="";for(;;){const{done:e,value:r}=await t.read();if(e)break;n+=s.decode(r,{stream:!0});const o=n.split("\\n");n=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);"content_block_delta"===e.type&&e.delta?.text&&(yield{content:e.delta.text,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const s=this.modelConfigs[t];return s?e.input_tokens/1e3*s.costPer1kInput+e.output_tokens/1e3*s.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({model:"claude-3-haiku-20240307",messages:[{role:"user",content:"Hello"}],maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("rate limit")?new Error("Rate limit exceeded. Please try again later."):t.includes("quota")?new Error("API quota exceeded"):t.includes("token")&&t.includes("limit")?new Error("Message too long for model context window"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}}class P extends E{defaultSafetySettings;constructor(e,t={}){super(e,t),this.baseURL="https://generativelanguage.googleapis.com/v1beta",this.models=t.models||["gemini-pro","gemini-pro-vision","gemini-ultra"],this.modelConfigs={"gemini-pro":{maxTokens:32768,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.0025,costPer1kOutput:.0025},"gemini-pro-vision":{maxTokens:32768,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.0025,costPer1kOutput:.0025},"gemini-ultra":{maxTokens:32768,supportsVision:!0,supportsFunctions:!0,costPer1kInput:.01875,costPer1kOutput:.01875}},this.defaultSafetySettings=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]}async generateCompletion(e){const{model:t="gemini-pro",messages:s,temperature:n=.7,maxTokens:r=500,stream:o=!1}=e,i="systemPrompt"in e?e.systemPrompt:void 0,a="functions"in e?e.functions:null;if(!this.models.includes(t))throw new Error(`Model ${t} not available for Gemini provider`);const c=Array.isArray(s)?s:[],l={contents:this.formatMessagesForGemini(c,i),generationConfig:{temperature:n,maxOutputTokens:r,candidateCount:1},safetySettings:this.defaultSafetySettings};a&&this.modelConfigs[t]?.supportsFunctions&&(l.tools=[{functionDeclarations:a}]);try{const e=o?`/models/${t}:streamGenerateContent`:`/models/${t}:generateContent`,s=await this.makeRequest(e,l);return o?{provider:"gemini",model:t,isStream:!0,stream:this.handleStreamResponse(s)}:this.formatResponse(s,t)}catch(e){throw this.handleError(e)}}formatMessagesForGemini(e,t){const s=[];return t&&(s.push({role:"user",parts:[{text:`System: ${t}\n\nPlease follow these instructions in your responses.`}]}),s.push({role:"model",parts:[{text:"Understood. I will follow these instructions."}]})),e.forEach((e=>{const t="assistant"===e.role?"model":"user";if("string"==typeof e.content)s.push({role:t,parts:[{text:e.content}]});else if(Array.isArray(e.content)){const n=e.content.map((e=>"text"===e.type?{text:e.text}:"image"===e.type?{inlineData:{mimeType:e.mimeType||"image/jpeg",data:e.data}}:null)).filter(Boolean);s.push({role:t,parts:n})}})),s}async makeRequest(e,t,s=3){const n=`${this.baseURL}${e}?key=${this.apiKey}`;for(let e=0;e<=s;e++)try{const e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===s)throw t;const n=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(n)}throw new Error("Max retries exceeded")}formatResponse(e,t){const s=e.candidates?.[0];if(!s)throw new Error("No candidates in Gemini response");return{content:s.content?.parts?.[0]?.text||"",role:"assistant",finishReason:s.finishReason,usage:{promptTokens:e.usageMetadata?.promptTokenCount||0,completionTokens:e.usageMetadata?.candidatesTokenCount||0,totalTokens:e.usageMetadata?.totalTokenCount||0,model:t,estimatedCost:this.calculateCost({promptTokens:e.usageMetadata?.promptTokenCount||0,completionTokens:e.usageMetadata?.candidatesTokenCount||0,totalTokens:e.usageMetadata?.totalTokenCount||0},t)},provider:"gemini",model:t,safetyRatings:s.safetyRatings}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const s=new TextDecoder;let n="";for(;;){const{done:e,value:r}=await t.read();if(e)break;n+=s.decode(r,{stream:!0});const o=n.split("\n");n=o.pop()||"";for(const e of o)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);e.candidates?.[0]?.content?.parts?.[0]?.text&&(yield{content:e.candidates[0].content.parts[0].text,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const s=this.modelConfigs[t];return s?e.promptTokens/1e3*s.costPer1kInput+e.completionTokens/1e3*s.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({model:"gemini-pro",messages:[{role:"user",content:"Hello"}],maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("quota")?new Error("API quota exceeded"):t.includes("safety")?new Error("Content blocked by safety filters"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}}class M{sectionPatterns;skillCategories;constructor(){this.sectionPatterns={experience:/^(work\s*experience|professional\s*experience|employment|experience|work\s*history)/i,education:/^(education|academic|qualification|degree)/i,skills:/^(skills|technical\s*skills|core\s*competencies|expertise)/i,projects:/^(projects|portfolio|key\s*projects)/i,certifications:/^(certifications|certificates|licenses)/i,summary:/^(summary|objective|profile|about)/i,contact:/^(contact|personal\s*information)/i},this.skillCategories={programming:["python","java","javascript","typescript","c++","react","angular","vue"],databases:["sql","mysql","postgresql","mongodb","redis","elasticsearch"],cloud:["aws","azure","gcp","docker","kubernetes","terraform"],tools:["git","jenkins","jira","confluence","slack","figma"],soft:["leadership","communication","teamwork","problem-solving","analytical"]}}async parseFile(e){const t=e.type;let s="";try{if("application/pdf"===t)s=await this.parsePDF(e);else{if("application/vnd.openxmlformats-officedocument.wordprocessingml.document"!==t)throw new Error("Unsupported file format");s=await this.parseDOCX(e)}return{raw:s,structured:this.extractStructuredData(s),metadata:{fileName:e.name,fileSize:e.size,parsedAt:Date.now()}}}catch(e){throw console.error("Resume parsing failed:",e),new Error(`Failed to parse resume: ${e.message}`)}}async parsePDF(e){return new Promise(((t,s)=>{const n=new FileReader;n.onload=async e=>{try{t("PDF parsing would extract text here using PDF.js library")}catch(e){s(e)}},n.onerror=()=>s(new Error("Failed to read PDF file")),n.readAsArrayBuffer(e)}))}async parseDOCX(e){return new Promise(((t,s)=>{const n=new FileReader;n.onload=async e=>{try{t("DOCX parsing would extract text here using mammoth.js library")}catch(e){s(e)}},n.onerror=()=>s(new Error("Failed to read DOCX file")),n.readAsArrayBuffer(e)}))}extractStructuredData(e){const t=e.split("\n").map((e=>e.trim())).filter((e=>e)),s={personalInfo:{},experience:[],education:[],skills:[],projects:[],certifications:[],summary:""};let n=null,r=[];for(let e=0;e<t.length;e++){const o=t[e];if(!o)continue;const i=t[e+1]||"",a=this.detectSection(o,i);a?(n&&r.length>0&&this.processSection(n,r,s),n=a,r=[]):n?r.push(o):this.extractPersonalInfo(o,s.personalInfo)}return n&&r.length>0&&this.processSection(n,r,s),this.enhanceStructuredData(s),s}detectSection(e,t){for(const[s,n]of Object.entries(this.sectionPatterns))if(n.test(e)&&e.length<50&&(!t||t.length>10))return s;if(e===e.toUpperCase()&&e.length<30){const t=e.toLowerCase();for(const[e,s]of Object.entries(this.sectionPatterns))if(s.test(t))return e}return null}processSection(e,t,s){switch(e){case"experience":s.experience=this.parseExperience(t);break;case"education":s.education=this.parseEducation(t);break;case"skills":s.skills=this.parseSkills(t);break;case"projects":s.projects=this.parseProjects(t);break;case"certifications":s.certifications=t.filter((e=>e.trim().length>0));break;case"summary":s.summary=t.join(" ").trim();break;default:console.log(`Unknown section: ${e}`)}}parseExperience(e){const t=[];let s=null;for(const n of e)if(this.looksLikeJobTitle(n)){s&&s.company&&s.position&&t.push(s);const e=n.split(" at ");s=e.length>=2?{position:e[0]?.trim()||"",company:e[1]?.trim()||"",description:[]}:{position:n.trim(),company:"",description:[]}}else s&&(n.match(/\d{4}|\w+\s+\d{4}/)?s.duration=n:!s.company&&n.length>0?s.company=n:n.length>10&&(s.description||(s.description=[]),s.description.push(n)));return s&&s.company&&s.position&&t.push(s),t}parseSkills(e){const t=[];return e.forEach((e=>{const s=e.split(/[,•·\-\n]/).map((e=>e.trim())).filter((e=>e.length>1&&this.looksLikeSkill(e)));t.push(...s)})),[...new Set(t)]}parseEducation(e){const t=[];let s=null;for(const n of e)this.looksLikeInstitution(n)?(s&&s.institution&&t.push(s),s={institution:n.trim(),degree:""}):s&&(n.includes("Bachelor")||n.includes("Master")||n.includes("PhD")?s.degree=n.trim():n.match(/\d{4}/)&&(s.graduationDate=n.trim()));return s&&s.institution&&t.push(s),t}parseProjects(e){const t=[];let s=null;for(const n of e)n.length>0&&!n.startsWith("-")&&!n.startsWith("•")?(s&&s.name&&t.push(s),s={name:n.trim(),description:""}):s&&n.length>0&&(s.description||(s.description=""),s.description+=" "+n.trim());return s&&s.name&&t.push(s),t}extractPersonalInfo(e,t){const s=e.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/);s&&(t.email=s[0]);const n=e.match(/(\+?\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/);if(n&&(t.phone=n[0]),e.includes("linkedin.com")&&(t.linkedin=e.trim()),e.includes("github.com")&&(t.github=e.trim()),!t.name&&e.length>5&&e.length<50&&!e.includes("@")){const s=e.split(" ");s.length>=2&&s.length<=4&&(t.name=e.trim())}}looksLikeJobTitle(e){return[/engineer/i,/developer/i,/manager/i,/analyst/i,/designer/i,/consultant/i,/specialist/i,/coordinator/i,/director/i,/lead/i].some((t=>t.test(e)))}looksLikeSkill(e){return e.length>1&&e.length<30&&!e.includes(" ")&&!e.match(/\d{4}/)}looksLikeInstitution(e){return["university","college","institute","school","academy"].some((t=>e.toLowerCase().includes(t)))}categorizeSkill(e){const t=e.toLowerCase();for(const[e,s]of Object.entries(this.skillCategories))if(s.includes(t))return e;return"other"}enhanceStructuredData(e){if(e.experience.length>0){const t=this.calculateTotalExperience(e.experience);console.log(`Total experience: ${t} years`)}e.skills=e.skills.map((e=>(this.categorizeSkill(e),e))),e.skills=[...new Set(e.skills)]}calculateTotalExperience(e){return 2*e.length}}const S="company",x="role",b="skill",I="technology",R="interviewer",A="project",D="metric";class O{storage;resumeParser;sessionContexts;entityPatterns;constructor(){this.storage=new v,this.resumeParser=new M,this.sessionContexts=new Map,this.entityPatterns=this.initializeEntityPatterns(),this.loadPersistedContext()}initializeEntityPatterns(){return{[S]:{patterns:[/(?:work(?:ed|ing)?\s+(?:at|for)|employed\s+by|join(?:ed|ing)?)\s+([A-Z][\w\s&]+)/gi,/(?:at|with)\s+([A-Z][\w\s&]+)\s+(?:Inc|LLC|Corp|Company|Limited|Ltd)/gi],keywords:["company","employer","organization","firm"]},[x]:{patterns:[/(?:position|role|title)(?:\s+is|\s+was|\s+of)?\s+([A-Z][\w\s]+(?:Engineer|Developer|Manager|Analyst|Designer))/gi,/(?:as|working\s+as)\s+(?:a|an)?\s+([A-Z][\w\s]+)/gi],keywords:["position","role","title","job"]},[b]:{patterns:[/(?:experience|proficient|skilled|expertise)\s+(?:in|with)\s+([\w\s,+#]+)/gi,/(?:using|know|familiar\s+with)\s+([\w\s,+#]+)/gi],keywords:["skill","expertise","proficiency","experience"]},[I]:{patterns:[/\b(React|Angular|Vue|Node\.?js|Python|Java|JavaScript|TypeScript|AWS|Azure|GCP|Docker|Kubernetes)\b/gi,/\b([A-Z][\w]+(?:\.js|DB|SQL))\b/g],keywords:["technology","framework","language","tool"]}}}async createSessionContext(e){const t=e.sessionId||crypto.randomUUID(),s=await this.storage.get("resumeData",{namespace:f}),n=await this.storage.get("jobDescriptions",{namespace:f}),r={sessionId:t,platform:e.platform||"unknown",startTime:Date.now(),resume:s,jobDescription:n?.[0],conversationHistory:[],detectedEntities:{[S]:new Set,[x]:new Set,[b]:new Set,[I]:new Set,[R]:new Set,[A]:new Set,[D]:new Set},keyTopics:[],questionCount:0,currentQuestion:null};return this.sessionContexts.set(t,r),await this.persistContext(t,r),r}async enrichContext(e){const t=e.sessionId,s=this.sessionContexts.get(t)||await this.createSessionContext(e),n={...s,...e,insights:{interviewDuration:Date.now()-s.startTime,averageResponseTime:this.calculateAverageResponseTime(s),topSkillsDiscussed:this.identifyTopSkills(s),matchScore:this.calculateJobMatchScore(s)}};return this.sessionContexts.set(t,n),n}async updateContext(e){const{sessionId:t,transcription:s,isQuestion:n,speaker:r}=e,o=this.sessionContexts.get(t);if(!o)return void console.error("Context not found for session:",t);const i=this.extractEntities(s);for(const[e,t]of Object.entries(i)){const s=o.detectedEntities[e];s&&t.forEach((e=>s.add(e)))}const a={timestamp:Date.now(),text:s,entities:i,keywords:this.extractKeywords(s),...r&&{speaker:r},...void 0!==n&&{isQuestion:n}};return o.conversationHistory.push(a),n&&(o.questionCount++,o.currentQuestion=s),this.updateKeyTopics(o,a.keywords),await this.persistContext(t,o),o}extractEntities(e){const t={};for(const[s,n]of Object.entries(this.entityPatterns))if(t[s]=new Set,n.patterns.forEach((n=>{const r=e.matchAll(n);for(const e of r)e[1]&&t[s]&&t[s].add(e[1].trim())})),n.keywords.some((t=>e.toLowerCase().includes(t)))){const r=e.split(/\s+/);r.forEach(((e,o)=>{if(n.keywords.includes(e.toLowerCase())&&o<r.length-1){let e="";for(let t=o+1;t<Math.min(o+4,r.length);t++){const s=r[t];if(!s||!s[0]||s[0]!==s[0].toUpperCase())break;e+=s+" "}e.trim()&&t[s]&&t[s].add(e.trim())}}))}const s={};for(const[e,n]of Object.entries(t))s[e]=Array.from(n);return s}extractKeywords(e){const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","been","have","has","had","do","does","did","will","would","could","should","may","might","must","can","could","this","that","these","those","i","you","he","she","it","we","they","what","which"]),s=e.toLowerCase().split(/\W+/).filter((e=>e.length>2&&!t.has(e))),n={};return s.forEach((e=>{n[e]=(n[e]||0)+1})),Object.entries(n).sort(((e,t)=>t[1]-e[1])).slice(0,5).map((([e])=>e))}updateKeyTopics(e,t){t.forEach((t=>{const s=e.keyTopics.find((e=>e.keyword===t));s?(s.frequency++,s.lastMentioned=Date.now()):e.keyTopics.push({keyword:t,frequency:1,firstMentioned:Date.now(),lastMentioned:Date.now()})})),e.keyTopics.sort(((e,t)=>t.frequency-e.frequency)),e.keyTopics=e.keyTopics.slice(0,10)}calculateAverageResponseTime(e){const t=[],s=[];if(e.conversationHistory.forEach((e=>{e.isQuestion?t.push(e.timestamp):s.push(e.timestamp)})),0===t.length||0===s.length)return 0;let n=0,r=0;for(let e=0;e<t.length;e++){const o=t[e];if(void 0!==o){const e=s.find((e=>e>o));e&&(n+=e-o,r++)}}return r>0?n/r:0}identifyTopSkills(e){const t=e.detectedEntities[b],s=e.detectedEntities[I];return[...t?Array.from(t):[],...s?Array.from(s):[]].slice(0,5)}calculateJobMatchScore(e){if(!e.resume||!e.jobDescription)return 0;const t=new Set(e.resume.structured?.skills||[]),s=new Set(e.jobDescription.requirements||[]),n=e.detectedEntities[b];let r=0,o=0;s.forEach((e=>{t.has(e)&&r++,n&&n.has(e)&&o++}));const i=s.size>0?r/s.size:0,a=s.size>0?o/s.size*.2:0;return Math.min(i+a,1)}async persistContext(e,t){const s={...t,detectedEntities:{}};for(const[e,n]of Object.entries(t.detectedEntities))s.detectedEntities[e]=Array.from(n);await this.storage.set(`context_${e}`,s,{namespace:w})}async loadPersistedContext(){const e=await this.storage.getNamespaceKeys(w);for(const t of e){const e=t.split(":")[1];if(e){const t=await this.storage.get(e,{namespace:w});if(t&&t.sessionId){for(const[e,s]of Object.entries(t.detectedEntities))Array.isArray(s)&&(t.detectedEntities[e]=new Set(s));this.sessionContexts.set(t.sessionId,t)}}}}}class _{storage;resumeParser;processingQueue=new Map;activeProcessing=new Set;documentCache=new Map;MAX_QUEUE_SIZE=10;RETRY_LIMIT=3;CACHE_EXPIRY=864e5;constructor(){this.storage=new v,this.resumeParser=new M,this.initializeDocumentProcessing()}async uploadDocuments(e,t,s){const n=[],r=[];if((await this.getSessionDocuments(s)).length+e.length>10)return{success:!1,uploaded:[],errors:["Maximum 10 documents allowed per session"]};for(const s of Array.from(e))try{const e=this.validateDocument(s);if(!e.valid){r.push(`${s.name}: ${e.error}`);continue}const o=await this.createDocumentMetadata(s,t);await this.queueDocumentProcessing(s,o),n.push(o)}catch(e){r.push(`${s.name}: ${e instanceof Error?e.message:"Unknown error"}`)}return{success:n.length>0,uploaded:n,errors:r}}validateDocument(e){if(e.size>10485760)return{valid:!1,error:`File size ${(e.size/1024/1024).toFixed(1)}MB exceeds limit of 10MB`};const t=e.name.split(".").pop()?.toLowerCase();return t&&u.includes(t)?e.name.length>255?{valid:!1,error:"File name too long (max 255 characters)"}:{valid:!0}:{valid:!1,error:`Unsupported format. Supported: ${u.join(", ")}`}}async createDocumentMetadata(e,t){const s=this.generateDocumentId(),n=this.detectDocumentType(e.name,t),r=this.calculateDocumentPriority(n,t);return{id:s,name:e.name,type:n,size:e.size,format:e.name.split(".").pop()?.toLowerCase()||"unknown",uploadDate:new Date,lastModified:new Date(e.lastModified),priority:r,tags:this.generateTags(e.name,n),checksum:await this.calculateChecksum(e)}}async queueDocumentProcessing(e,t){if(this.processingQueue.size>=this.MAX_QUEUE_SIZE)throw new Error("Processing queue is full. Please wait for current documents to finish processing.");const s={id:t.id,file:e,metadata:t,priority:t.priority,retryCount:0};this.processingQueue.set(t.id,s),this.activeProcessing.size<p.MAX_CONCURRENT_PROCESSING&&this.processNextInQueue()}async processNextInQueue(){if(0===this.processingQueue.size||this.activeProcessing.size>=p.MAX_CONCURRENT_PROCESSING)return;const e=Array.from(this.processingQueue.values()),t=[m.CRITICAL,m.HIGH,m.MEDIUM,m.LOW,m.BACKGROUND];let s;for(const n of t)if(s=e.find((e=>e.priority===n)),s)break;if(s){this.processingQueue.delete(s.id),this.activeProcessing.add(s.id);try{await this.processDocument(s)}finally{this.activeProcessing.delete(s.id),this.processNextInQueue()}}}async processDocument(e){const t=Date.now();try{const s=await this.extractTextContent(e.file),n=await this.parseStructuredData(s,e.metadata.type,e.file),r=this.createDocumentChunks(s),o=await this.extractEntities(s),i=await this.generateSummary(s,e.metadata.type),a=await this.extractKeyPoints(s,e.metadata.type),c={id:e.metadata.id,rawText:s,structuredData:n,chunks:r,extractedEntities:o,summary:i,keyPoints:a,processingStatus:"completed"};return await this.storeDocument(e.metadata,c),this.documentCache.set(e.metadata.id,c),{success:!0,document:c,processingTime:Date.now()-t}}catch(s){if(console.error(`Document processing failed for ${e.metadata.name}:`,s),e.retryCount<this.RETRY_LIMIT){const s={...e,retryCount:e.retryCount+1};return this.processingQueue.set(e.id,s),{success:!1,error:`Processing failed, retrying (${e.retryCount+1}/${this.RETRY_LIMIT})`,processingTime:Date.now()-t}}return{success:!1,error:s instanceof Error?s.message:"Unknown processing error",processingTime:Date.now()-t}}}async extractTextContent(e){const t=e.name.split(".").pop()?.toLowerCase();switch(t){case"txt":case"md":return await e.text();case"pdf":return await this.extractPdfText(e);case"docx":case"doc":return await this.extractDocxText(e);case"pptx":case"ppt":return await this.extractPptText(e);case"xlsx":case"xls":return await this.extractExcelText(e);default:throw new Error(`Unsupported file format: ${t}`)}}async extractPdfText(e){try{return`[PDF Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract PDF text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractDocxText(e){try{return`[DOCX Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract DOCX text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractPptText(e){try{return`[PowerPoint Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract PowerPoint text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractExcelText(e){try{return`[Excel Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract Excel text: ${e instanceof Error?e.message:"Unknown error"}`)}}async findRelevantDocuments(e,t,s=3){const n=await this.getSessionDocuments(e.currentTopic),r=c[t],o=[];for(const s of n){const n=await this.getDocumentContent(s.id);if(!n)continue;const i=this.calculateRelevanceScore(n,e,t,r);if(i>.3){const s=this.findMatchingChunks(n,e.currentTopic);o.push({document:n,relevanceScore:i,matchingChunks:s,reason:this.generateRelevanceReason(n,e,t)})}}return o.sort(((e,t)=>t.relevanceScore-e.relevanceScore)).slice(0,s)}calculateRelevanceScore(e,t,s,n){let r=0;const o=this.getDocumentMetadataFromCache(e.id);return o&&n.documentRelevance[o.type]&&(r+=.4*this.getPriorityWeight(n.documentRelevance[o.type])),r+=.3*this.calculateTopicSimilarity(e,t.currentTopic),r+=.3*this.calculateEntityOverlap(e,t.conversationHistory),Math.min(r,1)}detectDocumentType(e,t){const s=e.toLowerCase();if(s.includes("resume")||s.includes("cv"))return d.RESUME;if(s.includes("portfolio")||s.includes("work"))return d.PORTFOLIO;if(s.includes("presentation")||s.includes("pitch")||s.includes("deck")||e.endsWith(".pptx")||e.endsWith(".ppt"))return d.PRESENTATION;if(s.includes("proposal")||s.includes("quote"))return d.PROPOSAL;if(s.includes("case")||s.includes("study"))return d.CASE_STUDY;if(s.includes("price")||s.includes("cost")||s.includes("rate"))return d.PRICING;switch(t){case"sales_pitch":case"sales_call":return d.PRESENTATION;case"interview":return d.RESUME;default:return d.OTHER}}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}async calculateChecksum(e){const t=await e.arrayBuffer(),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}initializeDocumentProcessing(){setInterval((()=>{this.cleanupExpiredCache()}),36e5)}async getSessionDocuments(e){return[]}async storeDocument(e,t){await this.storage.setItem(`${k}:metadata_${e.id}`,e),await this.storage.setItem(`${k}:content_${e.id}`,t)}createDocumentChunks(e){return[]}async extractEntities(e){return[]}async generateSummary(e,t){return""}async extractKeyPoints(e,t){return[]}async parseStructuredData(e,t,s){return{}}calculateDocumentPriority(e,t){return m.MEDIUM}generateTags(e,t){return[]}getDocumentMetadataFromCache(e){}getPriorityWeight(e){return.5}calculateTopicSimilarity(e,t){return.5}calculateEntityOverlap(e,t){return.5}findMatchingChunks(e,t){return[]}generateRelevanceReason(e,t,s){return""}async getDocumentContent(e){}cleanupExpiredCache(){}}class L{providers=new Map;contextManager;documentManager;storage;providerPerformance=new Map;PROVIDER_TIMEOUT=3e4;MAX_RETRIES=2;FALLBACK_CHAIN=["openai","anthropic","gemini"];constructor(){this.contextManager=new O,this.documentManager=new _,this.storage=new v,this.initializeProviders(),this.loadProviderPerformance()}async generateMeetingResponse(e,t,s){try{const n=await this.documentManager.findRelevantDocuments(s,t.callType,3),r=await this.buildContextualPrompt(e,t,s,n.map((e=>e.document))),o=await this.selectOptimalGeneration(r,t.callType,t.tone),i=await this.generateWithFallback(o),a=await this.optimizeResponse(i,t,n.map((e=>e.document)));return await this.updateProviderPerformance(o.provider.name,!0,Date.now()),a}catch(s){return console.error("Meeting response generation failed:",s),this.generateFallbackResponse(e,t.callType,t.tone)}}async generateSuggestions(e,t,s,n=3){const r=[];try{const o=await this.analyzeConversation(e),i=this.determineSuggestionTypes(t,e.meetingPhase,o);for(const o of i.slice(0,n)){const n=await this.generateTypedSuggestion(o,e,t,s);n&&r.push(n)}return r}catch(e){return console.error("Suggestion generation failed:",e),[]}}async buildContextualPrompt(e,t,s,n){const r=c[t.callType],o=l[t.tone],i=n.length>0?this.buildDocumentContext(n,t.callType):"",a=this.buildConversationContext(s.conversationHistory.slice(-10));return`\n${this.buildMeetingInstructions(t,r,o)}\n\nCURRENT MEETING CONTEXT:\n- Call Type: ${t.callType}\n- Tone: ${t.tone}\n- Meeting Phase: ${s.meetingPhase}\n- Participants: ${t.participants.length}\n- Current Topic: ${s.currentTopic}\n\n${i}\n\n${a}\n\nUSER INPUT: "${e}"\n\nPlease provide a response that:\n1. Matches the ${t.tone} tone\n2. Is appropriate for a ${t.callType}\n3. Considers the current meeting phase (${s.meetingPhase})\n4. References relevant information from the provided documents when helpful\n5. Maintains professional standards while being engaging\n\nResponse:`}buildDocumentContext(e,t){if(0===e.length)return"";let s="\nRELEVANT DOCUMENTS:\n";return e.forEach(((e,n)=>{s+=`\nDocument ${n+1}: ${e.id}\nSummary: ${e.summary}\nKey Points: ${e.keyPoints.slice(0,5).join(", ")}\n`,t===i.INTERVIEW&&e.structuredData.personalInfo?s+=`Background: ${JSON.stringify(e.structuredData.personalInfo,null,2)}\n`:t.includes("sales")&&e.structuredData.pricing&&(s+=`Pricing Info: ${JSON.stringify(e.structuredData.pricing,null,2)}\n`)})),s}buildConversationContext(e){if(0===e.length)return"";let t="\nRECENT CONVERSATION:\n";return e.forEach(((e,s)=>{t+=`${e.speaker}: ${e.content}\n`})),t}buildMeetingInstructions(e,t,s){return`You are an AI meeting assistant specialized in ${e.callType} scenarios.\n\nCALL TYPE FOCUS (${e.callType}):\n- Focus Areas: ${t.focusAreas.join(", ")}\n- Response Style: ${t.responseStyle}\n- Priority Level: ${t.priority}\n\nTONE REQUIREMENTS (${e.tone}):\n- Vocabulary: ${s.vocabulary}\n- Sentiment: ${s.sentiment}\n- Structure: ${s.structure}\n- Key Phrases to Use: ${s.phrases.join(", ")}`}async selectOptimalGeneration(e,t,s){const n=this.calculatePromptComplexity(e),r=await this.scoreProviders(t,s,n),o=this.selectBestProvider(r),i=this.determineOptimalParameters(t,s,n);return{prompt:e,provider:o,model:this.selectOptimalModel(o,t),parameters:i}}async scoreProviders(e,t,s){const n=new Map;for(const[r,o]of this.providers){let i=0;i+=this.getProviderCapabilityScore(o,e,t);const a=this.providerPerformance.get(r);a&&(i+=.3*a.successRate,i+=1/Math.max(a.averageLatency,1)*.2,i+=1/Math.max(a.cost,.001)*.1),i+=this.getComplexityScore(o,s),n.set(r,i)}return n}determineOptimalParameters(e,t,s){const n={temperature:.7,maxTokens:500,presencePenalty:0,frequencyPenalty:0,topP:.9,stopSequences:[]};switch(e){case i.INTERVIEW:n.temperature=.5,n.maxTokens=300;break;case i.SALES_PITCH:n.temperature=.8,n.maxTokens=600;break;case i.BRAINSTORMING:n.temperature=.9,n.maxTokens=400}switch(t){case a.FORMAL:n.temperature*=.8;break;case a.CASUAL:n.temperature*=1.1;break;case a.CREATIVE:n.temperature*=1.2}return s>.7&&(n.maxTokens=Math.min(1.5*n.maxTokens,1e3)),n}async generateWithFallback(e){const t={prompt:e.prompt,context:{},callType:i.CLIENT_MEETING,tone:a.PROFESSIONAL,maxTokens:e.parameters.maxTokens,temperature:e.parameters.temperature,presencePenalty:e.parameters.presencePenalty,frequencyPenalty:e.parameters.frequencyPenalty,model:e.model};try{const s=await Promise.race([e.provider.generateCompletion(t),this.createTimeoutPromise(this.PROVIDER_TIMEOUT)]);if(s&&s.content)return s}catch(t){console.warn(`Primary provider ${e.provider.name} failed:`,t)}for(const s of this.FALLBACK_CHAIN){if(s===e.provider.name)continue;const n=this.providers.get(s);if(n)try{const e=await Promise.race([n.generateCompletion(t),this.createTimeoutPromise(this.PROVIDER_TIMEOUT)]);if(e&&e.content)return console.log(`Fallback provider ${s} succeeded`),e}catch(e){console.warn(`Fallback provider ${s} failed:`,e)}}throw new Error("All providers failed to generate response")}async optimizeResponse(e,t,s){const n=e.content||e.text||"",r=this.extractSupportingPoints(n,s),o=this.generateFollowUpQuestions(n,t.callType,t.tone);return{content:n,tone:t.tone,confidence:this.calculateResponseConfidence(e),relevantDocuments:s.map((e=>e.id)),supportingPoints:r,followUpQuestions:o,metadata:{callType:t.callType,responseType:"answer",priority:m.HIGH,timing:"immediate",formality:this.mapToneToFormality(t.tone),length:n.length>200?"detailed":"brief"}}}initializeProviders(){try{this.providers.set("openai",new T("dummy-key")),this.providers.set("anthropic",new C("dummy-key")),this.providers.set("gemini",new P("dummy-key")),console.log(`Initialized ${this.providers.size} AI providers`)}catch(e){console.error("Failed to initialize providers:",e)}}async loadProviderPerformance(){try{const e=await this.storage.getItem("candidai:performance:provider_performance");e&&Object.entries(e).forEach((([e,t])=>{this.providerPerformance.set(e,t)}))}catch(e){console.warn("Failed to load provider performance:",e)}}calculatePromptComplexity(e){return.5}getProviderCapabilityScore(e,t,s){return.7}getComplexityScore(e,t){return.6}selectBestProvider(e){const t=Array.from(e.entries()).reduce(((e,t)=>e[1]>t[1]?e:t))[0];return this.providers.get(t)||this.providers.values().next().value}selectOptimalModel(e,t){return(e.getModels?.()||[])[0]||"default"}createTimeoutPromise(e){return new Promise(((t,s)=>setTimeout((()=>s(new Error("Timeout"))),e)))}calculateResponseConfidence(e){return.8}extractSupportingPoints(e,t){return[]}generateFollowUpQuestions(e,t,s){return[]}mapToneToFormality(e){return"formal"}async updateProviderPerformance(e,t,s){}generateFallbackResponse(e,t,s){return{content:"I'm processing your request. Please give me a moment.",tone:s,confidence:.5,relevantDocuments:[],supportingPoints:[],followUpQuestions:[],metadata:{callType:t,responseType:"answer",priority:m.MEDIUM,timing:"immediate",formality:"formal",length:"brief"}}}async analyzeConversation(e){return{}}determineSuggestionTypes(e,t,s){return[]}async generateTypedSuggestion(e,t,s,n){}}class z{metricsConfig;interviews;aggregateStats;measurements;completedMeasurements;eventLog;errorLog;config;constructor(){this.metricsConfig={speechMetrics:{fillerWords:["um","uh","like","you know","basically","actually","literally"],pacingThresholds:{slow:120,optimal:150,fast:180}},responseMetrics:{optimalLength:{min:30,max:120},starMethodKeywords:["situation","task","action","result"]},engagementMetrics:{questionResponseTime:5e3,followUpIndicators:["elaborate","example","specifically","detail"]}},this.interviews=new Map,this.aggregateStats={totalInterviews:0,averageScore:0,improvementTrend:[],commonWeaknesses:new Map,strongAreas:new Map},this.measurements=new Map,this.completedMeasurements=new Map,this.eventLog=[],this.errorLog=[],this.config={enableRemoteLogging:!1,remoteLoggingEndpoint:"",sampleRate:1},this.loadPersistedData()}startInterview(e,t){const s=t||crypto.randomUUID(),n={id:s,startTime:Date.now(),endTime:null,metadata:{company:e.company||"Unknown",position:e.position||"Unknown",platform:e.platform||"Unknown",...e},transcription:[],questions:[],responses:[],suggestions:[],metrics:null,score:null,insights:null};return this.interviews.set(s,n),s}addTranscription(e,t){const s=this.interviews.get(e);if(!s)return;const n={...t,timestamp:Date.now()};s.transcription.push(n),t.isQuestion&&s.questions.push({text:t.text,timestamp:t.timestamp||Date.now(),type:this.categorizeQuestion(t.text)})}addSuggestion(e,t){const s=this.interviews.get(e);if(!s)return;const n={...t,timestamp:Date.now(),wasUsed:!1};s.suggestions.push(n)}async completeInterview(e){const t=this.interviews.get(e);return t?(t.endTime=Date.now(),t.duration=t.endTime-t.startTime,t.metrics=await this.calculateMetrics(t),t.score=this.calculateOverallScore(t.metrics),t.insights=this.generateInsights(t),this.updateAggregateStats(t),await this.persistInterview(t),{sessionId:e,startTime:t.startTime,endTime:t.endTime,totalDuration:t.duration,measurements:Array.from(this.completedMeasurements.values()),events:this.eventLog,transcriptionCount:t.transcription.length,suggestionCount:t.suggestions.length,averageResponseTime:t.metrics?.timing.averageResponseTime||0,errorCount:this.errorLog.length,errors:this.errorLog,summary:{accuracy:t.metrics?.technical.accuracy,efficiency:t.score||0,userSatisfaction:t.metrics?.engagement.activeListening}}):null}async calculateMetrics(e){return{speech:this.analyzeSpeechPatterns(e),content:this.analyzeResponseContent(e),engagement:this.analyzeEngagement(e),technical:this.analyzeTechnicalAccuracy(e),timing:this.analyzeTimingMetrics(e)}}analyzeSpeechPatterns(e){const t=e.transcription.filter((e=>!e.isQuestion)),s=t.reduce(((e,t)=>e+t.text.split(" ").length),0);let n=0;const r=new Map;t.forEach((e=>{e.text.toLowerCase().split(/\s+/).forEach((e=>{this.metricsConfig.speechMetrics.fillerWords.includes(e)&&(n++,r.set(e,(r.get(e)||0)+1))}))}));const o=s>0?n/s*100:0,i=t.reduce(((e,t)=>e+(t.timestamp||0)),0),a=i>0?s/i*6e4:0;return{fillerCount:n,fillerRate:o,fillerUsage:r,averagePace:a,paceRating:this.ratePace(a),clarity:Math.max(0,100-2*o),confidence:this.calculateConfidenceScore(t)}}analyzeResponseContent(e){const t=e.transcription.filter((e=>!e.isQuestion)),s=t.map((e=>e.text)).join(" ").toLowerCase(),n=this.metricsConfig.responseMetrics.starMethodKeywords.reduce(((e,t)=>e+(s.includes(t)?1:0)),0),r=["for example","for instance","such as","like when"].reduce(((e,t)=>e+(s.includes(t)?1:0)),0);return{starMethodUsage:n/this.metricsConfig.responseMetrics.starMethodKeywords.length*100,responseQuality:this.calculateResponseQuality(t),relevance:this.calculateRelevance(e),specificity:this.calculateSpecificity(t),examples:r}}analyzeEngagement(e){const t=e.transcription.filter((e=>!e.isQuestion)),s=e.questions;let n=0,r=0;for(let e=0;e<s.length&&e<t.length;e++){const o=t[e],i=s[e];if(o&&i){const e=o.timestamp-i.timestamp;n+=e,e>this.metricsConfig.engagementMetrics.questionResponseTime&&r++}}return{averageResponseTime:s.length>0?n/s.length:0,hesitationCount:r,followUpQuestions:this.countFollowUpQuestions(e),activeListening:this.calculateActiveListening(e)}}analyzeTechnicalAccuracy(e){return{accuracy:75,depth:70,terminology:80,problemSolving:65}}analyzeTimingMetrics(e){const t=e.duration||0,s=e.questions.reduce(((e,t)=>e+5e3),0),n=t-s;return{totalDuration:t,questionTime:s,responseTime:n,silenceTime:0,balance:n>0?s/n*100:0,averageResponseTime:n>0?s/n*100:0}}calculateOverallScore(e){return(e.speech.clarity+(100-e.speech.fillerRate))/2*.25+(e.content.responseQuality+e.content.starMethodUsage)/2*.35+.25*Math.max(0,100-10*e.engagement.hesitationCount)+(e.technical.accuracy+e.technical.depth+e.technical.terminology)/3*.15}generateInsights(e){const t=[],s=e.metrics;return s?(s.speech.fillerRate>5&&t.push({type:"weakness",category:"speech",title:"Excessive Filler Words",description:`You used ${s.speech.fillerCount} filler words (${s.speech.fillerRate.toFixed(1)}% of total words). Try to pause instead of using fillers.`,score:100-s.speech.fillerRate,priority:"high",actionable:!0,examples:Array.from(s.speech.fillerUsage.keys()).slice(0,3)}),s.content.starMethodUsage<50&&t.push({type:"improvement",category:"content",title:"STAR Method Usage",description:"Consider using the STAR method (Situation, Task, Action, Result) to structure your behavioral responses.",score:s.content.starMethodUsage,priority:"medium",actionable:!0}),s.engagement.hesitationCount>2&&t.push({type:"weakness",category:"engagement",title:"Response Hesitation",description:`You hesitated before responding ${s.engagement.hesitationCount} times. Practice common interview questions to improve response speed.`,score:Math.max(0,100-20*s.engagement.hesitationCount),priority:"medium",actionable:!0}),t):t}generateReport(e){return{summary:{overallScore:e.score,duration:this.formatDuration(e.duration||0),questionsAnswered:e.questions.length,suggestionsProvided:e.suggestions.length},metrics:e.metrics,insights:e.insights,recommendations:this.generateRecommendations(e)}}generateRecommendations(e){const t=[],s=e.metrics;return s?(s.speech.fillerRate>3&&t.push("Practice speaking more slowly and pause instead of using filler words"),s.content.starMethodUsage<75&&t.push("Structure behavioral responses using the STAR method"),s.engagement.averageResponseTime>8e3&&t.push("Practice common interview questions to reduce response time"),t):t}categorizeQuestion(e){const t=e.toLowerCase();return t.includes("tell me about")||t.includes("describe a time")?"behavioral":t.includes("how would you")||t.includes("what would you do")?"situational":t.includes("culture")||t.includes("team")||t.includes("values")?"cultural":t.includes("technical")||t.includes("code")||t.includes("algorithm")?"technical":"other"}ratePace(e){const t=this.metricsConfig.speechMetrics.pacingThresholds;return e<t.slow?"slow":e>t.fast?"fast":"optimal"}calculateConfidenceScore(e){const t=e.reduce(((e,t)=>e+(t.confidence||0)),0)/e.length,s=e.reduce(((e,t)=>e+t.text.length),0)/e.length;return Math.min(100,100*t+s/50)}calculateResponseQuality(e){const t=e.reduce(((e,t)=>e+t.text.length),0)/e.length;return Math.min(100,t/100*100)}calculateRelevance(e){return 80}calculateSpecificity(e){const t=e.map((e=>e.text)).join(" ").match(/\b\d+\b|[A-Z][a-z]+\s[A-Z][a-z]+|\$\d+|%/g)||[];return Math.min(100,t.length/e.length*20)}countFollowUpQuestions(e){return e.questions.map((e=>e.text.toLowerCase())).filter((e=>this.metricsConfig.engagementMetrics.followUpIndicators.some((t=>e.includes(t))))).length}calculateActiveListening(e){return 75}updateAggregateStats(e){if(this.aggregateStats.totalInterviews++,null!==e.score){const t=(this.aggregateStats.averageScore*(this.aggregateStats.totalInterviews-1)+e.score)/this.aggregateStats.totalInterviews;this.aggregateStats.averageScore=t,this.aggregateStats.improvementTrend.push(e.score)}}formatDuration(e){return`${Math.floor(e/6e4)}m ${Math.floor(e%6e4/1e3)}s`}async persistInterview(e){try{const t=(await chrome.storage.local.get("interview_history")).interview_history||[];t.push({id:e.id,date:new Date(e.startTime).toISOString(),score:e.score,insights:e.insights?.length||0,company:e.metadata.company,position:e.metadata.position}),await chrome.storage.local.set({interview_history:t})}catch(e){console.error("Failed to persist interview:",e)}}async loadPersistedData(){try{const e=await chrome.storage.local.get(["interview_history","aggregate_stats"]);e.aggregate_stats&&Object.assign(this.aggregateStats,e.aggregate_stats)}catch(e){console.error("Failed to load persisted data:",e)}}startMeasurement(e){const t={name:e,startTime:performance.now()};this.measurements.set(e,t)}endMeasurement(e){const t=this.measurements.get(e);if(!t)return null;const s=performance.now(),n={...t,endTime:s,duration:s-t.startTime};return this.measurements.delete(e),this.completedMeasurements.set(e,n),n}getMeasurement(e){return this.completedMeasurements.get(e)||null}isMeasuring(e){return this.measurements.has(e)}logEvent(e,t={}){if(Math.random()>this.config.sampleRate)return;const s={type:e,timestamp:Date.now(),data:t};this.eventLog.push(s),this.eventLog.length>1e3&&this.eventLog.splice(0,100)}logError(e,t,s={}){const n={name:e,message:t.message,stack:t.stack,timestamp:Date.now(),context:s};this.errorLog.push(n),this.errorLog.length>100&&this.errorLog.splice(0,10)}getEventLog(){return[...this.eventLog]}getErrorLog(){return[...this.errorLog]}clearLogs(){this.eventLog.length=0,this.errorLog.length=0,this.completedMeasurements.clear()}}new class{messageBroker;storage;llmOrchestrator;contextManager;performanceAnalyzer;activeInterviews=new Map;offscreenDocuments=new Map;sidePanelStates=new Map;sidePanelPorts=new Map;config=null;constructor(){this.messageBroker=new g,this.storage=new v,this.llmOrchestrator=new L,this.contextManager=new O,this.performanceAnalyzer=new z,this.initialize().catch((e=>{console.error("ServiceWorkerOrchestrator initialization failed:",e)}))}async initialize(){try{this.initializeEventHandlers(),this.performanceAnalyzer.startMeasurement("sw_initialization")}catch(e){console.error("Event handler initialization failed:",e)}try{await this.initializeOffscreenCapabilities()}catch(e){console.error("Offscreen capabilities initialization failed:",e)}try{await this.loadConfiguration()}catch(e){console.error("Configuration loading failed:",e)}if(this.performanceAnalyzer.isMeasuring("sw_initialization")){this.performanceAnalyzer.endMeasurement("sw_initialization");const e=this.performanceAnalyzer.getMeasurement("sw_initialization");e&&console.log(`Service Worker Initialization Time: ${e.duration}ms`)}}async loadConfiguration(){try{const t=await this.storage.get(e);this.config=t??o,console.log("Configuration loaded:",this.config),this.performanceAnalyzer.logEvent("configuration_loaded",{hasStoredConfig:Boolean(t)})}catch(e){console.error("Failed to load configuration, using defaults:",e),this.config=o,this.performanceAnalyzer.logError("configuration_load_failed",e)}}initializeEventHandlers(){chrome.runtime.onInstalled.addListener(this.handleInstallation.bind(this)),chrome.runtime.onStartup.addListener(this.handleStartup.bind(this)),chrome.runtime.onMessage.addListener(this.handleMessage.bind(this)),chrome.runtime.onConnect.addListener(this.handleConnection.bind(this)),chrome.action.onClicked.addListener(this.handleActionClick.bind(this)),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch((e=>{console.error("Side panel configuration failed:",e)}))}async handleInstallation(t){console.log("CandidAI Extension installed:",t),await this.storage.initialize({[e]:o}),"install"===t.reason&&chrome.runtime.openOptionsPage()}async handleStartup(){console.log("CandidAI Service Worker starting up");try{const e=await this.storage.getState();e?.[t]&&await this.resumeInterviewSession(e[t]),this.performanceAnalyzer.logEvent("service_worker_startup_success")}catch(e){console.error("State restoration failed during startup:",e),this.performanceAnalyzer.logError("service_worker_startup_failure",e)}}async handleMessage(e,t,s){const{command:n,payload:r}=e,o=`message_${n}_${Date.now()}`;this.performanceAnalyzer.startMeasurement(o);try{let e;switch(n){case"init_interview_session":e=await this.initializeInterviewSession(r?.metadata,r?.tabId),s({success:!0,data:e});break;case"process_transcription":e=await this.processTranscription(r?.sessionId,r?.transcriptionData),s({success:!0,data:e});break;case"end_interview_session":e=await this.endInterviewSession(r?.sessionId),s("ENDED"===e?.finalState?{success:!0,data:e}:{success:!1,error:e?.error||"Failed to end interview session",data:e});break;case"update_context":await this.contextManager.updateContext(r),s({success:!0});break;case"TEST_LLM_CONNECTION":e=await this.testLLMConnection(r?.provider),s(e);break;case"TEST_PLATFORM_DETECTION":e=await this.testPlatformDetection(r?.url),s(e);break;case"ping":s({success:!0,message:"CandidAI extension is running"});break;case"capture_visual":e=await this.captureAndAnalyzeVisual(r),s({success:!0,data:e});break;case"get_app_state":e={activeInterviewsCount:this.activeInterviews.size},s({success:!0,data:e});break;default:console.warn("Unknown command received:",n),s({success:!1,error:"Unknown command",details:`Command not recognized: ${n}`})}}catch(e){const t=e instanceof Error?e.message:"Unknown error",r=e instanceof Error?e.stack:void 0;console.error(`Error handling command ${n}:`,e),s({success:!1,error:t,details:r}),this.performanceAnalyzer.logError(`command_error_${n}`,e)}finally{this.performanceAnalyzer.endMeasurement(o);const e=this.performanceAnalyzer.getMeasurement(o);e&&console.log(`Command ${n} processed in ${e.duration}ms`)}return!0}async initializeOffscreenCapabilities(){if(0===(await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[chrome.runtime.getURL(s)]})).length)try{await chrome.offscreen.createDocument({url:s,reasons:n,justification:"Recording audio for AI-powered meeting assistance and transcription"}),console.log("Offscreen document created successfully."),this.performanceAnalyzer.logEvent("offscreen_document_created")}catch(e){console.error("Failed to create offscreen document:",e),this.performanceAnalyzer.logError("offscreen_creation_failure",e)}else console.log("Offscreen document already exists."),this.performanceAnalyzer.logEvent("offscreen_document_existed")}async initializeInterviewSession(e,t){const s=crypto.randomUUID(),n={sessionId:s,callType:e?.callType??"interview",participantCount:e?.participantCount??1,documentCount:e?.documentCount??0,duration:0,platform:e?.platform??"unknown",createdAt:new Date,lastAccessed:new Date,encrypted:!0,retentionPolicy:"standard",tabId:t,initiatedTs:Date.now(),uiConnected:!0,...e},r={sessionId:s,callType:n.callType,tone:"professional",documents:[],participants:[],conversation:[],detectedEntities:{},currentObjectives:[],performanceMetrics:{responseTime:0,accuracy:0,relevanceScore:0,documentsProcessed:0,suggestionsProvided:0,successfulInteractions:0},createdAt:new Date,lastUpdated:new Date,platform:n.platform,state:"active"};this.activeInterviews.set(s,r),this.performanceAnalyzer.startInterview(n,s);try{await chrome.runtime.sendMessage({target:"offscreen",command:"start_audio_capture",sessionId:s}),this.performanceAnalyzer.logEvent("interview_session_initialized",{sessionId:s})}catch(e){console.error(`Failed to send START_AUDIO_CAPTURE to offscreen for session ${s}:`,e),this.performanceAnalyzer.logError("start_audio_capture_failed",{sessionId:s,error:e}),r.state="paused"}return r}handleConnection(e){if(console.log("New connection established:",e.name,e.sender),this.performanceAnalyzer.logEvent("port_connection_established",{portName:e.name,tabId:e.sender?.tab?.id}),"side_panel"===e.name&&e.sender?.tab?.id){const t=e.sender.tab.id;this.sidePanelPorts.set(t,e),console.log(`[Connection] Side panel port for tab ${t} stored.`),this.performanceAnalyzer.logEvent("sidepanel_port_stored",{tabId:t});try{e.postMessage({command:"service_worker_ready",payload:{status:"connected",serviceWorkerVersion:chrome.runtime.getManifest().version}}),this.performanceAnalyzer.logEvent("service_worker_ready_sent_to_panel",{tabId:t})}catch(e){console.warn(`[Connection] Failed to send SERVICE_WORKER_READY to side panel for tab ${t}:`,e),this.performanceAnalyzer.logError("service_worker_ready_send_failed",e,{tabId:t})}}const t=async t=>{console.log("Message received on port:",e.name,t),this.performanceAnalyzer.logEvent("port_message_received",{portName:e.name,command:t?.command}),await this.handlePortMessage(e,t)},s=()=>{console.log("Port disconnected:",e.name),this.performanceAnalyzer.logEvent("port_disconnected",{portName:e.name}),e.onMessage.removeListener(t),e.onDisconnect.removeListener(s),this.cleanupPortResources(e)};e.onMessage.addListener(t),e.onDisconnect.addListener(s)}async handlePortMessage(e,t){console.log("Handling port message:",e.name,t)}cleanupPortResources(e){console.log("Cleaning up port resources:",e.name)}async handleActionClick(e){console.log("Action clicked for tab:",e)}async resumeInterviewSession(e){console.log("Resuming interview session:",e)}async processTranscription(e,t){return console.log("Processing transcription:",e,t),{content:"Placeholder response",tone:"professional",confidence:.8,relevantDocuments:[],supportingPoints:[],followUpQuestions:[],metadata:{callType:"interview",responseType:"answer",priority:"medium",timing:"immediate",length:"brief"}}}async endInterviewSession(e){return console.log("Ending interview session:",e),{finalState:"ENDED"}}async captureAndAnalyzeVisual(e){return console.log("Capturing and analyzing visual:",e),{}}async testLLMConnection(e){return console.log("Testing LLM connection:",e),{success:!0}}async testPlatformDetection(e){return console.log("Testing platform detection:",e),{success:!0}}}})();