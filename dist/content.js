(()=>{"use strict";class e{constructor(){this.platform="google-meet",this.supportedDomains=["meet.google.com"],this.selectors={meetingId:"[data-meeting-code]",participantsList:'[role="list"][aria-label*="participant"]',selfVideo:"[data-self-video]",micButton:'[data-is-muted][aria-label*="microphone"]',cameraButton:'[data-is-muted][aria-label*="camera"]',captionsButton:'[aria-label*="captions"]',presentButton:'[aria-label*="present"]',chatPanel:'[aria-label*="chat"]',meetingTitle:"h1[data-meeting-title]",timer:'[jsname="r4nke"]'},this.state={isInMeeting:!1,meetingId:null,participants:[],isMuted:!1,isCameraOff:!1,startTime:null},this.mutationObserver=null,this.eventHandlers=new Map}async initialize(){return console.log("Initializing Google Meet adapter"),await this.waitForMeetUI(),this.setupMutationObserver(),await this.extractMetadata(),this.setupEventListeners(),!0}async waitForMeetUI(e=1e4){const t=Date.now();for(;Date.now()-t<e;){if(document.querySelector("[data-call-controls]"))return!0;await this.delay(500)}throw new Error("Google Meet UI not detected within timeout")}setupMutationObserver(){this.mutationObserver=new MutationObserver((e=>{this.handleMutations(e)})),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-participant-id","data-is-muted","aria-label"]})}handleMutations(e){let t=!1;for(const n of e)n.target.matches?.(this.selectors.participantsList)&&(t=!0),"data-is-muted"===n.attributeName&&this.updateMuteState(),n.removedNodes.length>0&&Array.from(n.removedNodes).some((e=>e.querySelector?.("[data-call-controls]")))&&this.handleMeetingEnd();t&&this.extractMetadata()}async isInVideoCall(){const e=document.querySelector("[data-call-controls]"),t=document.querySelector(this.selectors.participantsList);return this.state.isInMeeting=!(!e||!t),this.state.isInMeeting}async extractMetadata(){const e={platform:this.platform,meetingId:this.getMeetingId(),meetingTitle:this.getMeetingTitle(),participants:await this.getParticipants(),duration:this.getMeetingDuration(),isMuted:this.state.isMuted,isCameraOff:this.state.isCameraOff,timestamp:Date.now()};return Object.assign(this.state,e),e}getMeetingId(){const e=document.querySelector(this.selectors.meetingId);if(e instanceof HTMLElement)return e.dataset.meetingCode;const t=window.location.pathname.match(/\/([a-z]{3}-[a-z]{4}-[a-z]{3})/);return t?t[1]:null}getMeetingTitle(){const e=document.querySelector(this.selectors.meetingTitle);return e?e.textContent.trim():"Google Meet"}async getParticipants(){const e=[];return document.querySelectorAll("[data-participant-id]").forEach((t=>{const n=t.querySelector("[data-name]"),s=(n instanceof HTMLElement&&n.dataset,t instanceof HTMLElement?t.dataset?.participantId:""),i=t.hasAttribute("data-self-participant");e.push({id:s,name:n instanceof HTMLElement?n.dataset?.originalTitle||n.textContent?.trim():"",isSelf:i,isMuted:null!==t.querySelector('[data-is-muted="true"]')})})),e}getMeetingDuration(){const e=document.querySelector(this.selectors.timer);if(e)return e.textContent.trim();if(this.state.startTime){const e=Date.now()-this.state.startTime;return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`}return null}async extractPageContext(){return{url:window.location.href,title:document.title,metadata:await this.extractMetadata(),chat:this.extractChatMessages(),captions:this.extractCaptions()}}extractChatMessages(){const e=[],t=document.querySelector(this.selectors.chatPanel);return t&&t.querySelectorAll("[data-message-text]").forEach((t=>{e.push({sender:t.querySelector("[data-sender-name]")?.textContent||"Unknown",text:t.querySelector("[data-message-text]")?.textContent||"",timestamp:t.querySelector("[data-timestamp]")?.textContent||""})})),e}extractCaptions(){const e=[];return document.querySelectorAll("[data-caption-text]").forEach((t=>{e.push({text:t.textContent,speaker:t instanceof HTMLElement&&t.dataset.speaker||"Unknown"})})),e}setupEventListeners(){const e=document.querySelector(this.selectors.micButton);e&&e.addEventListener("click",(()=>{setTimeout((()=>this.updateMuteState()),100)})),!this.state.isInMeeting&&this.isInVideoCall()&&this.handleMeetingStart()}updateMuteState(){const e=document.querySelector(this.selectors.micButton);e instanceof HTMLElement&&(this.state.isMuted="true"===e.dataset.isMuted,chrome.runtime.sendMessage({command:"MUTE_STATE_CHANGED",payload:{platform:this.platform,isMuted:this.state.isMuted}}))}handleMeetingStart(){this.state.startTime=Date.now(),this.state.isInMeeting=!0,chrome.runtime.sendMessage({command:"MEETING_STARTED",payload:{platform:this.platform,meetingId:this.state.meetingId,timestamp:this.state.startTime}})}handleMeetingEnd(){const e=Date.now()-(this.state.startTime||Date.now());chrome.runtime.sendMessage({command:"MEETING_ENDED",payload:{platform:this.platform,meetingId:this.state.meetingId,duration:e,timestamp:Date.now()}}),this.state.isInMeeting=!1,this.state.meetingId=null,this.state.startTime=null}onVideoCallStateChange(e){this.eventHandlers.set("videoCallStateChange",e)}async injectUI(e){console.log("GoogleMeet UI injection not yet implemented")}cleanup(){this.mutationObserver&&this.mutationObserver.disconnect(),this.eventHandlers.clear()}delay(e){return new Promise((t=>setTimeout(t,e)))}}class t{constructor(){this.platform="zoom",this.supportedDomains=["zoom.us"],this.selectors={meetingInfo:".meeting-info",participantsList:'[aria-label="Participants"]',muteButton:'[aria-label*="mute"]',videoButton:'[aria-label*="video"]',chatPanel:".chat-container"},this.state={isInMeeting:!1,meetingId:null}}async initialize(){return console.log("Initializing Zoom adapter"),!0}async isInVideoCall(){const e=document.querySelector(".meeting-client");return this.state.isInMeeting=!!e,this.state.isInMeeting}async extractMetadata(){return{platform:this.platform,meetingId:this.getMeetingId(),participants:[],timestamp:Date.now()}}getMeetingId(){const e=window.location.pathname.match(/\/wc\/(\d+)/);return e?e[1]:null}async extractPageContext(){return{url:window.location.href,platform:this.platform,metadata:await this.extractMetadata()}}onVideoCallStateChange(e){console.log("Zoom state monitoring registered")}cleanup(){console.log("Zoom adapter cleanup")}}class n{constructor(){this.platform="microsoft-teams",this.supportedDomains=["teams.microsoft.com"],this.state={isInMeeting:!1}}async initialize(){return console.log("Initializing Teams adapter"),!0}async isInVideoCall(){const e=document.querySelector('[data-tid="call-controls"]');return this.state.isInMeeting=!!e,this.state.isInMeeting}async extractMetadata(){return{platform:this.platform,timestamp:Date.now()}}async extractPageContext(){return{platform:this.platform}}onVideoCallStateChange(e){console.log("MicrosoftTeams state monitoring registered")}cleanup(){console.log("Teams adapter cleanup")}}class s{constructor(){this.platform="linkedin",this.supportedDomains=["linkedin.com"],this.state={isInMeeting:!1}}async initialize(){return console.log("Initializing LinkedIn adapter"),!0}async isInVideoCall(){const e=document.querySelector(".video-call-container, [data-test-video-call]");return this.state.isInMeeting=!!e,this.state.isInMeeting}async extractMetadata(){const e=document.querySelector(".job-title")?.textContent,t=document.querySelector(".company-name")?.textContent;return{platform:this.platform,jobTitle:e,company:t,timestamp:Date.now()}}async extractPageContext(){return{platform:this.platform,metadata:await this.extractMetadata()}}onVideoCallStateChange(e){console.log("LinkedIn state monitoring registered")}cleanup(){console.log("LinkedIn adapter cleanup")}}class i{constructor(){this.platform="hirevue",this.supportedDomains=["hirevue.com"],this.state={isInMeeting:!1}}async initialize(){return console.log("Initializing HireVue adapter"),!0}async isInVideoCall(){const e=document.querySelector('.interview-container, [data-testid="video-interview"]');return this.state.isInMeeting=!!e,this.state.isInMeeting}async extractMetadata(){const e=document.querySelector(".question-number")?.textContent,t=document.querySelector(".timer")?.textContent;return{platform:this.platform,questionNumber:e,timeRemaining:t,isRecording:!!document.querySelector(".recording-indicator"),timestamp:Date.now()}}async extractPageContext(){return{platform:this.platform,metadata:await this.extractMetadata()}}onVideoCallStateChange(e){console.log("HireVue state monitoring registered")}cleanup(){console.log("HireVue adapter cleanup")}}const a=("undefined"!=typeof chrome&&chrome.offscreen&&(chrome.offscreen.Reason.USER_MEDIA,chrome.offscreen.Reason.AUDIO_PLAYBACK),{OPENAI:{name:"OpenAI",baseUrl:"https://api.openai.com/v1",models:["gpt-4","gpt-4-turbo","gpt-3.5-turbo"],maxTokens:4096,rateLimits:{requestsPerMinute:60,tokensPerMinute:9e4,dailyLimit:1e6}},ANTHROPIC:{name:"Anthropic",baseUrl:"https://api.anthropic.com/v1",models:["claude-3-opus","claude-3-sonnet","claude-3-haiku"],maxTokens:4096,rateLimits:{requestsPerMinute:50,tokensPerMinute:4e4,dailyLimit:5e5}},GOOGLE:{name:"Google",baseUrl:"https://generativelanguage.googleapis.com/v1",models:["gemini-pro","gemini-pro-vision"],maxTokens:2048,rateLimits:{requestsPerMinute:60,tokensPerMinute:32e3,dailyLimit:1e6}}}),o=(a.OPENAI.baseUrl,a.OPENAI.rateLimits,a.ANTHROPIC.baseUrl,a.ANTHROPIC.rateLimits,"interview"),r="meeting",c="presentation",l="training",d="professional",u="casual",h="formal",p="friendly",m={[o]:{name:"Interview",description:"One-on-one interview session",suggestedTone:d,features:["transcription","suggestions","document_analysis"]},[r]:{name:"Meeting",description:"Team meeting or group discussion",suggestedTone:d,features:["transcription","action_items","summary"]},[c]:{name:"Presentation",description:"Presentation or demo session",suggestedTone:h,features:["visual_analysis","audience_feedback"]},[l]:{name:"Training",description:"Training or educational session",suggestedTone:p,features:["knowledge_base","q_and_a"]}},g={[d]:{name:"Professional",description:"Formal business communication",style:"structured",vocabulary:"business"},[u]:{name:"Casual",description:"Relaxed conversational style",style:"informal",vocabulary:"everyday"},[h]:{name:"Formal",description:"Academic or official communication",style:"precise",vocabulary:"formal"},[p]:{name:"Friendly",description:"Warm and approachable communication",style:"conversational",vocabulary:"accessible"}},y=["pdf","docx","txt","md","doc","rtf"],f="resume",w="other",S="candidai:preferences",v="candidai:resume",T="candidai:context";class C{encryptionConfig;cache;encryptionKey;isInitialized;constructor(){this.encryptionConfig={algorithm:"AES-GCM",keyLength:256,ivLength:12,saltLength:16,iterations:1e5},this.cache=new Map,this.encryptionKey=null,this.isInitialized=!1}async ensureEncryptionInitialized(){this.isInitialized||(await this.initializeEncryption(),this.isInitialized=!0)}async initializeEncryption(){try{const e=await this.getStoredKey();e?this.encryptionKey=e:(this.encryptionKey=await this.generateEncryptionKey(),await this.storeEncryptionKey(this.encryptionKey))}catch(e){console.error("Encryption initialization failed:",e),this.encryptionKey=null}}async generateEncryptionKey(){return await crypto.subtle.generateKey({name:"AES-GCM",length:this.encryptionConfig.keyLength},!0,["encrypt","decrypt"])}async storeEncryptionKey(e){try{const t={key:await crypto.subtle.exportKey("jwk",e),algorithm:this.encryptionConfig.algorithm,created:Date.now()};await chrome.storage.local.set({"candidai:encryptionKey":t})}catch(e){throw console.error("Failed to store encryption key:",e),e}}async getStoredKey(){try{const e=await chrome.storage.local.get("candidai:encryptionKey");if(!e["candidai:encryptionKey"])return null;const t=e["candidai:encryptionKey"];return await crypto.subtle.importKey("jwk",t.key,{name:this.encryptionConfig.algorithm,length:this.encryptionConfig.keyLength},!0,["encrypt","decrypt"])}catch(e){return console.error("Failed to retrieve encryption key:",e),null}}async set(e,t,n={}){try{await this.ensureEncryptionInitialized();const s=`${n.namespace||S}:${e}`,i=JSON.stringify(t);let a;a=this.encryptionKey&&!1!==n.encrypt?await this.encryptData(i):{encrypted:!1,data:i,timestamp:Date.now()},await chrome.storage.local.set({[s]:a}),this.cache.set(s,t)}catch(t){throw console.error("Storage operation failed:",t),new Error(`Failed to store data for key: ${e}`)}}async get(e,t={}){try{await this.ensureEncryptionInitialized();const n=`${t.namespace||S}:${e}`;if(this.cache.has(n))return this.cache.get(n);const s=(await chrome.storage.local.get(n))[n];if(!s)return null;if(t.ttl&&s.timestamp&&Date.now()-s.timestamp>t.ttl)return await this.remove(e,t),null;let i;if(s.encrypted&&this.encryptionKey){const e=await this.decryptData(s);i=JSON.parse(e)}else i=JSON.parse(s.data);return this.cache.set(n,i),i}catch(e){return console.error("Storage retrieval failed:",e),null}}async remove(e,t={}){try{const n=`${t.namespace||S}:${e}`;await chrome.storage.local.remove(n),this.cache.delete(n)}catch(t){throw console.error("Storage removal failed:",t),new Error(`Failed to remove data for key: ${e}`)}}async clear(){try{await chrome.storage.local.clear(),this.cache.clear()}catch(e){throw console.error("Storage clear failed:",e),e}}async getAllKeys(){try{const e=await chrome.storage.local.get();return Object.keys(e)}catch(e){return console.error("Failed to get all keys:",e),[]}}async encrypt(e){if(await this.ensureEncryptionInitialized(),!this.encryptionKey)throw new Error("Encryption key not available");const t=JSON.stringify(e),n=await this.encryptData(t);return JSON.stringify(n)}async decrypt(e){if(await this.ensureEncryptionInitialized(),!this.encryptionKey)throw new Error("Encryption key not available");const t=JSON.parse(e),n=await this.decryptData(t);return JSON.parse(n)}async encryptData(e){if(!this.encryptionKey)throw new Error("Encryption key not available");const t=crypto.getRandomValues(new Uint8Array(this.encryptionConfig.ivLength)),n=(new TextEncoder).encode(e),s=await crypto.subtle.encrypt({name:this.encryptionConfig.algorithm,iv:t},this.encryptionKey,n);return{encrypted:!0,data:this.arrayBufferToBase64(s),iv:this.arrayBufferToBase64(t),algorithm:this.encryptionConfig.algorithm,timestamp:Date.now()}}async decryptData(e){if(!this.encryptionKey)throw new Error("Encryption key not available");if(!e.iv)throw new Error("Missing IV for decryption");const t=this.base64ToArrayBuffer(e.data),n=this.base64ToArrayBuffer(e.iv),s=await crypto.subtle.decrypt({name:this.encryptionConfig.algorithm,iv:n},this.encryptionKey,t);return(new TextDecoder).decode(s)}async batchSet(e,t={}){const n=e.map((async e=>{const n={...t,...e.options};await this.set(e.key,e.value,n)}));await Promise.all(n)}async clearNamespace(e){try{const t=await chrome.storage.local.get(),n=Object.keys(t).filter((t=>t.startsWith(e)));n.length>0&&(await chrome.storage.local.remove(n),n.forEach((e=>this.cache.delete(e))))}catch(e){throw console.error("Failed to clear namespace:",e),e}}async getNamespaceKeys(e){try{const t=await chrome.storage.local.get();return Object.keys(t).filter((t=>t.startsWith(e))).map((t=>t.replace(`${e}:`,"")))}catch(e){return console.error("Failed to get namespace keys:",e),[]}}async initialize(e){try{await this.ensureEncryptionInitialized();for(const[t,n]of Object.entries(e))null===await this.get(t)&&await this.set(t,n)}catch(e){throw console.error("Storage initialization failed:",e),e}}async getState(){try{const e=await chrome.storage.local.get(),t={};for(const[n,s]of Object.entries(e))if(n.startsWith("candidai:")){const e=s;let i;i=e.encrypted&&this.encryptionKey?JSON.parse(await this.decryptData(e)):JSON.parse(e.data),t[n]=i}return t}catch(e){return console.error("Failed to get application state:",e),{}}}arrayBufferToBase64(e){const t=new Uint8Array(e);let n="";for(let e=0;e<t.byteLength;e++){const s=t[e];void 0!==s&&(n+=String.fromCharCode(s))}return btoa(n)}base64ToArrayBuffer(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n.buffer}getCacheStats(){return{size:this.cache.size,keys:Array.from(this.cache.keys())}}clearCache(){this.cache.clear()}async getItem(e){return this.get(e)}async setItem(e,t){await this.set(e,t)}async removeItem(e){await this.remove(e)}async getMultiple(e){const t={};for(const n of e){const e=await this.get(n);null!==e&&(t[n]=e)}return t}async setMultiple(e){for(const[t,n]of Object.entries(e))await this.set(t,n)}async setEncrypted(e,t){const n=await this.encrypt(t);await this.set(e,n)}async getEncrypted(e){const t=await this.get(e);if(!t)return null;try{return await this.decrypt(t)}catch(e){return console.error("Failed to decrypt data:",e),null}}}const x=["JavaScript","TypeScript","Python","Java","C++","C#","Go","Rust","Swift","Kotlin","PHP","Ruby","Scala","Perl","R","MATLAB","Objective-C","Dart","Lua","Haskell","HTML","CSS","React","Angular","Vue.js","Node.js","Express","Django","Flask","Spring","Bootstrap","jQuery","SASS","SCSS","Webpack","Vite","Next.js","Nuxt.js","MySQL","PostgreSQL","MongoDB","Redis","SQLite","Oracle","SQL Server","DynamoDB","Cassandra","Neo4j","InfluxDB","Elasticsearch","Firebase","Supabase","AWS","Azure","GCP","Docker","Kubernetes","Jenkins","GitLab CI","GitHub Actions","Terraform","Ansible","Puppet","Chef","Vagrant","Nginx","Apache","Linux","Ubuntu","Git","SVN","JIRA","Confluence","Slack","Teams","Figma","Adobe XD","Sketch","IntelliJ","VSCode","Eclipse","Xcode","Android Studio","Postman","Insomnia","React Native","Flutter","Xamarin","Ionic","Cordova","iOS","Android","Swift UI","TensorFlow","PyTorch","Scikit-learn","Pandas","NumPy","Matplotlib","Seaborn","Jupyter","Apache Spark","Hadoop","Tableau","Power BI","D3.js","Plotly","Jest","Mocha","Jasmine","Cypress","Selenium","Playwright","JUnit","TestNG","PyTest","RSpec","PHPUnit","Karma","Protractor"],b=["Leadership","Team Management","Project Management","Communication","Problem Solving","Critical Thinking","Analytical Skills","Creativity","Innovation","Adaptability","Time Management","Organization","Collaboration","Mentoring","Training","Strategic Planning","Decision Making","Conflict Resolution","Negotiation","Public Speaking","Presentation Skills","Customer Service","Sales","Marketing"],k=["AWS Certified","Azure Certified","Google Cloud","PMP","Scrum Master","CISSP","CISA","CISM","CompTIA","Cisco","Microsoft Certified","Oracle Certified","Salesforce Certified","Six Sigma","ITIL","PMI","CPA","CFA","FRM"];class E{parseResume(e){const t=this.cleanText(e),n=this.extractContactInfo(t),s=this.extractSkills(t),i=this.extractExperience(t),a=this.extractEducation(t),o=this.extractSummary(t),r=this.calculateExtractionQuality(n,s,i,a,t);return{contact:n,skills:s,experience:i,education:a,summary:o,fullText:t,wordCount:t.split(/\s+/).length,extractionQuality:r}}cleanText(e){return e.replace(/\r\n/g,"\n").replace(/\r/g,"\n").replace(/\n{3,}/g,"\n\n").replace(/\s+/g," ").trim()}extractContactInfo(e){const t={},n=e.match(/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g);n&&(t.email=n[0]);const s=e.match(/(?:\+?1[-.\s]?)?(?:\(?[0-9]{3}\)?[-.\s]?)?[0-9]{3}[-.\s]?[0-9]{4}/g);s&&(t.phone=s[0].replace(/\D+/g,"").replace(/^1/,""));const i=e.match(/(?:linkedin\.com\/in\/|linkedin\.com\/profile\/view\?id=)([a-zA-Z0-9\-]+)/i);i&&(t.linkedin=`https://linkedin.com/in/${i[1]}`);const a=e.match(/(?:github\.com\/|github:\/\/)([a-zA-Z0-9\-]+)/i);a&&(t.github=`https://github.com/${a[1]}`);const o=e.match(/(?:https?:\/\/)?(?:www\.)?([a-zA-Z0-9\-]+\.[a-zA-Z]{2,})/g);if(o){const e=o.filter((e=>!e.includes("linkedin.com")&&!e.includes("github.com")&&!e.includes("@")));e.length>0&&(t.website=e[0].startsWith("http")?e[0]:`https://${e[0]}`)}return t}extractSkills(e){const t=new Set,n=new Set,s=new Set,i=e.toLowerCase();return x.forEach((e=>{const n=e.toLowerCase();i.includes(n)&&t.add(e)})),b.forEach((e=>{const t=e.toLowerCase();i.includes(t)&&n.add(e)})),k.forEach((e=>{const t=e.toLowerCase();i.includes(t)&&s.add(e)})),this.extractSkillSections(e).forEach((e=>{e.split(/[,;|\n]+/).map((e=>e.trim())).filter((e=>e.length>1)).forEach((e=>{e.length>2&&e.length<30&&this.isTechnicalTerm(e)&&t.add(e)}))})),{technical:Array.from(t).sort(),soft:Array.from(n).sort(),certifications:Array.from(s).sort()}}extractSkillSections(e){const t=[],n=["skills","technical skills","core competencies","technologies","programming languages","software","tools","expertise"],s=e.split("\n");let i="",a=!1;for(let e=0;e<s.length;e++){const o=s[e].trim().toLowerCase();if(n.some((e=>o.includes(e)&&o.length<50)))i&&t.push(i),i="",a=!0;else{if(a&&o.length>0&&!o.includes(",")&&!o.includes("•")&&["experience","work history","employment","education","projects","achievements","awards","certifications"].some((e=>o.includes(e)))){i&&t.push(i),a=!1,i="";continue}a&&(i+=s[e]+"\n")}}return i&&t.push(i),t}isTechnicalTerm(e){return[/\.(js|ts|py|java|cpp|cs|go|rs|swift|kt|php|rb)$/i,/^[A-Z]{2,6}$/,/\d+\.\d+/,/[A-Z][a-z]+[A-Z]/].some((t=>t.test(e)))||e.includes(".")||e.includes("#")||e.includes("+")}extractExperience(e){const t=[];return this.extractSectionsByHeaders(e,["experience","work experience","professional experience","employment history","career history","work history"]).forEach((e=>{const n=this.parseExperienceSection(e);t.push(...n)})),t}parseExperienceSection(e){const t=[],n=e.split("\n").filter((e=>e.trim().length>0));let s=null;for(const e of n){const n=e.trim();if(this.looksLikeJobTitle(n))s&&s.company&&s.position&&t.push(s),s=this.parseJobTitleLine(n);else if(s){const e=this.extractDates(n);e.startDate||e.endDate?(s.startDate=e.startDate,s.endDate=e.endDate,s.duration=n):(s.description||(s.description=""),s.description+=n+"\n",(n.startsWith("•")||n.startsWith("-"))&&(s.responsibilities||(s.responsibilities=[]),s.responsibilities.push(n.substring(1).trim())))}}return s&&s.company&&s.position&&t.push(s),t}looksLikeJobTitle(e){return[/\b(developer|engineer|manager|analyst|specialist|coordinator|assistant|director|lead|senior|junior)\b/i,/\b(software|web|mobile|full.?stack|front.?end|back.?end|data|product|project)\b/i,/\bat\s+\w+/i,/\w+\s*[-–—]\s*\w+/].some((t=>t.test(e)))&&e.length<100}parseJobTitleLine(e){const t=[/^(.+?)\s+at\s+(.+)$/i,/^(.+?)\s*[-–—]\s*(.+)$/,/^(.+?),\s*(.+)$/];for(const n of t){const t=e.match(n);if(t){const[,e,n]=t;return e.length<n.length?{position:e.trim(),company:n.trim()}:{company:e.trim(),position:n.trim()}}}return{position:e.trim(),company:"Unknown"}}extractDates(e){const t=[/(\w+\s+\d{4})\s*[-–—]\s*(\w+\s+\d{4}|present|current)/i,/(\d{1,2}\/\d{4})\s*[-–—]\s*(\d{1,2}\/\d{4}|present|current)/i,/(\d{4})\s*[-–—]\s*(\d{4}|present|current)/i];for(const n of t){const t=e.match(n);if(t)return{startDate:t[1],endDate:"present"===t[2].toLowerCase()||"current"===t[2].toLowerCase()?"Present":t[2]}}return{}}extractEducation(e){const t=this.extractSectionsByHeaders(e,["education","academic background","qualifications"]),n=[];return t.forEach((e=>{const t=this.parseEducationSection(e);n.push(...t)})),n}parseEducationSection(e){const t=[],n=e.split("\n").filter((e=>e.trim().length>0));for(const e of n){const n=e.trim().match(/(bachelor|master|phd|doctorate|associate|certificate|diploma).+?(?:in|of)\s+(.+?)(?:from|at)\s+(.+)/i);n&&t.push({degree:n[1],field:n[2],institution:n[3]})}return t}extractSummary(e){const t=this.extractSectionsByHeaders(e,["summary","objective","profile","about","overview","professional summary","career objective"]);return t.length>0?t[0].substring(0,500):void 0}extractSectionsByHeaders(e,t){const n=[],s=e.split("\n");for(let e=0;e<s.length;e++){const i=s[e].trim().toLowerCase();if(t.some((e=>i.includes(e)&&i.length<50))){let t="",i=e+1;for(;i<s.length;){const e=s[i].trim().toLowerCase();if(["experience","education","skills","projects","achievements","awards","certifications","references"].some((t=>e.includes(t)&&e.length<50)))break;t+=s[i]+"\n",i++}t.trim().length>0&&n.push(t.trim())}}return n}calculateExtractionQuality(e,t,n,s,i){let a=0;e.email&&(a+=2),e.phone&&(a+=1),e.linkedin&&(a+=1),e.github&&(a+=1),a=Math.min(a,5);const o=t.technical.length+t.soft.length+t.certifications.length,r=Math.min(Math.round(o/5),5),c=Math.min(2*n.length,5);return{contact:a,skills:r,experience:c,overall:Math.round((a+r+c)/3)}}toDocumentContent(e,t){const n=[{id:crypto.randomUUID(),content:e.summary||"",startIndex:0,endIndex:e.summary?.length||0,metadata:{section:"summary"}},{id:crypto.randomUUID(),content:e.skills.technical.join(", "),startIndex:0,endIndex:e.skills.technical.join(", ").length,metadata:{section:"skills"}},{id:crypto.randomUUID(),content:e.experience.map((e=>`${e.position} at ${e.company}: ${e.description}`)).join("\n\n"),startIndex:0,endIndex:e.experience.map((e=>`${e.position} at ${e.company}: ${e.description}`)).join("\n\n").length,metadata:{section:"experience"}}],s=[...e.skills.technical.map((e=>({text:e,type:"skill",confidence:.9,startIndex:0,endIndex:e.length,context:"Technical skill"}))),...e.contact.email?[{text:e.contact.email,type:"person",confidence:.95,startIndex:0,endIndex:e.contact.email.length,context:"contact_info"}]:[],...e.contact.phone?[{text:e.contact.phone,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.phone.length,context:"contact_info"}]:[],...e.contact.linkedin?[{text:e.contact.linkedin,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.linkedin.length,context:"contact_info"}]:[],...e.contact.github?[{text:e.contact.github,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.github.length,context:"contact_info"}]:[],...e.contact.website?[{text:e.contact.website,type:"person",confidence:.9,startIndex:0,endIndex:e.contact.website.length,context:"contact_info"}]:[]];return{id:t.id,text:e.fullText,chunks:n,entities:s,summary:e.summary||`Resume with ${e.skills.technical.length} technical skills and ${e.experience.length} work experiences`,keyPoints:[...e.skills.technical.slice(0,10),...e.experience.map((e=>`${e.position} at ${e.company}`)).slice(0,3)],keywords:e.skills.technical,structuredData:e,processedAt:new Date,metadata:{...t,extractionQuality:e.extractionQuality,wordCount:e.wordCount,contactInfo:e.contact,skillsCount:e.skills.technical.length+e.skills.soft.length}}}}class I{storage;resumeParser;processingQueue=new Map;activeProcessing=new Set;documentCache=new Map;MAX_QUEUE_SIZE=10;RETRY_LIMIT=3;CACHE_EXPIRY=864e5;constructor(){this.storage=new C,this.resumeParser=new E,this.initializeDocumentProcessing()}async uploadDocuments(e,t,n){const s=[],i=[];if((await this.getSessionDocuments(n)).length+e.length>10)return{success:!1,uploaded:[],errors:["Maximum 10 documents allowed per session"]};for(const n of Array.from(e))try{const e=this.validateDocument(n);if(!e.valid){i.push(`${n.name}: ${e.error}`);continue}const a=await this.createDocumentMetadata(n,t);await this.queueDocumentProcessing(n,a),s.push(a)}catch(e){i.push(`${n.name}: ${e instanceof Error?e.message:"Unknown error"}`)}return{success:s.length>0,uploaded:s,errors:i}}validateDocument(e){if(e.size>10485760)return{valid:!1,error:`File size ${(e.size/1024/1024).toFixed(1)}MB exceeds limit of 10MB`};const t=e.name.split(".").pop()?.toLowerCase();return t&&y.includes(t)?e.name.length>255?{valid:!1,error:"File name too long (max 255 characters)"}:{valid:!0}:{valid:!1,error:`Unsupported format. Supported: ${y.join(", ")}`}}async createDocumentMetadata(e,t){const n=this.generateDocumentId(),s=this.detectDocumentType(e.name,t),i=this.calculateDocumentPriority(s,t);return{id:n,name:e.name,type:s,size:e.size,format:e.type||"application/octet-stream",uploadDate:new Date,lastModified:new Date(e.lastModified),priority:i,tags:this.generateTags(e.name,s),checksum:await this.calculateChecksum(e)}}async getActiveDocuments(){const e=[];for(const t of this.documentCache.values())e.push(t);return e}async queueDocumentProcessing(e,t){if(this.processingQueue.size>=this.MAX_QUEUE_SIZE)throw new Error("Processing queue is full. Please wait for current documents to finish processing.");const n={id:t.id,file:e,metadata:t,priority:t.priority,retryCount:0};this.processingQueue.set(t.id,n),this.activeProcessing.size<3&&this.processNextInQueue()}async processNextInQueue(){if(0===this.processingQueue.size||this.activeProcessing.size>=3)return;const e=Array.from(this.processingQueue.values()),t=[5,3,2,1,0];let n;for(const s of t)if(n=e.find((e=>e.priority===s)),n)break;if(n){this.processingQueue.delete(n.id),this.activeProcessing.add(n.id);try{await this.processDocument(n)}finally{this.activeProcessing.delete(n.id),this.processNextInQueue()}}}async processDocument(e){const t=Date.now();try{const n=await this.extractTextContent(e.file),s=await this.parseStructuredData(n,e.metadata.type,e.file),i=this.createDocumentChunks(n),a=await this.extractEntities(n),o=await this.generateSummary(n,e.metadata.type),r=await this.extractKeyPoints(n,e.metadata.type),c={id:e.metadata.id,text:n,metadata:e.metadata,chunks:i,entities:a,keywords:[],summary:o,keyPoints:r,structuredData:s,processedAt:new Date};return await this.storeDocument(e.metadata,c),this.documentCache.set(e.metadata.id,c),{success:!0,document:c,processingTime:Date.now()-t}}catch(n){if(console.error(`Document processing failed for ${e.metadata.name}:`,n),e.retryCount<this.RETRY_LIMIT){const n={...e,retryCount:e.retryCount+1};return this.processingQueue.set(e.id,n),{success:!1,error:`Processing failed, retrying (${e.retryCount+1}/${this.RETRY_LIMIT})`,processingTime:Date.now()-t}}return{success:!1,error:n instanceof Error?n.message:"Unknown processing error",processingTime:Date.now()-t}}}async extractTextContent(e){const t=e.name.split(".").pop()?.toLowerCase();switch(t){case"txt":case"md":return await e.text();case"pdf":return await this.extractPdfText(e);case"docx":case"doc":return await this.extractDocxText(e);case"pptx":case"ppt":return await this.extractPptText(e);case"xlsx":case"xls":return await this.extractExcelText(e);default:throw new Error(`Unsupported file format: ${t}`)}}async extractPdfText(e){try{return`[PDF Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract PDF text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractDocxText(e){try{return`[DOCX Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract DOCX text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractPptText(e){try{return`[PowerPoint Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract PowerPoint text: ${e instanceof Error?e.message:"Unknown error"}`)}}async extractExcelText(e){try{return`[Excel Content from ${e.name}]`}catch(e){throw new Error(`Failed to extract Excel text: ${e instanceof Error?e.message:"Unknown error"}`)}}async findRelevantDocuments(e,t,n=3){const s=await this.getSessionDocuments(e.currentTopic),i=m[t],a=[];for(const n of s){const s=await this.getDocumentContent(n.id);if(!s)continue;const o=this.calculateRelevanceScore(s,e,t,i);if(o>.3){const n=this.findMatchingChunks(s,e.currentTopic);a.push({document:s,relevanceScore:o,matchingChunks:n,reason:this.generateRelevanceReason(s,e,t)})}}return a.sort(((e,t)=>t.relevanceScore-e.relevanceScore)).slice(0,n)}calculateRelevanceScore(e,t,n,s){let i=0;const a=this.getDocumentMetadataFromCache(e.id);return a&&s.documentRelevance[a.type]&&(i+=.4*this.getPriorityWeight(s.documentRelevance[a.type])),i+=.3*this.calculateTopicSimilarity(e,t.currentTopic),i+=.3*this.calculateEntityOverlap(e,t.conversationHistory),Math.min(i,1)}detectDocumentType(e,t){const n=e.toLowerCase(),s=e.toLowerCase();return n.includes("resume")||n.includes("cv")?f:n.includes("portfolio")||n.includes("work")||n.includes("project")?"portfolio":n.includes("presentation")||n.includes("slide")||n.includes("deck")||n.includes("proposal")||n.includes("bid")||n.includes("case")&&n.includes("study")||n.includes("pricing")||n.includes("quote")||n.includes("estimate")?w:n.includes("reference")||n.includes("recommendation")?s.includes("present")||s.includes("slide")?w:f:n.includes("cover")&&n.includes("letter")?"cover_letter":w}generateDocumentId(){return`doc_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}calculateDocumentPriority(e,t){return e===f&&"interview"===t?3:2}generateTags(e,t){const n=[t];return e.toLowerCase().includes("senior")&&n.push("senior"),e.toLowerCase().includes("junior")&&n.push("junior"),e.toLowerCase().includes("lead")&&n.push("lead"),e.toLowerCase().includes("manager")&&n.push("manager"),n}async calculateChecksum(e){const t=await e.arrayBuffer(),n=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(n)).map((e=>e.toString(16).padStart(2,"0"))).join("")}initializeDocumentProcessing(){setInterval((()=>{this.cleanupExpiredCache()}),36e5)}async getSessionDocuments(e){return[]}cleanupExpiredCache(){}createDocumentChunks(e){return[]}async extractEntities(e){return[]}async generateSummary(e,t){return""}async extractKeyPoints(e,t){return[]}async parseStructuredData(e,t,n){return{}}getPriorityWeight(e){return.5}calculateTopicSimilarity(e,t){return.5}calculateEntityOverlap(e,t){return.5}findMatchingChunks(e,t){return[]}generateRelevanceReason(e,t,n){return""}async getDocumentContent(e){}async storeDocument(e,t){try{await this.storage.set(`document_${e.id}`,{metadata:e,content:t})}catch(e){throw console.error("Failed to store document:",e),e}}getDocumentMetadataFromCache(e){const t=this.documentCache.get(e);return t?.metadata}}class A{apiKey;config;baseURL;models;capabilities;rateLimits;requestHistory;tokenHistory;modelConfigs={};constructor(e,t={}){if(new.target===A)throw new Error("BaseLLMProvider is an abstract class and cannot be instantiated directly");this.apiKey=e,this.config=t,this.baseURL=t.baseURL||"",this.models=t.models||[],this.capabilities=t.capabilities||[],this.rateLimits={requestsPerMinute:60,tokensPerMinute:9e4,requestsPerDay:1e4},this.requestHistory=[],this.tokenHistory=[]}checkRateLimits(e=0){const t=Date.now(),n=t-6e4,s=t-864e5;if(this.requestHistory=this.requestHistory.filter((e=>e>s)),this.tokenHistory=this.tokenHistory.filter((e=>e.time>n)),this.requestHistory.filter((e=>e>n)).length>=this.rateLimits.requestsPerMinute)throw new Error("Rate limit exceeded: requests per minute");if(this.tokenHistory.filter((e=>e.time>n)).reduce(((e,t)=>e+t.tokens),0)+e>this.rateLimits.tokensPerMinute)throw new Error("Rate limit exceeded: tokens per minute");if(this.requestHistory.length>=this.rateLimits.requestsPerDay)throw new Error("Rate limit exceeded: daily request limit")}recordRequest(e){const t=Date.now();this.requestHistory.push(t),this.tokenHistory.push({time:t,tokens:e})}estimateTokens(e){return Math.ceil(e.length/4)}validateModel(e){if(!this.models.includes(e))throw new Error(`Model ${e} is not available for this provider`)}hasCapability(e){return this.capabilities.includes(e)}formatMessages(e){return e.map((e=>"string"==typeof e?{role:"user",content:e}:{role:e.role||"user",content:e.content||""}))}handleCommonErrors(e){const t=e.message?.toLowerCase()||"";if(t.includes("unauthorized")||t.includes("401"))throw new Error("Authentication failed. Please check your API key.");if(t.includes("rate limit")||t.includes("429"))throw new Error("Rate limit exceeded. Please try again later.");if(t.includes("timeout"))throw new Error("Request timed out. Please try again.");if(t.includes("network"))throw new Error("Network error. Please check your connection.");throw e}getModelConfig(e){return this.modelConfigs?.[e]||null}calculatePricing(e,t){return 0}getModels(){return Object.freeze([...this.models])}getCapabilities(){return Object.freeze([...this.capabilities])}}class M extends A{constructor(e,t={}){super(e,t),this.baseURL="https://api.openai.com/v1",this.models=t.models||["gpt-4-turbo-preview","gpt-4-vision-preview","gpt-3.5-turbo","gpt-3.5-turbo-16k"],this.modelConfigs={"gpt-4-turbo-preview":{maxTokens:128e3,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.01,costPer1kOutput:.03},"gpt-4-vision-preview":{maxTokens:128e3,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.01,costPer1kOutput:.03},"gpt-3.5-turbo":{maxTokens:4096,supportsVision:!1,supportsFunctions:!0,costPer1kInput:5e-4,costPer1kOutput:.0015},"gpt-3.5-turbo-16k":{maxTokens:16384,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.003,costPer1kOutput:.004}}}async generateCompletion(e){const{model:t="gpt-3.5-turbo",messages:n,systemMessage:s,temperature:i=.7,maxTokens:a=500,stream:o=!1,tools:r=null}=e,c=n?n.map((e=>({role:e.role||"user",content:e.content||""}))):[{role:"user",content:e.prompt||""}];if(!this.models.includes(t))throw new Error(`Model ${t} not available for OpenAI provider`);const l=[];s&&l.push({role:"system",content:s}),l.push(...c);const d={model:t,messages:l,temperature:i,max_tokens:a,stream:o};r&&this.modelConfigs[t]?.supportsFunctions&&(d.functions=r);try{const e=await this.makeRequest("/chat/completions",d);return o?{provider:"openai",model:t,isStream:!0,content:"",usage:{promptTokens:0,completionTokens:0,totalTokens:0},finishReason:"stop"}:this.formatResponse(e,t)}catch(e){throw this.handleError(e)}}async makeRequest(e,t,n=3){const s=`${this.baseURL}${e}`;for(let e=0;e<=n;e++)try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,"OpenAI-Beta":"assistants=v1"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===n)throw t;const s=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(s)}throw new Error("Max retries exceeded")}formatResponse(e,t){const n=e.choices?.[0];if(!n)throw new Error("No choices in OpenAI response");return{content:n.message?.content||"",usage:{promptTokens:e.usage?.prompt_tokens||0,completionTokens:e.usage?.completion_tokens||0,totalTokens:e.usage?.total_tokens||0,model:e.model||t},model:e.model||t,finishReason:n.finish_reason||"stop",metadata:{id:e.id,created:e.created,object:e.object},provider:"openai",isStream:!1}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const n=new TextDecoder;let s="";for(;;){const{done:e,value:i}=await t.read();if(e)break;s+=n.decode(i,{stream:!0});const a=s.split("\n");s=a.pop()||"";for(const e of a)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);e.choices[0].delta.content&&(yield{content:e.choices[0].delta.content,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const n=this.modelConfigs[t];return n?e.promptTokens/1e3*n.costPer1kInput+e.completionTokens/1e3*n.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({prompt:"Hello",context:{sessionId:"default",callType:"interview",tone:"professional",currentTopic:"general",conversationHistory:[],relevantDocuments:[],participants:[],meetingPhase:"discussion",participantContext:{}},maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("rate limit")?new Error("Rate limit exceeded. Please try again later."):t.includes("quota")?new Error("API quota exceeded"):t.includes("context length")?new Error("Message too long for model context window"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}async getConnectionTestResult(){try{return{success:!0,message:"Connection successful",model:(await this.generateCompletion({prompt:"Hello",context:{sessionId:"default",callType:"interview",tone:"professional",currentTopic:"general",conversationHistory:[],relevantDocuments:[],participants:[],meetingPhase:"discussion",participantContext:{}},maxTokens:10})).model}}catch(e){return{success:!1,message:e.message}}}}class P extends A{anthropicVersion;constructor(e,t={}){super(e,t),this.baseURL="https://api.anthropic.com/v1",this.models=t.models||["claude-3-opus-20240229","claude-3-sonnet-20240229","claude-3-haiku-20240307"],this.modelConfigs={"claude-3-opus-20240229":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.015,costPer1kOutput:.075},"claude-3-sonnet-20240229":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.003,costPer1kOutput:.015},"claude-3-haiku-20240307":{maxTokens:2e5,supportsVision:!0,supportsFunctions:!1,costPer1kInput:25e-5,costPer1kOutput:.00125}},this.anthropicVersion="2023-06-01"}async generateCompletion(e){const{model:t="claude-3-sonnet-20240229",messages:n,temperature:s=.7,maxTokens:i=500,stream:a=!1}=e,o="systemPrompt"in e?e.systemPrompt:void 0;if(!this.models.includes(t))throw new Error(`Model ${t} not available for Anthropic provider`);const r=Array.isArray(n)?n:[],c={model:t,messages:this.formatMessagesForClaude(r),max_tokens:i,temperature:s,stream:a};o&&(c.system=o);try{const e=await this.makeRequest("/messages",c);return a?{provider:"anthropic",model:t,isStream:!0,content:"",usage:{promptTokens:0,completionTokens:0,totalTokens:0},finishReason:"stop"}:this.formatResponse(e,t)}catch(e){throw this.handleError(e)}}formatMessagesForClaude(e){const t=[];e.forEach((e=>{const n=t[t.length-1];0===t.length||n&&n.role!==e.role?t.push({role:"system"===e.role?"user":e.role,content:e.content}):n&&(n.content+="\\n\\n"+e.content)}));const n=t[0];return t.length>0&&n&&"assistant"===n.role&&t.unshift({role:"user",content:"Continue the conversation."}),t}async makeRequest(e,t,n=3){const s=`${this.baseURL}${e}`;for(let e=0;e<=n;e++)try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json","x-api-key":this.apiKey,"anthropic-version":this.anthropicVersion},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===n)throw t;const s=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(s)}throw new Error("Max retries exceeded")}formatResponse(e,t){return{content:e.content?.[0]?.text||"",usage:{promptTokens:e.usage?.input_tokens||0,completionTokens:e.usage?.output_tokens||0,totalTokens:(e.usage?.input_tokens||0)+(e.usage?.output_tokens||0),model:e.model||t,estimatedCost:this.calculateCost(e.usage,t)},model:e.model||t,finishReason:e.stop_reason||"stop_sequence",metadata:{id:e.id,type:e.type,messageRole:e.role},provider:"anthropic"}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const n=new TextDecoder;let s="";for(;;){const{done:e,value:i}=await t.read();if(e)break;s+=n.decode(i,{stream:!0});const a=s.split("\\n");s=a.pop()||"";for(const e of a)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);"content_block_delta"===e.type&&e.delta?.text&&(yield{content:e.delta.text,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const n=this.modelConfigs[t];return n?e.input_tokens/1e3*n.costPer1kInput+e.output_tokens/1e3*n.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({model:"claude-3-haiku-20240307",messages:[{role:"user",content:"Hello"}],maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("rate limit")?new Error("Rate limit exceeded. Please try again later."):t.includes("quota")?new Error("API quota exceeded"):t.includes("token")&&t.includes("limit")?new Error("Message too long for model context window"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}}class D extends A{defaultSafetySettings;constructor(e,t={}){super(e,t),this.baseURL="https://generativelanguage.googleapis.com/v1beta",this.models=t.models||["gemini-pro","gemini-pro-vision","gemini-ultra"],this.modelConfigs={"gemini-pro":{maxTokens:32768,supportsVision:!1,supportsFunctions:!0,costPer1kInput:.0025,costPer1kOutput:.0025},"gemini-pro-vision":{maxTokens:32768,supportsVision:!0,supportsFunctions:!1,costPer1kInput:.0025,costPer1kOutput:.0025},"gemini-ultra":{maxTokens:32768,supportsVision:!0,supportsFunctions:!0,costPer1kInput:.01875,costPer1kOutput:.01875}},this.defaultSafetySettings=[{category:"HARM_CATEGORY_HARASSMENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_HATE_SPEECH",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_SEXUALLY_EXPLICIT",threshold:"BLOCK_MEDIUM_AND_ABOVE"},{category:"HARM_CATEGORY_DANGEROUS_CONTENT",threshold:"BLOCK_MEDIUM_AND_ABOVE"}]}async generateCompletion(e){const{model:t="gemini-pro",messages:n,temperature:s=.7,maxTokens:i=500,stream:a=!1}=e,o="systemPrompt"in e?e.systemPrompt:void 0,r="functions"in e?e.functions:null;if(!this.models.includes(t))throw new Error(`Model ${t} not available for Gemini provider`);const c=Array.isArray(n)?n:[],l={contents:this.formatMessagesForGemini(c,o),generationConfig:{temperature:s,maxOutputTokens:i,candidateCount:1},safetySettings:this.defaultSafetySettings};r&&this.modelConfigs[t]?.supportsFunctions&&(l.tools=[{functionDeclarations:r}]);try{const e=a?`/models/${t}:streamGenerateContent`:`/models/${t}:generateContent`,n=await this.makeRequest(e,l);return a?{provider:"gemini",model:t,isStream:!0,content:"",usage:{promptTokens:0,completionTokens:0,totalTokens:0},finishReason:"stop"}:this.formatResponse(n,t)}catch(e){throw this.handleError(e)}}formatMessagesForGemini(e,t){const n=[];return t&&(n.push({role:"user",parts:[{text:`System: ${t}\n\nPlease follow these instructions in your responses.`}]}),n.push({role:"model",parts:[{text:"Understood. I will follow these instructions."}]})),e.forEach((e=>{const t="assistant"===e.role?"model":"user";if("string"==typeof e.content)n.push({role:t,parts:[{text:e.content}]});else if(Array.isArray(e.content)){const s=e.content.map((e=>"text"===e.type?{text:e.text}:"image"===e.type?{inlineData:{mimeType:e.mimeType||"image/jpeg",data:e.data}}:null)).filter(Boolean);n.push({role:t,parts:s})}})),n}async makeRequest(e,t,n=3){const s=`${this.baseURL}${e}?key=${this.apiKey}`;for(let e=0;e<=n;e++)try{const e=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!e.ok){const t=await e.json();throw new Error(t.error?.message||`HTTP ${e.status}`)}return await e.json()}catch(t){if(e===n)throw t;const s=Math.min(1e3*Math.pow(2,e),1e4);await this.delay(s)}throw new Error("Max retries exceeded")}formatResponse(e,t){const n=e.candidates?.[0];if(!n)throw new Error("No candidates in Gemini response");return{content:n.content?.parts?.[0]?.text||"",usage:{promptTokens:e.usageMetadata?.promptTokenCount||0,completionTokens:e.usageMetadata?.candidatesTokenCount||0,totalTokens:e.usageMetadata?.totalTokenCount||0,model:t},model:t,finishReason:e.candidates?.[0]?.finishReason||"STOP",metadata:{safetyRatings:e.candidates?.[0]?.safetyRatings,messageRole:"assistant"},provider:"gemini"}}async*handleStreamResponse(e){const t=e.body?.getReader();if(!t)throw new Error("No response body available for streaming");const n=new TextDecoder;let s="";for(;;){const{done:e,value:i}=await t.read();if(e)break;s+=n.decode(i,{stream:!0});const a=s.split("\n");s=a.pop()||"";for(const e of a)if(e.startsWith("data: ")){const t=e.slice(6);if("[DONE]"===t)return;try{const e=JSON.parse(t);e.candidates?.[0]?.content?.parts?.[0]?.text&&(yield{content:e.candidates[0].content.parts[0].text,role:"assistant",isStream:!0})}catch(e){console.error("Failed to parse stream data:",e)}}}}calculateCost(e,t){const n=this.modelConfigs[t];return n?e.promptTokens/1e3*n.costPer1kInput+e.completionTokens/1e3*n.costPer1kOutput:0}async testConnection(){try{return await this.generateCompletion({model:"gemini-pro",messages:[{role:"user",content:"Hello"}],maxTokens:10}),!0}catch(e){return!1}}handleError(e){const t=e.message.toLowerCase();return t.includes("api key")?new Error("Invalid API key"):t.includes("quota")?new Error("API quota exceeded"):t.includes("safety")?new Error("Content blocked by safety filters"):e}delay(e){return new Promise((t=>setTimeout(t,e)))}}const L="company",R="role",_="skill",$="technology",z="interviewer",O="project",U="metric";class q{storage;resumeParser;sessionContexts;entityPatterns;constructor(){this.storage=new C,this.resumeParser=new E,this.sessionContexts=new Map,this.entityPatterns=this.initializeEntityPatterns(),this.loadPersistedContext()}initializeEntityPatterns(){return{[L]:{patterns:[/(?:work(?:ed|ing)?\s+(?:at|for)|employed\s+by|join(?:ed|ing)?)\s+([A-Z][\w\s&]+)/gi,/(?:at|with)\s+([A-Z][\w\s&]+)\s+(?:Inc|LLC|Corp|Company|Limited|Ltd)/gi],keywords:["company","employer","organization","firm"]},[R]:{patterns:[/(?:position|role|title)(?:\s+is|\s+was|\s+of)?\s+([A-Z][\w\s]+(?:Engineer|Developer|Manager|Analyst|Designer))/gi,/(?:as|working\s+as)\s+(?:a|an)?\s+([A-Z][\w\s]+)/gi],keywords:["position","role","title","job"]},[_]:{patterns:[/(?:experience|proficient|skilled|expertise)\s+(?:in|with)\s+([\w\s,+#]+)/gi,/(?:using|know|familiar\s+with)\s+([\w\s,+#]+)/gi],keywords:["skill","expertise","proficiency","experience"]},[$]:{patterns:[/\b(React|Angular|Vue|Node\.?js|Python|Java|JavaScript|TypeScript|AWS|Azure|GCP|Docker|Kubernetes)\b/gi,/\b([A-Z][\w]+(?:\.js|DB|SQL))\b/g],keywords:["technology","framework","language","tool"]}}}async createSessionContext(e){const t=e.sessionId||crypto.randomUUID(),n=await this.storage.get("resumeData",{namespace:v}),s=await this.storage.get("jobDescriptions",{namespace:v}),i={sessionId:t,platform:e.platform||"unknown",startTime:Date.now(),resume:n,jobDescription:s?.[0],conversationHistory:[],detectedEntities:{[L]:new Set,[R]:new Set,[_]:new Set,[$]:new Set,[z]:new Set,[O]:new Set,[U]:new Set},keyTopics:[],questionCount:0,currentQuestion:null};return this.sessionContexts.set(t,i),await this.persistContext(t,i),i}async enrichContext(e){const t=e.sessionId,n=this.sessionContexts.get(t)||await this.createSessionContext(e),s={...n,...e,insights:{interviewDuration:Date.now()-n.startTime,averageResponseTime:this.calculateAverageResponseTime(n),topSkillsDiscussed:this.identifyTopSkills(n),matchScore:this.calculateJobMatchScore(n)}};return this.sessionContexts.set(t,s),s}async updateContext(e){const{sessionId:t,transcription:n,isQuestion:s,speaker:i}=e,a=this.sessionContexts.get(t);if(!a)return void console.error("Context not found for session:",t);const o=this.extractEntities(n);for(const[e,t]of Object.entries(o)){const n=a.detectedEntities[e];n&&t.forEach((e=>n.add(e)))}const r={timestamp:Date.now(),text:n,entities:o,keywords:this.extractKeywords(n),...i&&{speaker:i},...void 0!==s&&{isQuestion:s}};return a.conversationHistory.push(r),s&&(a.questionCount++,a.currentQuestion=n),this.updateKeyTopics(a,r.keywords),await this.persistContext(t,a),a}extractEntities(e){const t={};for(const[n,s]of Object.entries(this.entityPatterns))if(t[n]=new Set,s.patterns.forEach((s=>{const i=e.matchAll(s);for(const e of i)e[1]&&t[n]&&t[n].add(e[1].trim())})),s.keywords.some((t=>e.toLowerCase().includes(t)))){const i=e.split(/\s+/);i.forEach(((e,a)=>{if(s.keywords.includes(e.toLowerCase())&&a<i.length-1){let e="";for(let t=a+1;t<Math.min(a+4,i.length);t++){const n=i[t];if(!n||!n[0]||n[0]!==n[0].toUpperCase())break;e+=n+" "}e.trim()&&t[n]&&t[n].add(e.trim())}}))}const n={};for(const[e,s]of Object.entries(t))n[e]=Array.from(s);return n}extractKeywords(e){const t=new Set(["the","a","an","and","or","but","in","on","at","to","for","of","with","by","from","as","is","was","are","were","been","have","has","had","do","does","did","will","would","could","should","may","might","must","can","could","this","that","these","those","i","you","he","she","it","we","they","what","which"]),n=e.toLowerCase().split(/\W+/).filter((e=>e.length>2&&!t.has(e))),s={};return n.forEach((e=>{s[e]=(s[e]||0)+1})),Object.entries(s).sort(((e,t)=>t[1]-e[1])).slice(0,5).map((([e])=>e))}updateKeyTopics(e,t){t.forEach((t=>{const n=e.keyTopics.find((e=>e.keyword===t));n?(n.frequency++,n.lastMentioned=Date.now()):e.keyTopics.push({keyword:t,frequency:1,firstMentioned:Date.now(),lastMentioned:Date.now()})})),e.keyTopics.sort(((e,t)=>t.frequency-e.frequency)),e.keyTopics=e.keyTopics.slice(0,10)}calculateAverageResponseTime(e){const t=[],n=[];if(e.conversationHistory.forEach((e=>{e.isQuestion?t.push(e.timestamp):n.push(e.timestamp)})),0===t.length||0===n.length)return 0;let s=0,i=0;for(let e=0;e<t.length;e++){const a=t[e];if(void 0!==a){const e=n.find((e=>e>a));e&&(s+=e-a,i++)}}return i>0?s/i:0}identifyTopSkills(e){const t=e.detectedEntities[_],n=e.detectedEntities[$];return[...t?Array.from(t):[],...n?Array.from(n):[]].slice(0,5)}calculateJobMatchScore(e){if(!e.resume||!e.jobDescription)return 0;const t=new Set(e.resume.structured?.skills||[]),n=new Set(e.jobDescription.requirements||[]),s=e.detectedEntities[_];let i=0,a=0;n.forEach((e=>{t.has(e)&&i++,s&&s.has(e)&&a++}));const o=n.size>0?i/n.size:0,r=n.size>0?a/n.size*.2:0;return Math.min(o+r,1)}async persistContext(e,t){const n={...t,detectedEntities:{}};for(const[e,s]of Object.entries(t.detectedEntities))n.detectedEntities[e]=Array.from(s);await this.storage.set(`context_${e}`,n,{namespace:T})}async loadPersistedContext(){const e=await this.storage.getNamespaceKeys(T);for(const t of e){const e=t.split(":")[1];if(e){const t=await this.storage.get(e,{namespace:T});if(t&&t.sessionId){for(const[e,n]of Object.entries(t.detectedEntities))Array.isArray(n)&&(t.detectedEntities[e]=new Set(n));this.sessionContexts.set(t.sessionId,t)}}}}}class N{providers=new Map;contextManager;documentManager;storage;providerPerformance=new Map;PROVIDER_TIMEOUT=3e4;MAX_RETRIES=2;FALLBACK_CHAIN=["openai","anthropic","gemini"];constructor(){this.contextManager=new q,this.documentManager=new I,this.storage=new C,this.initializeProviders(),this.loadProviderPerformance()}async generateMeetingResponse(e,t,n){try{const s=await this.documentManager.findRelevantDocuments(n,t.callType,3),i=await this.buildContextualPrompt(e,t,n,s.map((e=>e.document))),a=await this.selectOptimalGeneration(i,t.callType,t.tone),o=await this.generateWithFallback(a),r=await this.optimizeResponse(o,t,s.map((e=>e.document)));return await this.updateProviderPerformance(a.provider.name,!0,Date.now()),r}catch(n){return console.error("Meeting response generation failed:",n),this.generateFallbackResponse(e,t.callType,t.tone)}}async generateSuggestions(e,t,n,s=3){const i=[];try{const a=await this.analyzeConversation(e),o=this.determineSuggestionTypes(t,e.meetingPhase,a);for(const a of o.slice(0,s)){const s=await this.generateTypedSuggestion(a,e,t,n);s&&i.push(s)}return i}catch(e){return console.error("Suggestion generation failed:",e),[]}}async buildContextualPrompt(e,t,n,s){const i=m[t.callType],a=g[t.tone],o=s&&s.length>0?this.buildDocumentContext([...s],t.callType):"",r=this.buildConversationContext(n.conversationHistory.slice(-10));return`\n${this.buildMeetingInstructions(t,i,a)}\n\nCURRENT MEETING CONTEXT:\n- Call Type: ${t.callType}\n- Tone: ${t.tone}\n- Meeting Phase: ${n.meetingPhase}\n- Participants: ${t.participants.length}\n- Current Topic: ${n.currentTopic}\n\n${o}\n\n${r}\n\nUSER INPUT: "${e}"\n\nPlease provide a response that:\n1. Matches the ${t.tone} tone\n2. Is appropriate for a ${t.callType}\n3. Considers the current meeting phase (${n.meetingPhase})\n4. References relevant information from the provided documents when helpful\n5. Maintains professional standards while being engaging\n\nResponse:`}buildDocumentContext(e,t){if(!e.length)return"";let n="\n=== Relevant Documents ===\n";return e.forEach(((e,s)=>{n+=`\nDocument ${s+1}: ${e.metadata.name}\nSummary: ${e.summary}\nKey Points: ${e.keyPoints?.slice(0,5).join(", ")||"No key points available"}\n`,t===o&&e.structuredData?.personalInfo?n+=`Background: ${JSON.stringify(e.structuredData.personalInfo,null,2)}\n`:t.includes("sales")&&e.structuredData?.pricing&&(n+=`Pricing Info: ${JSON.stringify(e.structuredData.pricing,null,2)}\n`)})),n}buildConversationContext(e){if(0===e.length)return"";let t="\nRECENT CONVERSATION:\n";return e.forEach(((e,n)=>{t+=`${e.speaker}: ${e.content}\n`})),t}buildMeetingInstructions(e,t,n){return`You are an AI meeting assistant specialized in ${e.callType} scenarios.\n\nCALL TYPE FOCUS (${e.callType}):\n- Focus Areas: ${t.focusAreas.join(", ")}\n- Response Style: ${t.responseStyle}\n- Priority Level: ${t.priority}\n\nTONE REQUIREMENTS (${e.tone}):\n- Vocabulary: ${n.vocabulary}\n- Sentiment: ${n.sentiment}\n- Structure: ${n.structure}\n- Key Phrases to Use: ${n.phrases.join(", ")}`}async selectOptimalGeneration(e,t,n){const s=this.calculatePromptComplexity(e),i=await this.scoreProviders(t,n,s),a=this.selectBestProvider(i),o=this.determineOptimalParameters(t,n,s);return{prompt:e,provider:a,model:this.selectOptimalModel(a,t),parameters:o}}async scoreProviders(e,t,n){const s=new Map;for(const[i,a]of this.providers){let o=0;o+=this.getProviderCapabilityScore(a,e,t);const r=this.providerPerformance.get(i);r&&(o+=.3*r.successRate,o+=1/Math.max(r.averageLatency,1)*.2,o+=1/Math.max(r.cost,.001)*.1),o+=this.getComplexityScore(a,n),s.set(i,o)}return s}determineOptimalParameters(e,t,n){const s={temperature:.7,maxTokens:500,presencePenalty:0,frequencyPenalty:0,topP:.9,stopSequences:[]};switch(e){case o:s.temperature=.5,s.maxTokens=300;break;case"sales_pitch":s.temperature=.8,s.maxTokens=600;break;case"brainstorming":s.temperature=.9,s.maxTokens=400}switch(t){case h:s.temperature*=.8;break;case u:s.temperature*=1.1;break;case"creative":s.temperature*=1.2}return n>.7&&(s.maxTokens=Math.min(1.5*s.maxTokens,1e3)),s}async generateWithFallback(e){const t={prompt:e.prompt,context:{},callType:"client_meeting",tone:d,temperature:e.parameters.temperature,maxTokens:e.parameters.maxTokens,model:e.model,sessionId:"session_"+Date.now()};try{const n=await Promise.race([e.provider.generateCompletion(t),this.createTimeoutPromise(this.PROVIDER_TIMEOUT)]);if(n&&n.content)return n}catch(t){console.warn(`Primary provider ${e.provider.name} failed:`,t)}for(const n of this.FALLBACK_CHAIN){if(n===e.provider.name)continue;const s=this.providers.get(n);if(s)try{const e=await Promise.race([s.generateCompletion(t),this.createTimeoutPromise(this.PROVIDER_TIMEOUT)]);if(e&&e.content)return console.log(`Fallback provider ${n} succeeded`),e}catch(e){console.warn(`Fallback provider ${n} failed:`,e)}}throw new Error("All providers failed to generate response")}async optimizeResponse(e,t,n){const s=e.content||e.text||"",i=this.extractSupportingPoints(s,n),a=this.generateFollowUpQuestions(s,t.callType,t.tone);return{content:s,tone:t.tone,confidence:this.calculateResponseConfidence(e),relevantDocuments:n.map((e=>({id:e.id,name:e.metadata.name,type:e.metadata.format,size:e.metadata.size,uploadedAt:e.metadata.uploadDate,content:e.text,summary:e.summary,keywords:e.keywords}))),supportingPoints:[...i],followUpQuestions:[...a],metadata:{callType:t.callType,responseType:"answer",priority:3,timing:"immediate",formality:this.mapToneToFormality(t.tone),length:s.length>200?"detailed":"brief"}}}initializeProviders(){const e={name:"openai",apiKey:"dummy-key",model:"gpt-4",maxTokens:4096,temperature:.7,isEnabled:!0,priority:1,rateLimits:{requestsPerMinute:60,tokensPerMinute:9e4,dailyLimit:1e6},generateCompletion:async e=>new M("dummy-key").generateCompletion(e)},t={name:"anthropic",apiKey:"dummy-key",model:"claude-3-sonnet",maxTokens:4096,temperature:.7,isEnabled:!0,priority:2,rateLimits:{requestsPerMinute:60,tokensPerMinute:1e5,dailyLimit:1e6},generateCompletion:async e=>new P("dummy-key").generateCompletion(e)},n={name:"gemini",apiKey:"dummy-key",model:"gemini-pro",maxTokens:4096,temperature:.7,isEnabled:!0,priority:3,rateLimits:{requestsPerMinute:60,tokensPerMinute:32e3,dailyLimit:1e6},generateCompletion:async e=>new D("dummy-key").generateCompletion(e)};this.providers.set("openai",e),this.providers.set("anthropic",t),this.providers.set("gemini",n)}async loadProviderPerformance(){try{const e=await this.storage.getItem("candidai:performance:provider_performance");e&&Object.entries(e).forEach((([e,t])=>{this.providerPerformance.set(e,t)}))}catch(e){console.warn("Failed to load provider performance:",e)}}calculatePromptComplexity(e){return.5}getProviderCapabilityScore(e,t,n){return.7}getComplexityScore(e,t){return.6}selectBestProvider(e){const t=Array.from(e.entries()).reduce(((e,t)=>e[1]>t[1]?e:t))[0];return this.providers.get(t)||this.providers.values().next().value}selectOptimalModel(e,t){return(e.getModels?.()||[])[0]||"default"}createTimeoutPromise(e){return new Promise(((t,n)=>setTimeout((()=>n(new Error("Timeout"))),e)))}calculateResponseConfidence(e){return.8}extractSupportingPoints(e,t){return[]}generateFollowUpQuestions(e,t,n){return[]}mapToneToFormality(e){switch(e){case h:return"formal";case u:return"casual";case p:return"friendly";default:return"professional"}}async updateProviderPerformance(e,t,n){}generateFallbackResponse(e,t,n){return{content:"I'm processing your request. Please give me a moment.",tone:n,confidence:.5,relevantDocuments:[],supportingPoints:[],followUpQuestions:[],metadata:{callType:t,responseType:"answer",priority:2,timing:"immediate",formality:"formal",length:"brief"}}}async analyzeConversation(e){return{}}determineSuggestionTypes(e,t,n){return[]}async generateTypedSuggestion(e,t,n,s){}}class F{config;callbacks;performanceAnalyzer;recognition=null;webSpeechAvailable;isListening=!1;isInitialized=!1;currentSessionId=null;reconnectAttempts=0;transcriptBuffer=[];lastTranscriptTime=0;sessionStartTime=0;statistics={totalSessions:0,totalDuration:0,averageConfidence:0,errorCount:0,reconnectionCount:0,lastSessionDuration:0};MAX_RECONNECT_ATTEMPTS=5;RECONNECT_DELAY_BASE=1e3;SILENCE_TIMEOUT=5e3;TRANSCRIPT_BUFFER_LIMIT=1e3;constructor(e={},t={},n){this.config={continuous:!0,interimResults:!0,language:"en-US",maxAlternatives:3,silenceTimeout:this.SILENCE_TIMEOUT,confidenceThreshold:.7,...e},this.callbacks=t,this.performanceAnalyzer=n,this.webSpeechAvailable=this.checkWebSpeechSupport(),console.log("SpeechToText initialized with "+(this.webSpeechAvailable?"Web Speech API":"fallback service"))}async initialize(){if(this.isInitialized)console.warn("SpeechToText already initialized");else try{this.webSpeechAvailable?await this.initializeWebSpeechAPI():await this.initializeFallbackService(),this.isInitialized=!0,console.log("SpeechToText service initialized successfully"),this.performanceAnalyzer&&this.performanceAnalyzer.logEvent("speech_to_text_initialized",{service:this.webSpeechAvailable?"web_speech_api":"fallback",language:this.config.language})}catch(e){throw console.error("Failed to initialize SpeechToText:",e),new Error(`SpeechToText initialization failed: ${e instanceof Error?e.message:"Unknown error"}`)}}async initializeWebSpeechAPI(){const e=window.SpeechRecognition||window.webkitSpeechRecognition;if(!e)throw new Error("Web Speech API not available");this.recognition=new e,this.recognition.continuous=this.config.continuous,this.recognition.interimResults=this.config.interimResults,this.recognition.lang=this.config.language,this.recognition.maxAlternatives=this.config.maxAlternatives,this.setupWebSpeechEventHandlers(),console.log("Web Speech API initialized with configuration:",this.config)}async initializeFallbackService(){throw console.warn("Web Speech API not available, initializing fallback service"),new Error("Fallback STT service not yet implemented")}setupWebSpeechEventHandlers(){this.recognition&&(this.recognition.onresult=e=>{this.handleSpeechResult(e)},this.recognition.onerror=e=>{this.handleSpeechError(e)},this.recognition.onend=()=>{this.handleSpeechEnd()},this.recognition.onstart=()=>{this.handleSpeechStart()},this.recognition.onnomatch=()=>{console.log("No speech match detected"),this.logEvent("no_speech_match")},this.recognition.onaudiostart=()=>{console.log("Audio capture started"),this.logEvent("audio_capture_started")},this.recognition.onaudioend=()=>{console.log("Audio capture ended"),this.logEvent("audio_capture_ended")},this.recognition.onspeechstart=()=>{console.log("Speech detected"),this.logEvent("speech_detected")},this.recognition.onspeechend=()=>{console.log("Speech ended"),this.logEvent("speech_ended")})}handleSpeechResult(e){try{const t=e.results;for(let n=e.resultIndex;n<t.length;n++){const e=t[n];if(!e||0===e.length)continue;const s=e[0];if(!s)continue;const i=s.transcript?.trim()||"",a=s.confidence||.5,o=e.isFinal;if(!i)continue;const r=[];for(let t=1;t<Math.min(e.length,this.config.maxAlternatives);t++){const n=e[t];if(n?.transcript){const e=n.transcript.trim();e.length>0&&r.push(e)}}const c={text:i,confidence:a,isFinal:o,timestamp:Date.now(),alternatives:r.length>0?r:[]};o&&a>=this.config.confidenceThreshold&&this.addToTranscriptBuffer({text:i,confidence:a,timestamp:Date.now(),sessionId:this.currentSessionId||""}),this.callbacks.onResult&&this.callbacks.onResult(c),this.updateStatistics(a,o),this.lastTranscriptTime=Date.now(),o&&a>=.8&&this.logEvent("high_confidence_transcript",{length:i.length,confidence:a,hasAlternatives:r.length>0})}}catch(e){console.error("Error processing speech result:",e),this.handleError("processing_error","Failed to process speech result")}}handleSpeechError(e){console.error("Speech recognition error:",e.error);const t={error:e.error,message:this.getErrorMessage(e.error),timestamp:Date.now(),recoverable:this.isRecoverableError(e.error)};this.statistics={...this.statistics,errorCount:this.statistics.errorCount+1},this.callbacks.onError&&this.callbacks.onError(t),this.logEvent("speech_recognition_error",{error:e.error,recoverable:t.recoverable,attempt:this.reconnectAttempts}),t.recoverable&&this.isListening&&this.attemptRecovery()}handleSpeechEnd(){if(console.log("Speech recognition session ended"),this.isListening=!1,this.sessionStartTime>0){const e=Date.now()-this.sessionStartTime;this.statistics={...this.statistics,lastSessionDuration:e,totalDuration:this.statistics.totalDuration+e}}this.callbacks.onEnd&&this.callbacks.onEnd(),this.config.continuous&&this.isInitialized&&setTimeout((()=>{this.isListening||this.attemptRecovery()}),100),this.logEvent("speech_session_ended",{duration:this.statistics.lastSessionDuration,transcriptCount:this.transcriptBuffer.length})}handleSpeechStart(){console.log("Speech recognition session started"),this.isListening=!0,this.sessionStartTime=Date.now(),this.currentSessionId=this.generateSessionId(),this.reconnectAttempts=0,this.statistics={...this.statistics,totalSessions:this.statistics.totalSessions+1},this.callbacks.onStart&&this.callbacks.onStart(),this.logEvent("speech_session_started",{sessionId:this.currentSessionId,language:this.config.language})}async start(){if(!this.isInitialized)throw new Error("SpeechToText not initialized. Call initialize() first.");if(this.isListening)console.warn("Speech recognition already active");else try{this.recognition?this.recognition.start():await this.startFallbackService(),this.logEvent("speech_recognition_start_requested")}catch(e){throw console.error("Failed to start speech recognition:",e),this.handleError("start_failed",`Failed to start: ${e instanceof Error?e.message:"Unknown error"}`),e}}stop(){if(this.isListening)try{this.recognition?this.recognition.stop():this.stopFallbackService(),this.logEvent("speech_recognition_stop_requested")}catch(e){console.error("Failed to stop speech recognition:",e),this.handleError("stop_failed",`Failed to stop: ${e instanceof Error?e.message:"Unknown error"}`)}else console.warn("Speech recognition not active")}updateLanguage(e){if(this.config.language===e)return;const t=this.isListening;t&&this.stop(),this.config.language=e,this.recognition&&(this.recognition.lang=e),this.logEvent("language_updated",{from:this.config.language,to:e}),t&&setTimeout((()=>{this.start()}),100)}getTranscriptHistory(){return[...this.transcriptBuffer]}clearTranscripts(){this.transcriptBuffer.length=0,this.logEvent("transcript_history_cleared")}getStatistics(){return{...this.statistics}}updateConfig(e){const t=this.isListening;t&&this.stop(),Object.assign(this.config,e),this.recognition&&(this.recognition.continuous=this.config.continuous,this.recognition.interimResults=this.config.interimResults,this.recognition.lang=this.config.language,this.recognition.maxAlternatives=this.config.maxAlternatives),this.logEvent("config_updated",e),t&&setTimeout((()=>{this.start()}),100)}checkWebSpeechSupport(){return"undefined"!=typeof window&&("SpeechRecognition"in window||"webkitSpeechRecognition"in window)}generateSessionId(){return`stt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}addToTranscriptBuffer(e){this.transcriptBuffer.push(e),this.transcriptBuffer.length>this.TRANSCRIPT_BUFFER_LIMIT&&this.transcriptBuffer.splice(0,this.transcriptBuffer.length-this.TRANSCRIPT_BUFFER_LIMIT)}updateStatistics(e,t){if(!t)return;const n=this.statistics.averageConfidence,s=this.statistics.totalSessions;this.statistics={...this.statistics,averageConfidence:(n*s+e)/(s+1)}}getErrorMessage(e){return{network:"Network connection error. Please check your internet connection.","no-speech":"No speech was detected. Please speak clearly into your microphone.","audio-capture":"Unable to access microphone. Please check permissions and device.","not-allowed":"Microphone access denied. Please grant permission to continue.",aborted:"Speech recognition was interrupted.","language-not-supported":`Language '${this.config.language}' is not supported.`,"service-not-allowed":"Speech recognition service is not allowed.","bad-grammar":"Recognition grammar error occurred."}[e]||`Recognition error: ${e}`}isRecoverableError(e){return["network","aborted","audio-capture"].includes(e)}attemptRecovery(){if(this.reconnectAttempts>=this.MAX_RECONNECT_ATTEMPTS)return console.error("Maximum reconnection attempts reached"),void this.handleError("max_reconnect_reached","Failed to recover after maximum attempts");this.reconnectAttempts++,this.statistics={...this.statistics,reconnectionCount:this.statistics.reconnectionCount+1};const e=this.RECONNECT_DELAY_BASE*Math.pow(2,this.reconnectAttempts-1);console.log(`Attempting recovery in ${e}ms (attempt ${this.reconnectAttempts}/${this.MAX_RECONNECT_ATTEMPTS})`),setTimeout((()=>{!this.isListening&&this.isInitialized&&this.start().catch((e=>{console.error("Recovery attempt failed:",e)}))}),e),this.logEvent("recovery_attempted",{attempt:this.reconnectAttempts,delay:e})}handleError(e,t){const n={error:e,message:t,timestamp:Date.now(),recoverable:this.isRecoverableError(e)};this.callbacks.onError&&this.callbacks.onError(n),this.logEvent("speech_to_text_error",{type:e,message:t})}logEvent(e,t){this.performanceAnalyzer&&this.performanceAnalyzer.logEvent(e,{sessionId:this.currentSessionId,timestamp:Date.now(),...t})}async startFallbackService(){throw new Error("Fallback STT service not implemented")}stopFallbackService(){}dispose(){this.isListening&&this.stop(),this.recognition=null,this.isInitialized=!1,this.clearTranscripts(),this.logEvent("speech_to_text_disposed")}}class j{containerId;container=null;contentContainer=null;statusIndicator=null;statusText=null;transcriptCount=null;confidenceAvg=null;transcripts=[];maxTranscripts=50;isAutoScroll=!0;constructor(e){this.containerId=e,this.initialize()}initialize(){this.container=document.getElementById(this.containerId),this.container?(this.createUI(),this.setupEventListeners()):console.warn(`TranscriptionView: Container ${this.containerId} not found`)}createUI(){this.container&&(this.container.innerHTML=`\n      <div class="transcription-header">\n        <div class="transcription-status">\n          <span class="status-indicator status-ready"></span>\n          <span class="status-text">Ready</span>\n        </div>\n        <div class="transcription-controls">\n          <button class="toggle-scroll" title="Toggle auto-scroll">📜</button>\n          <button class="clear-transcripts" title="Clear transcripts">🗑️</button>\n        </div>\n      </div>\n      <div class="transcription-content" id="${this.containerId}-content">\n        <div class="no-transcripts">No transcripts yet. Start speaking to see real-time transcription.</div>\n      </div>\n      <div class="transcription-footer">\n        <span class="transcript-count">0 transcripts</span>\n        <span class="confidence-avg">Avg: 0%</span>\n      </div>\n    `,this.contentContainer=this.container.querySelector(".transcription-content"),this.statusIndicator=this.container.querySelector(".status-indicator"),this.statusText=this.container.querySelector(".status-text"),this.transcriptCount=this.container.querySelector(".transcript-count"),this.confidenceAvg=this.container.querySelector(".confidence-avg"))}setupEventListeners(){if(!this.container)return;const e=this.container.querySelector(".toggle-scroll"),t=this.container.querySelector(".clear-transcripts");e&&e.addEventListener("click",(()=>{this.isAutoScroll=!this.isAutoScroll,e.style.opacity=this.isAutoScroll?"1":"0.5"})),t&&t.addEventListener("click",(()=>{this.clearTranscripts()}))}addTranscript(e){if(!e||!e.text)return;const t={id:`transcript_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,text:e.text,confidence:e.confidence||0,timestamp:new Date(e.timestamp||Date.now()),speaker:e.speaker||"Unknown",isInterim:!e.isFinal};this.transcripts.push(t),this.transcripts.length>this.maxTranscripts&&this.transcripts.shift(),this.renderTranscripts(),this.updateStats(),this.isAutoScroll&&this.scrollToBottom()}renderTranscripts(){if(!this.contentContainer)return;if(0===this.transcripts.length)return void(this.contentContainer.innerHTML='\n        <div class="no-transcripts">No transcripts yet. Start speaking to see real-time transcription.</div>\n      ');const e=this.transcripts.map((e=>this.createTranscriptHTML(e))).join("");this.contentContainer.innerHTML=e}createTranscriptHTML(e){const t=e.timestamp.toLocaleTimeString(),n=Math.round(100*e.confidence),s=this.getConfidenceClass(e.confidence);return`\n      <div class="transcript-item ${e.isInterim?"transcript-interim":"transcript-final"}" data-id="${e.id}">\n        <div class="transcript-meta">\n          <span class="transcript-time">${t}</span>\n          <span class="transcript-speaker">${e.speaker}</span>\n          <span class="transcript-confidence ${s}">${n}%</span>\n        </div>\n        <div class="transcript-text">${this.escapeHtml(e.text)}</div>\n      </div>\n    `}getConfidenceClass(e){return e>=.8?"confidence-high":e>=.6?"confidence-medium":"confidence-low"}updateStats(){if(this.transcriptCount&&this.confidenceAvg)if(this.transcriptCount.textContent=`${this.transcripts.length} transcripts`,this.transcripts.length>0){const e=this.transcripts.reduce(((e,t)=>e+t.confidence),0)/this.transcripts.length;this.confidenceAvg.textContent=`Avg: ${Math.round(100*e)}%`}else this.confidenceAvg.textContent="Avg: 0%"}setStatus(e,t){this.statusIndicator&&this.statusText&&(this.statusIndicator.className=`status-indicator status-${e}`,this.statusText.textContent=t)}clearTranscripts(){this.transcripts=[],this.renderTranscripts(),this.updateStats(),this.setStatus("ready","Cleared")}scrollToBottom(){this.contentContainer&&(this.contentContainer.scrollTop=this.contentContainer.scrollHeight)}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}getTranscripts(){return[...this.transcripts]}exportTranscripts(){const e={transcripts:this.transcripts,exportedAt:(new Date).toISOString(),totalCount:this.transcripts.length},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download=`transcripts-${Date.now()}.json`,s.click(),URL.revokeObjectURL(n)}destroy(){this.container&&(this.container.innerHTML=""),this.transcripts=[]}}class H{containerId;container=null;contentContainer=null;suggestions=[];maxSuggestions=10;usedSuggestions=new Set;constructor(e){this.containerId=e,this.initialize()}initialize(){this.container=document.getElementById(this.containerId),this.container?(this.createUI(),this.setupEventListeners()):console.warn(`SuggestionView: Container ${this.containerId} not found`)}createUI(){this.container&&(this.container.innerHTML=`\n      <div class="suggestions-header">\n        <div class="suggestions-status">\n          <span class="status-indicator status-ready"></span>\n          <span class="status-text">AI Suggestions</span>\n        </div>\n        <div class="suggestions-controls">\n          <button class="refresh-suggestions" title="Refresh suggestions">🔄</button>\n          <button class="clear-suggestions" title="Clear suggestions">🗑️</button>\n        </div>\n      </div>\n      <div class="suggestions-content" id="${this.containerId}-content">\n        <div class="no-suggestions">No suggestions yet.</div>\n      </div>\n      <div class="suggestions-footer">\n        <span class="suggestion-count">0 suggestions</span>\n        <span class="used-count">0 used</span>\n      </div>\n    `,this.contentContainer=this.container.querySelector(".suggestions-content"))}setupEventListeners(){if(!this.container)return;const e=this.container.querySelector(".refresh-suggestions"),t=this.container.querySelector(".clear-suggestions");e&&e.addEventListener("click",(()=>{this.refreshSuggestions()})),t&&t.addEventListener("click",(()=>{this.clearSuggestions()}))}displaySuggestions(e){Array.isArray(e)&&(this.suggestions=e.map((e=>({id:e.id||`suggestion_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,content:e.content||e.text||"",confidence:e.confidence||.5,relevantDocuments:e.relevantDocuments||[],timestamp:new Date,used:!1}))),this.renderSuggestions(),this.updateStats())}renderSuggestions(){if(!this.contentContainer)return;if(0===this.suggestions.length)return void(this.contentContainer.innerHTML='\n        <div class="no-suggestions">No suggestions available. Start speaking to get AI assistance.</div>\n      ');const e=this.suggestions.map((e=>this.createSuggestionHTML(e))).join("");this.contentContainer.innerHTML=e,this.setupSuggestionListeners()}createSuggestionHTML(e){const t=Math.round(100*e.confidence),n=this.getConfidenceClass(e.confidence),s=e.timestamp.toLocaleTimeString();return`\n      <div class="suggestion-item ${e.used?"suggestion-used":""}" data-id="${e.id}">\n        <div class="suggestion-header">\n          <span class="suggestion-confidence ${n}">${t}%</span>\n          <span class="suggestion-time">${s}</span>\n          <div class="suggestion-actions">\n            <button class="use-suggestion" title="Use this suggestion" data-id="${e.id}">✓</button>\n            <button class="copy-suggestion" title="Copy to clipboard" data-id="${e.id}">📋</button>\n          </div>\n        </div>\n        <div class="suggestion-content">${this.escapeHtml(e.content)}</div>\n        ${e.relevantDocuments.length>0?`\n          <div class="suggestion-documents">\n            <span class="documents-label">Based on:</span>\n            ${e.relevantDocuments.map((e=>`<span class="document-tag">${e}</span>`)).join("")}\n          </div>\n        `:""}\n      </div>\n    `}setupSuggestionListeners(){this.contentContainer&&(this.contentContainer.querySelectorAll(".use-suggestion").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.getAttribute("data-id");t&&this.useSuggestion(t)}))})),this.contentContainer.querySelectorAll(".copy-suggestion").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.getAttribute("data-id");t&&this.copySuggestion(t)}))})))}getConfidenceClass(e){return e>=.8?"confidence-high":e>=.6?"confidence-medium":"confidence-low"}useSuggestion(e){const t=this.suggestions.find((t=>t.id===e));t&&(t.used=!0,this.usedSuggestions.add(e),this.renderSuggestions(),this.updateStats(),this.container?.dispatchEvent(new CustomEvent("suggestionUsed",{detail:{suggestion:t}})))}copySuggestion(e){const t=this.suggestions.find((t=>t.id===e));t&&navigator.clipboard.writeText(t.content).then((()=>{const t=this.container?.querySelector(`[data-id="${e}"].copy-suggestion`);if(t){const e=t.textContent;t.textContent="✓",setTimeout((()=>{t.textContent=e}),1e3)}})).catch((e=>{console.error("Failed to copy suggestion:",e)}))}updateStats(){const e=this.container?.querySelector(".suggestion-count"),t=this.container?.querySelector(".used-count");if(e&&(e.textContent=`${this.suggestions.length} suggestions`),t){const e=this.suggestions.filter((e=>e.used)).length;t.textContent=`${e} used`}}refreshSuggestions(){this.container?.dispatchEvent(new CustomEvent("refreshRequested"))}clearSuggestions(){this.suggestions=[],this.usedSuggestions.clear(),this.renderSuggestions(),this.updateStats()}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}getSuggestions(){return[...this.suggestions]}getUsedSuggestions(){return this.suggestions.filter((e=>e.used))}destroy(){this.container&&(this.container.innerHTML=""),this.suggestions=[],this.usedSuggestions.clear()}}class B{async updateContext(e){console.log("Context updated:",e)}async getRelevantContext(e){return console.log("Getting context for:",e),{}}}class V{async captureScreenshot(){return console.log("Capturing screenshot..."),""}async analyzeVisual(e){return console.log("Analyzing visual:",e),{}}}class K{addMessage(e,t){console.log(`${t}: ${e}`)}async sendMessage(e){console.log("Sending message:",e)}}const G=new class{speechToText;llmOrchestrator;documentManager;contextManager;visualAnalysis;suggestionView;transcriptionView;chatInterface;currentState;currentSession=null;settings;uiContainer=null;transcriptBuffer=[];lastSuggestionTime=0;suggestionTimer=null;screenshotTimer=null;constructor(){console.log("LiveMeetingOrchestrator initialized"),this.initializeState(),this.initializeServices(),this.setupEventListeners()}initializeState(){this.currentState={isActive:!1,platform:null,callType:"client_meeting",tone:"professional",transcriptionActive:!1,aiSuggestionsActive:!1,screenshotAnalysisActive:!1,sessionStartTime:0,lastActivityTime:0},this.settings={autoTranscribe:!0,autoSuggest:!0,suggestionDelay:3e3,screenshotInterval:3e4,confidenceThreshold:.7,maxSuggestions:3}}async initializeServices(){this.speechToText=new F({continuous:!0,interimResults:!0,language:"en-US",confidenceThreshold:this.settings.confidenceThreshold},{onResult:this.handleTranscriptResult.bind(this),onError:this.handleTranscriptError.bind(this),onEnd:this.handleTranscriptEnd.bind(this)}),this.llmOrchestrator=new N,this.documentManager=new I,this.contextManager=new B,await this.speechToText.initialize()}setupEventListeners(){chrome.runtime.onMessage.addListener(((e,t,n)=>{this.handleMessage(e,t,n)})),window.addEventListener("beforeunload",(()=>{this.stopMeeting()}))}async startMeeting(e,t="client_meeting",n="professional"){try{console.log(`Starting live meeting assistance for ${e}`),this.currentState={...this.currentState,isActive:!0,platform:e,callType:t,tone:n,sessionStartTime:Date.now(),lastActivityTime:Date.now()},this.currentSession={sessionId:this.generateSessionId(),platform:e,startTime:Date.now(),transcripts:[],suggestions:[],screenshots:[],context:{callType:t,tone:n,platform:e,sessionId:this.generateSessionId(),startTime:new Date,participants:[],documents:[],currentObjectives:[]}},await this.initializeUI(),this.settings.autoTranscribe&&await this.startTranscription(),this.settings.autoSuggest&&this.startAutoSuggestions(),this.startScreenshotAnalysis(),console.log("Live meeting assistance started successfully")}catch(e){throw console.error("Failed to start live meeting assistance:",e),e}}async stopMeeting(){console.log("Stopping live meeting assistance"),this.stopTranscription(),this.stopAutoSuggestions(),this.stopScreenshotAnalysis(),this.currentSession&&await this.saveSession(),this.currentState.isActive=!1,this.currentSession=null,this.cleanupUI(),console.log("Live meeting assistance stopped")}async startTranscription(){if(this.currentState.transcriptionActive)console.warn("Transcription already active");else try{await this.speechToText.start(),this.currentState.transcriptionActive=!0,this.updateUIStatus("Transcription active","success"),console.log("Transcription started")}catch(e){console.error("Failed to start transcription:",e),this.updateUIStatus("Transcription failed to start","error")}}stopTranscription(){this.currentState.transcriptionActive&&(this.speechToText.stop(),this.currentState.transcriptionActive=!1,this.updateUIStatus("Transcription stopped","info"),console.log("Transcription stopped"))}handleTranscriptResult(e){this.transcriptBuffer.push(e.text),this.currentSession&&this.currentSession.transcripts.push(e),this.transcriptionView&&console.log("Would update transcription view with:",e.text),this.currentState.lastActivityTime=Date.now(),e.isFinal&&this.settings.autoSuggest&&this.scheduleAutoSuggestion(),console.log("Transcript:",e.text,"Final:",e.isFinal)}handleTranscriptError(e){console.error("Transcription error:",e),this.updateUIStatus(`Transcription error: ${e.message}`,"error")}handleTranscriptEnd(){console.log("Transcription ended, attempting restart..."),this.currentState.transcriptionActive&&setTimeout((()=>{this.startTranscription()}),1e3)}startAutoSuggestions(){this.currentState.aiSuggestionsActive=!0,console.log("Auto-suggestions enabled")}stopAutoSuggestions(){this.currentState.aiSuggestionsActive=!1,this.suggestionTimer&&(clearTimeout(this.suggestionTimer),this.suggestionTimer=null),console.log("Auto-suggestions disabled")}scheduleAutoSuggestion(){this.currentState.aiSuggestionsActive&&(this.suggestionTimer&&clearTimeout(this.suggestionTimer),this.suggestionTimer=setTimeout((()=>{this.generateSuggestions()}),this.settings.suggestionDelay))}async generateSuggestions(){if(this.currentSession&&this.currentState.aiSuggestionsActive)try{const e=this.transcriptBuffer.slice(-10).join(" ");if(e.trim().length<10)return;const t={sessionId:this.currentSession.sessionId,callType:this.currentState.callType,tone:this.currentState.tone,relevantDocuments:[],currentTopic:"general",conversationHistory:this.currentSession.transcripts.map((e=>e.text)),participants:this.currentSession.context.participants,meetingPhase:this.detectMeetingPhase(),participantContext:{lastUserInput:e,timeInMeeting:Date.now()-this.currentState.sessionStartTime}},n=await this.llmOrchestrator.generateSuggestions(t,this.currentState.callType,this.currentState.tone,this.settings.maxSuggestions);this.currentSession.suggestions.push(...n),this.suggestionView&&console.log("Would display suggestions:",n.length),console.log("Generated",n.length,"suggestions"),this.lastSuggestionTime=Date.now()}catch(e){console.error("Failed to generate suggestions:",e)}}startScreenshotAnalysis(){this.screenshotTimer||(this.currentState.screenshotAnalysisActive=!0,this.screenshotTimer=setInterval((()=>{this.captureAndAnalyzeScreen()}),this.settings.screenshotInterval),console.log("Screenshot analysis started"))}stopScreenshotAnalysis(){this.screenshotTimer&&(clearInterval(this.screenshotTimer),this.screenshotTimer=null),this.currentState.screenshotAnalysisActive=!1,console.log("Screenshot analysis stopped")}async captureAndAnalyzeScreen(){try{console.log("Capturing and analyzing screenshot..."),await this.visualAnalysis.captureScreenshot()}catch(e){console.error("Screenshot capture failed:",e)}}async initializeUI(){this.uiContainer=this.createUIContainer(),document.body.appendChild(this.uiContainer),this.transcriptionView=new j("candidai-transcription"),this.suggestionView=new H("candidai-suggestions"),this.visualAnalysis=new V,this.chatInterface=new K,console.log("UI initialized")}createUIContainer(){const e=document.createElement("div");return e.id="candidai-main-container",e.className="candidai-live-assistant",e.innerHTML=`\n      <div class="candidai-header">\n        <div class="candidai-logo">\n          <img src="${chrome.runtime.getURL("assets/icons/icon-48.png")}" alt="CandidAI" />\n          <span>CandidAI Live Assistant</span>\n        </div>\n        <div class="candidai-controls">\n          <button id="candidai-toggle-transcription" class="candidai-btn candidai-btn--sm">\n            🎤 Transcription\n          </button>\n          <button id="candidai-toggle-suggestions" class="candidai-btn candidai-btn--sm">\n            💡 Suggestions\n          </button>\n          <button id="candidai-capture-screen" class="candidai-btn candidai-btn--sm">\n            📸 Analyze Screen\n          </button>\n          <button id="candidai-close" class="candidai-btn candidai-btn--sm candidai-btn--danger">\n            ✕\n          </button>\n        </div>\n      </div>\n      \n      <div class="candidai-content">\n        <div class="candidai-panel candidai-panel--transcription">\n          <h3>Live Transcription</h3>\n          <div id="candidai-transcription"></div>\n        </div>\n        \n        <div class="candidai-panel candidai-panel--suggestions">\n          <h3>AI Suggestions</h3>\n          <div id="candidai-suggestions"></div>\n        </div>\n        \n        <div class="candidai-panel candidai-panel--analysis">\n          <h3>Visual Analysis</h3>\n          <div id="candidai-screenshot-preview"></div>\n          <div id="candidai-analysis-results"></div>\n        </div>\n        \n        <div class="candidai-panel candidai-panel--chat">\n          <h3>AI Chat</h3>\n          <div id="candidai-chat"></div>\n        </div>\n      </div>\n      \n      <div class="candidai-status">\n        <span id="candidai-status-text">Ready</span>\n        <div class="candidai-session-info">\n          Session: ${this.currentSession?.sessionId.slice(-8)||"N/A"}\n        </div>\n      </div>\n    `,this.setupUIEventListeners(e),e}setupUIEventListeners(e){e.querySelector("#candidai-toggle-transcription")?.addEventListener("click",(()=>{this.currentState.transcriptionActive?this.stopTranscription():this.startTranscription()})),e.querySelector("#candidai-toggle-suggestions")?.addEventListener("click",(()=>{this.currentState.aiSuggestionsActive?this.stopAutoSuggestions():this.startAutoSuggestions()})),e.querySelector("#candidai-capture-screen")?.addEventListener("click",(()=>{this.captureAndAnalyzeScreen()})),e.querySelector("#candidai-close")?.addEventListener("click",(()=>{this.stopMeeting()}))}updateUIStatus(e,t="info"){const n=document.querySelector("#candidai-status-text");n&&(n.textContent=e,n.className=`candidai-status-${t}`)}cleanupUI(){this.uiContainer&&(this.uiContainer.remove(),this.uiContainer=null)}async handleMessage(e,t,n){switch(e.command){case"PLATFORM_DETECTED":await this.handlePlatformDetected(e.payload),n({success:!0});break;case"VIDEO_CALL_STATE_CHANGED":await this.handleVideoCallStateChanged(e.payload),n({success:!0});break;case"START_MEETING_ASSISTANCE":await this.startMeeting(e.payload.platform,e.payload.callType,e.payload.tone),n({success:!0});break;case"STOP_MEETING_ASSISTANCE":await this.stopMeeting(),n({success:!0});break;default:n({success:!1,error:"Unknown command"})}}async handlePlatformDetected(e){console.log("Platform detected:",e.platform),e.isVideoCall&&!this.currentState.isActive&&await this.startMeeting(e.platform)}async handleVideoCallStateChanged(e){console.log("Video call state changed:",e.inCall),e.inCall&&!this.currentState.isActive?await this.startMeeting(e.platform):!e.inCall&&this.currentState.isActive&&await this.stopMeeting()}generateSessionId(){return Date.now().toString(36)+Math.random().toString(36).substr(2,9)}detectMeetingPhase(){const e=(Date.now()-this.currentState.sessionStartTime)/6e4;return e<5?"introduction":e<15?"technical_discussion":e<25?"behavioral_questions":"closing"}async saveSession(){if(this.currentSession)try{const e={...this.currentSession,endTime:Date.now(),duration:Date.now()-this.currentSession.startTime};await chrome.storage.local.set({[`session_${this.currentSession.sessionId}`]:e}),console.log("Session saved:",this.currentSession.sessionId)}catch(e){console.error("Failed to save session:",e)}}getState(){return{...this.currentState}}updateSettings(e){this.settings={...this.settings,...e},console.log("Settings updated:",this.settings)}async generateManualSuggestion(e){if(!this.currentSession)return[];const t={sessionId:this.currentSession.sessionId,callType:this.currentState.callType,tone:this.currentState.tone,relevantDocuments:[],currentTopic:"manual_query",conversationHistory:this.currentSession.transcripts.map((e=>e.text)),participants:this.currentSession.context.participants,meetingPhase:this.detectMeetingPhase(),participantContext:{lastUserInput:e,timeInMeeting:Date.now()-this.currentState.sessionStartTime}};return[...await this.llmOrchestrator.generateSuggestions(t,this.currentState.callType,this.currentState.tone,this.settings.maxSuggestions)]}};class J{constructor(){this.isInitialized=!1,this.currentPlatform=null,this.isInMeeting=!1,console.log("LiveMeetingIntegration initialized")}async initialize(){if(!this.isInitialized)try{this.currentPlatform=this.detectPlatform(),console.log("Platform detected:",this.currentPlatform),this.setupMeetingDetection(),this.setupMessageListeners(),this.isVideoCallActive()&&(console.log("Video call detected, starting live assistance"),await this.startLiveAssistance()),this.isInitialized=!0,console.log("Live meeting integration ready")}catch(e){console.error("Failed to initialize live meeting integration:",e)}}detectPlatform(){const e=window.location.hostname.toLowerCase(),t=window.location.href.toLowerCase();return e.includes("meet.google.com")||e.includes("hangouts.google.com")?"google_meet":e.includes("zoom.us")||t.includes("zoom")?"zoom":e.includes("teams.microsoft.com")||e.includes("teams.live.com")?"microsoft_teams":e.includes("linkedin.com")&&t.includes("events/")?"linkedin_events":e.includes("hirevue.com")?"hirevue":e.includes("webex.com")?"webex":e.includes("gotomeeting.com")?"gotomeeting":"unknown"}setupMeetingDetection(){new MutationObserver((e=>{const t=this.isInMeeting;this.isInMeeting=Boolean(this.isVideoCallActive()),this.isInMeeting!==t&&(console.log("Meeting state changed:",this.isInMeeting?"Started":"Ended"),this.isInMeeting?this.startLiveAssistance():this.stopLiveAssistance())})).observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","aria-label","title"]}),setInterval((()=>{const e=Boolean(this.isVideoCallActive());e!==this.isInMeeting&&(this.isInMeeting=e,console.log("Meeting state changed (periodic check):",this.isInMeeting?"Started":"Ended"),this.isInMeeting?this.startLiveAssistance():this.stopLiveAssistance())}),5e3)}isVideoCallActive(){switch(this.currentPlatform){case"google_meet":return document.querySelector("[data-call-id]")||document.querySelector('[jsname="HlFkCe"]')||document.querySelector("div[data-meeting-title]")||document.querySelector(".crqnQb")||window.location.pathname.includes("/meet/");case"zoom":return document.querySelector('[aria-label*="meeting"]')||document.querySelector("#webclient")||document.querySelector(".meeting-client-view")||document.querySelector('[data-testid="meeting-window"]');case"microsoft_teams":return document.querySelector('[data-tid="calling-screen"]')||document.querySelector('[data-tid="meeting-stage"]')||document.querySelector(".calling-screen")||document.querySelector("#teams-app-chrome")||window.location.pathname.includes("/call/");case"linkedin_events":return document.querySelector('[data-test-id="event-call-stage"]')||document.querySelector(".live-event-viewer")||window.location.pathname.includes("/events/");case"hirevue":return document.querySelector(".interview-container")||document.querySelector('[data-testid="interview-room"]')||document.querySelector(".hv-interview");default:return document.querySelector("video[autoplay]")||document.querySelector('[aria-label*="video"]')||document.querySelector('[aria-label*="call"]')||document.querySelector('[aria-label*="meeting"]')}}async startLiveAssistance(){if(G.getState().isActive)console.log("Live assistance already active");else try{console.log("Starting live meeting assistance for",this.currentPlatform),this.injectStyles(),await G.startMeeting(this.currentPlatform,"client_meeting","professional"),this.addToggleButton(),console.log("Live assistance started successfully")}catch(e){console.error("Failed to start live assistance:",e)}}async stopLiveAssistance(){if(G.getState().isActive)try{console.log("Stopping live meeting assistance"),await G.stopMeeting(),this.removeToggleButton(),console.log("Live assistance stopped")}catch(e){console.error("Failed to stop live assistance:",e)}else console.log("Live assistance not active")}injectStyles(){if(document.getElementById("candidai-live-styles"))return;const e=document.createElement("link");e.id="candidai-live-styles",e.rel="stylesheet",e.href=chrome.runtime.getURL("css/live-assistant.css"),document.head.appendChild(e)}addToggleButton(){if(document.getElementById("candidai-toggle-btn"))return;const e=document.createElement("button");e.id="candidai-toggle-btn",e.className="candidai-toggle-button",e.innerHTML="🤖 CandidAI",e.title="Toggle CandidAI Live Assistant",e.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 440px;\n      z-index: 9999;\n      padding: 8px 12px;\n      background: linear-gradient(135deg, #ff6b6b, #ee5a24);\n      color: white;\n      border: none;\n      border-radius: 20px;\n      font-size: 12px;\n      font-weight: 600;\n      cursor: pointer;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n      transition: all 0.2s ease;\n    ",e.addEventListener("click",(()=>{const e=document.getElementById("candidai-main-container");e&&(e.style.display="none"===e.style.display?"block":"none")})),document.body.appendChild(e)}removeToggleButton(){const e=document.getElementById("candidai-toggle-btn");e&&e.remove()}setupMessageListeners(){chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.command){case"START_LIVE_ASSISTANCE":return this.startLiveAssistance().then((()=>{n({success:!0})})).catch((e=>{n({success:!1,error:e.message})})),!0;case"STOP_LIVE_ASSISTANCE":return this.stopLiveAssistance().then((()=>{n({success:!0})})).catch((e=>{n({success:!1,error:e.message})})),!0;case"GET_MEETING_STATE":n({success:!0,data:{platform:this.currentPlatform,isInMeeting:this.isInMeeting,isAssistanceActive:G.getState().isActive}});break;default:n({success:!1,error:"Unknown command"})}}))}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{(new J).initialize()})):(new J).initialize(),window.candidaiLiveMeeting=new J;const Q=new class{adapters=new Map([["meet.google.com",e],["zoom.us",t],["teams.microsoft.com",n],["linkedin.com",s],["hirevue.com",i]]);currentAdapter=null;mutationObserver=null;detectionState={platform:null,isVideoCall:!1,metadata:{}};constructor(){this.initialize().catch((e=>{console.error("PlatformDetector initialization failed:",e)}))}async initialize(){console.log("CandidAI Content Script initializing...");try{const e=this.detectPlatform();e&&(console.log(`Detected platform: ${e}`),await this.initializePlatformAdapter(e)),this.observeDOMChanges(),this.initializeMessageListener(),this.monitorURLChanges()}catch(e){console.error("PlatformDetector initialization error:",e)}}detectPlatform(){const e=window.location.hostname;for(const[t]of this.adapters)if(e.includes(t))return t;return null}async initializePlatformAdapter(e){const t=this.adapters.get(e);if(t)try{this.currentAdapter&&this.currentAdapter.cleanup(),this.currentAdapter=new t,await this.currentAdapter.initialize(),this.detectionState.isVideoCall=await this.currentAdapter.isInVideoCall(),this.detectionState.platform=e,this.detectionState.metadata=await this.currentAdapter.extractMetadata(),await this.notifyPlatformDetected(),this.currentAdapter.onVideoCallStateChange((e=>{this.handleVideoCallStateChange(e).catch((e=>{console.error("Error handling video call state change:",e)}))})),console.log("Platform adapter initialized successfully:",e)}catch(e){console.error("Failed to initialize platform adapter:",e),this.currentAdapter=null}else console.error(`No adapter found for platform: ${e}`)}observeDOMChanges(){this.mutationObserver&&this.mutationObserver.disconnect(),this.mutationObserver=new MutationObserver((e=>{try{if(!this.currentAdapter&&this.detectPlatform())return void this.initialize().catch((e=>{console.error("Re-initialization failed:",e)}));this.currentAdapter?.handleMutations&&this.currentAdapter.handleMutations(e)}catch(e){console.error("Error in mutation observer:",e)}})),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","data-meeting-id","data-call-id"]})}monitorURLChanges(){let e=location.href;const t=history.pushState.bind(history),n=history.replaceState.bind(history);history.pushState=function(e,n,s){t(e,n,s),window.dispatchEvent(new Event("urlchange"))},history.replaceState=function(e,t,s){n(e,t,s),window.dispatchEvent(new Event("urlchange"))};const s=()=>{location.href!==e&&(e=location.href,this.handleURLChange().catch((e=>{console.error("Error handling URL change:",e)})))};window.addEventListener("urlchange",s),window.addEventListener("popstate",s)}async handleURLChange(){try{const e=this.detectPlatform();e!==this.detectionState.platform&&(console.log("Platform changed, reinitializing..."),this.currentAdapter&&(this.currentAdapter.cleanup(),this.currentAdapter=null),e?await this.initializePlatformAdapter(e):this.detectionState={platform:null,isVideoCall:!1,metadata:{}})}catch(e){console.error("Error handling URL change:",e)}}initializeMessageListener(){chrome.runtime.onMessage.addListener(((e,t,n)=>(this.handleMessage(e,t,n).catch((e=>{console.error("Error handling message:",e),n({success:!1,error:e instanceof Error?e.message:"Unknown error"})})),!0)))}async handleMessage(e,t,n){const{command:s,payload:i}=e;try{switch(s){case"get_platform_status":n({success:!0,data:{platform:this.detectionState.platform,isVideoCall:this.detectionState.isVideoCall,metadata:this.detectionState.metadata}});break;case"extract_page_context":n({success:!0,data:await this.extractPageContext()});break;case"inject_ui":await this.injectUI(i?.config||{}),n({success:!0});break;default:console.warn("Unknown command received in content script:",s),n({success:!1,error:"Unknown command",details:`Command not recognized: ${s}`})}}catch(e){const t=e instanceof Error?e.message:"Unknown error";console.error(`Error handling command ${s}:`,e),n({success:!1,error:t})}}async notifyPlatformDetected(){try{await chrome.runtime.sendMessage({command:"platform_detected",payload:{platform:this.detectionState.platform,isVideoCall:this.detectionState.isVideoCall,metadata:this.detectionState.metadata,url:window.location.href,timestamp:Date.now()}})}catch(e){console.error("Failed to notify platform detection:",e)}}async handleVideoCallStateChange(e){try{this.detectionState.isVideoCall=e,await chrome.runtime.sendMessage({command:"video_call_state_changed",payload:{inCall:e,platform:this.detectionState.platform,metadata:this.detectionState.metadata,timestamp:Date.now()}}),console.log("Video call state changed: "+(e?"started":"ended"))}catch(e){console.error("Failed to notify video call state change:",e)}}async extractPageContext(){try{const e={url:window.location.href,title:document.title,platform:this.detectionState.platform,timestamp:Date.now()};if(this.currentAdapter){const t=await this.currentAdapter.extractMetadata();Object.assign(e,t)}return e}catch(e){return console.error("Failed to extract page context:",e),{url:window.location.href,title:document.title,error:e instanceof Error?e.message:"Unknown error"}}}async injectUI(e){try{console.log("Injecting UI with config:",e)}catch(e){throw console.error("Failed to inject UI:",e),e}}cleanup(){try{this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null),this.currentAdapter&&(this.currentAdapter.cleanup(),this.currentAdapter=null),console.log("PlatformDetector cleanup completed")}catch(e){console.error("Error during cleanup:",e)}}};window.addEventListener("beforeunload",(()=>{Q.cleanup()}))})();